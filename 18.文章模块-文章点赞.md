# 1 æ–‡ç« ç‚¹èµ

æ–‡ç« ç‚¹èµçš„ä¸šåŠ¡éœ€æ±‚å¦‚ä¸‹ï¼š

1. **ç‚¹èµè¡Œä¸º**
   - ç‚¹èµæ“ä½œåˆ†ä¸ºä¸¤ç§ï¼š**ç‚¹èµ**å’Œ**å–æ¶ˆç‚¹èµ**ã€‚
   - åŒä¸€ç”¨æˆ·å¯¹åŒä¸€ç¯‡æ–‡ç« åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œè‹¥é‡å¤æ“ä½œåˆ™è§†ä¸ºå–æ¶ˆç‚¹èµã€‚
2. **æ“ä½œé™åˆ¶**
   - ç‚¹èµåŠŸèƒ½ä»…é™å·²ç™»å½•ç”¨æˆ·ä½¿ç”¨ï¼Œæœªç™»å½•ç”¨æˆ·æ— æ³•æ‰§è¡Œç‚¹èµæ“ä½œã€‚
3. **ä¸šåŠ¡é€»è¾‘**
   - å¦‚æœå½“å‰ç”¨æˆ·å°šæœªå¯¹æ–‡ç« ç‚¹èµï¼Œæ­¤æ¬¡æ“ä½œè§†ä¸ºç‚¹èµè¡Œä¸ºï¼Œæ–‡ç« çš„ç‚¹èµé‡éšä¹‹å¢åŠ ã€‚
   - å¦‚æœå½“å‰ç”¨æˆ·å·²å¯¹æ–‡ç« ç‚¹èµï¼Œæ­¤æ¬¡æ“ä½œè§†ä¸ºå–æ¶ˆç‚¹èµè¡Œä¸ºï¼Œæ–‡ç« çš„ç‚¹èµé‡éšä¹‹å‡å°‘ã€‚
4. **ç‚¹èµè®°å½•ç®¡ç†**
   - ç‚¹èµæ“ä½œçš„è®°å½•ä¿å­˜åœ¨ç‚¹èµè¡¨ä¸­ï¼Œé€šè¿‡æŸ¥è¯¢ç‚¹èµè¡¨å¯åˆ¤æ–­æœ¬æ¬¡è¯·æ±‚æ˜¯æ‰§è¡Œç‚¹èµè¿˜æ˜¯å–æ¶ˆç‚¹èµæ“ä½œã€‚
5. **æ–‡ç« ç‚¹èµé‡çš„æ›´æ–°**
   - ç‚¹èµè¡Œä¸ºä¼šç›´æ¥å½±å“æ–‡ç« çš„ç‚¹èµé‡ï¼šå¢åŠ ç‚¹èµè®°å½•æ—¶ï¼Œç‚¹èµé‡+1ï¼›åˆ é™¤ç‚¹èµè®°å½•æ—¶ï¼Œç‚¹èµé‡-1ã€‚
6. **æ¶ˆæ¯è®°å½•**
   - ç‚¹èµå±äºæ¶ˆæ¯ç±»å‹ä¸­çš„ç¬¬3ç§ç±»å‹ï¼šâ€œæ–‡ç« ç‚¹èµâ€ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯æé†’ä½œè€…æŸäººç‚¹èµäº†å…¶æ–‡ç« ã€‚
   - ä»…åœ¨ç‚¹èµä»–äººæ–‡ç« æ—¶æ‰ä¼šç”Ÿæˆæ¶ˆæ¯è®°å½•ï¼›å–æ¶ˆç‚¹èµæˆ–ç‚¹èµè‡ªå·±çš„æ–‡ç« ä¸ä¼šè§¦å‘æ¶ˆæ¯è®°å½•ã€‚

---

## 1.1 ğŸŒæ–‡ç« ç‚¹èµæ¥å£

åœ°å€ï¼š

```
http://localhost:8091/web/articles/like/{articlesId}
```

è¯·æ±‚æ–¹å¼ï¼š

`GET`

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å    | ç±»å‹     | å¿…å¡«é¡¹ | è¯´æ˜   |
| --------- | -------- | ------ | ------ |
| articleId | `string` | `true` | æ–‡ç« id |

å“åº”ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

---

## 1.2 æ¥å£å®ç°

ç‚¹èµå±äºç™»å½•åæ“ä½œï¼Œæ˜¯ç™»å½•æ¥å£ï¼Œéœ€è¦å—`@AccessControl`æ§åˆ¶ï¼Œå…·ä½“å®ç°çœ‹[20.éç™»å½•è¯·æ±‚æ‹¦æˆª.md](20.éç™»å½•è¯·æ±‚æ‹¦æˆª.md)ã€‚

ç³»ç»Ÿé€šè¿‡æŸ¥è¯¢ç‚¹èµè®°å½•æ¥åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯ç‚¹èµè¿˜æ˜¯å–æ¶ˆç‚¹èµï¼šè‹¥æ— è®°å½•åˆ™ä¸ºç‚¹èµæ“ä½œï¼Œè‹¥å·²æœ‰è®°å½•åˆ™ä¸ºå–æ¶ˆç‚¹èµã€‚ç‚¹èµæ“ä½œä¼šå‘ç‚¹èµè®°å½•è¡¨ä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼Œè€Œå–æ¶ˆç‚¹èµåˆ™ä¼šåˆ é™¤ç›¸åº”è®°å½•ã€‚ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œå°†é‡æ–°è§¦å‘ç‚¹èµæˆ–å–æ¶ˆæ“ä½œï¼Œå½¢æˆæ’å…¥ä¸åˆ é™¤çš„å¾ªç¯ã€‚å¯¹åº”çš„æŸ¥è¯¢ SQL å¦‚ä¸‹ï¼š

```xml
<!-- é€šè¿‡ç›®æ ‡idã€ç‚¹èµäººã€ç‚¹èµç±»å‹æŸ¥è¯¢ -->
<select id="selectByTargetIdAndLikerIdAndLikeType" resultType="com.ling.entity.po.LikeRecode">
    select <include refid="commonField"/> from like_recode
    where target_id = #{targetId} and
    liker_id = #{likerId} and
    like_type = #{likeType}
</select>
```

åœ¨ç‚¹èµè®°å½•å˜æ›´çš„åŒæ—¶ï¼Œè¿˜éœ€æ›´æ–°å…³è”æ–‡ç« çš„ç‚¹èµé‡ã€‚ç‚¹èµæ“ä½œä¼šå¢åŠ ç‚¹èµé‡ï¼Œå–æ¶ˆç‚¹èµåˆ™ä¼šå‡å°‘ç‚¹èµé‡ã€‚ä»¥ä¸‹æ˜¯ç”¨äºæ›´æ–°æ–‡ç« ç‚¹èµé‡çš„ SQLï¼š

```xml
<!-- æ›´æ–°æ–‡ç« ç‚¹èµé‡ -->
<update id="updateLikeCount">
    update article
    set like_count = like_count + #{likeCount}
    where article_id = #{articleId}
</update>
```

åŒ[17.æ–‡ç« æ¨¡å—-æŸ¥è¯¢æ–‡ç« è¯¦æƒ….md#1.1 a = a + valueçº¿ç¨‹å®‰å…¨é—®é¢˜](17.æ–‡ç« æ¨¡å—-æŸ¥è¯¢æ–‡ç« è¯¦æƒ….md)ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

---

### 1.2.1 é€šç”¨å¤„ç†è®¾è®¡

ä¸ºäº†å®ç°ç‚¹èµåŠŸèƒ½çš„é€šç”¨åŒ–å¤„ç†ï¼Œå¯ä»¥è®¾è®¡ä¸€ä¸ªæ¥å£ä»¥é€‚é…æ–‡ç« å’Œè¯„è®ºç‚¹èµçš„ä¸åŒåœºæ™¯ã€‚æ— è®ºæ˜¯é’ˆå¯¹æ–‡ç« è¿˜æ˜¯è¯„è®ºï¼Œæ ¸å¿ƒé€»è¾‘å‡åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š

1. å¢åŠ æˆ–åˆ é™¤ç‚¹èµè®°å½•ï¼›
2. æ›´æ–°ç›®æ ‡å¯¹è±¡çš„ç‚¹èµé‡ã€‚

ä¸¤è€…çš„ä¸»è¦å…±æ€§åœ¨äºå¯¹ç‚¹èµè®°å½•çš„å¢åˆ æ“ä½œï¼Œå·®å¼‚åœ¨äºå½±å“çš„ç›®æ ‡å¯¹è±¡ï¼šæ–‡ç« ç‚¹èµä¼šæ›´æ–°æ–‡ç« çš„ç‚¹èµé‡ï¼Œè€Œè¯„è®ºç‚¹èµåˆ™æ›´æ–°è¯„è®ºçš„ç‚¹èµé‡ã€‚

ä¸ºå…¼é¡¾é€šç”¨æ€§ä¸çµæ´»æ€§ï¼Œå¯å¼•å…¥å‡½æ•°å¼æ¥å£ï¼Œé€šè¿‡å‚æ•°ä¼ é€’å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¾‹å¦‚æ˜¯å¤„ç†æ–‡ç« ç‚¹èµé‡è¿˜æ˜¯è¯„è®ºç‚¹èµé‡ã€‚

æ­¤å¤–ï¼Œç‚¹èµæ“ä½œå¯èƒ½éœ€è¦è®°å½•æ¶ˆæ¯ï¼Œä»…å½“ç‚¹èµæ¶‰åŠä»–äººæ–‡ç« æˆ–è¯„è®ºæ—¶è§¦å‘æ¶ˆæ¯è®°å½•ã€‚å› æ­¤ï¼Œé€šç”¨æ–¹æ³•å¯è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨äºæ ‡è¯†æ˜¯å¦éœ€è¦ç”Ÿæˆæ¶ˆæ¯é€šçŸ¥ã€‚ä»¥ä¸‹æ˜¯æ¥å£å®šä¹‰ç¤ºä¾‹ï¼š

```java
/**
     * å¤„ç†æ–‡ç« ç‚¹èµä¸šåŠ¡ï¼šç‚¹èµè®°å½•å˜æ›´&ç›®æ ‡ç‚¹èµé‡å˜æ›´
     *
     * @param targetId
     * @param authorId
     * @param likerId
     * @param likeType
     * @param changeLikeCount
     * @return
     */
    boolean processLike(String targetId, String authorId, String likerId, Integer likeType,
                        Consumer<Integer> changeLikeCount);
```

æ¥å£å®ç°å¦‚ä¸‹ï¼š

```java
/**
     * å¤„ç†æ–‡ç« ç‚¹èµä¸šåŠ¡ï¼šç‚¹èµè®°å½•å˜æ›´&ç›®æ ‡ç‚¹èµé‡å˜æ›´
     *
     * @param targetId
     * @param authorId
     * @param likerId
     * @param likeType
     * @param changeLikeCount
     * @return
     */
    @Transactional(rollbackFor = Exception.class)
    public boolean processLike(String targetId, String authorId, String likerId, Integer likeType,
                               Consumer<Integer> changeLikeCount) {
        LikeRecode likeRecode = findByTargetIdAndLikerIdAndLikeType(targetId, likerId, likeType);
        boolean notLike = Objects.isNull(likeRecode);
        int likeCount = notLike ? Constant.NUM_1 : Constant.NUM_NEG_1;     // ç‚¹èµå˜æ›´é‡
        if (notLike) {
            LikeRecode lr = new LikeRecode();
            lr.setTargetId(targetId);
            lr.setTargetAuthorId(authorId);
            lr.setLikerId(likerId);
            lr.setLikeType(likeType);
            add(lr);    // æ²¡æœ‰ç‚¹èµè®°å½•å°±å¢åŠ 
        } else {
            delete(Arrays.asList(likeRecode.getLikeRecodeId()));    // æœ‰ç‚¹èµè®°å½•å°±åˆ é™¤
        }
        changeLikeCount.accept(likeCount);    // å˜æ›´ç›®æ ‡ç‚¹èµé‡
        // ä¸æ˜¯ç»™è‡ªå·±çš„æ–‡ç« æˆ–è¯„è®ºç‚¹èµæ‰è®°å½•æ¶ˆæ¯ï¼Œè¿”å›å¯è¡Œæ ‡è¯†
        return notLike && !Objects.equals(authorId, likerId);
    }
```

æ–‡ç« ä¸šåŠ¡å±‚ä¸­è°ƒç”¨æ­¤æ–¹æ³•ï¼š

```java
/**
     * æ–‡ç« ç‚¹èµ
     *
     * @param userinfo
     * @param articleId
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void articleLike(UserInfoSessionDto userinfo, String articleId) {
        ArticleVo article = findById(articleId);
        if (Objects.isNull(article))
            throw new BusinessException(CommonMsg.ARTICLE_NOT_EXISTS);
        if (!Objects.equals(article.getStatus(), ArticleStatusEnum.AUDITED.getStatus()))
            throw new BusinessException(CommonMsg.ONLY_LIKE_AUDITED_ARTICLE);
        boolean canRecodeMsg = likeRecodeService.processLike(articleId, article.getUserId(), userinfo.getUserId(),
                LikeTypeEnum.ARTICLE.getType(),
                likeCount -> editLikeCount(articleId, likeCount));  // å…·ä½“è¡Œä¸ºï¼šå˜æ›´æ–‡ç« ç‚¹èµé‡
        // ä¸æ˜¯ç»™è‡ªå·±çš„æ–‡ç« æˆ–è¯„è®ºç‚¹èµæ‰è®°å½•æ¶ˆæ¯
        if (canRecodeMsg) {
            UserMessage userMessage = new UserMessage();
            userMessage.setReceivedUserId(article.getUserId());
            userMessage.setArticleId(article.getArticleId());
            userMessage.setArticleTitle(article.getTitle());
            userMessage.setSendUserId(userinfo.getUserId());
            userMessage.setSendNickName(userinfo.getNickName());
            userMessage.setMessageType(MessageTypeEnum.ARTICLE_LIKE.getType());
            userMessage.setMessageContent("æ–‡ç« ç‚¹èµ");
            userMessage.setStatus(MessageStatusEnum.NO_READ.getStatus());
            Date date = new Date();
            userMessage.setCreateTime(date);
            userMessage.setUpdateTime(date);
            userMessageService.add(userMessage);
        }
    }
```

æ§åˆ¶å™¨å±‚ï¼š

```java
/**
     * æ–‡ç« ç‚¹èµ
     *
     * @param session
     * @param articleId
     * @return
     */
    @GetMapping("/like/{articleId}")
    @AccessControl(loginRequired = true)
    public Result<Void> articleLike(HttpSession session, @PathVariable @Validation(max = 15) String articleId) {
        UserInfoSessionDto userInfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        articleService.articleLike(userInfo, articleId);
        return Result.success();
    }
```

