# åˆ›å»ºæ§åˆ¶å™¨

é¦–å…ˆï¼Œåˆ›å»º `ArticleController` ä½œä¸ºæ–‡ç« ç®¡ç†çš„æ§åˆ¶å™¨ï¼Œç»Ÿä¸€è¯·æ±‚å‰ç¼€ä¸º `/article`ã€‚

```java
/**
 * æ–‡ç« ç®¡ç†æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/article")
public class ArticleController {}
```



# ğŸŒè·å–æ–‡ç« åˆ—è¡¨æ¥å£

**æ¥å£æè¿°**

è¯¥æ¥å£æ”¯æŒå¤šæ¡ä»¶æŸ¥è¯¢æ–‡ç« åˆ—è¡¨ï¼ŒæŸ¥è¯¢æ¡ä»¶åŒ…æ‹¬ä½†ä¸é™äºï¼š

- æ ‡é¢˜
- ä½œè€…
- æ¿å—
- é™„ä»¶çŠ¶æ€
- çŠ¶æ€
- ç½®é¡¶çŠ¶æ€

**è¯·æ±‚åœ°å€**

```http
GET /admin/article
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å         | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜                            |
| -------------- | -------- | -------- | ------------------------------- |
| title          | `string` | `false`  | æ ‡é¢˜                            |
| author         | `string` | `false`  | ä½œè€…                            |
| pBoardId       | `int`    | `false`  | çˆ¶æ¿å—id                        |
| boardId        | `int`    | `false`  | å­æ¿å—id                        |
| attachmentType | `int`    | `false`  | 0: æ— é™„ä»¶, 1: æœ‰é™„ä»¶            |
| status         | `int`    | `false`  | 0: å·²åˆ é™¤, 1: å¾…å®¡æ ¸, 2: å·²å®¡æ ¸ |
| topType        | `string` | `false`  | 0: æœªç½®é¡¶, 1: ç½®é¡¶              |
| page           | `int`    | `true`   | é¡µç                             |
| pageSize       | `int`    | `true`   | æ¯é¡µæ¡ç›®                        |

**è¿”å›å®ä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "total": 2,
        "page": 1,
        "pageSize": 10,
        "pageTotal": 1,
        "rows": [
            {
                "articleId": "000981283431340",
                "boardId": 2,
                "boardName": "æ¸¸æˆå’¨è¯¢",
                "pBoardId": 1,
                "pBoardName": "æ¸¸æˆ",
                "avatar": null,
                "userId": "9876175182",
                "nickName": "user_189",
                "userIdAddress": "å››å·çœ",
                "title": "æ³¢å…°è ¢é©´æ–°ä½œã€Šå·«å¸ˆ4ã€‹æœ€æ–°å’¨è¯¢",
                "cover": null,
                "content": null,
                "mdContent": null,
                "editorType": 0,
                "summary": "xxxxxxx",
                "readCount": 20,
                "likeCount": 1,
                "topType": 0,
                "attachmentType": 1,
                "status": 2,
                "createTime": "2025-03-01 18:11:46",
                "commentCount": 0
            },
            ......
        ]
    }
}
```

## æ¥å£å®ç°

æ§åˆ¶å™¨ä¸­å®šä¹‰åŠ è½½æ–‡ç« åˆ—è¡¨çš„æ–¹æ³•`loadArticles()`ï¼Œæ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼Œç›´æ¥è°ƒç”¨æ–‡ç« æŸ¥è¯¢ä¸šåŠ¡å³å¯ã€‚

å› ä¸ºæ˜¯ç®¡ç†ç«¯ï¼Œæ‰€ä»¥å¯ä»¥æŸ¥çœ‹æ–‡ç« çš„æ‰€æœ‰çŠ¶æ€ã€‚

æ–‡ç« æ’åºé»˜è®¤ä¸ºå‘å¸ƒæ—¥æœŸå€’å™æ’åºã€‚

```java
/**
     * åŠ è½½æ–‡ç« åˆ—è¡¨æ¥å£
     *
     * @param page
     * @param pageSize
     * @param title
     * @param author
     * @param pBoardId
     * @param boardId
     * @param attachmentType
     * @param status
     * @param topType
     * @return
     */
    @GetMapping
    @AccessControl
    public Result<PageBean<ArticleVo>> loadArticles(@Validation(min = 1) Integer page, @Validation Integer pageSize,
                                                    @Validation(required = false, max = 50) String title,
                                                    @Validation(required = false, max = 50) String author,
                                                    @Validation(required = false) Integer pBoardId,
                                                    @Validation(required = false, min = 1) Integer boardId,
                                                    @Validation(required = false, max = 1) Integer attachmentType,
                                                    @Validation(required = false, max = 2) Integer status,
                                                    @Validation(required = false, max = 1) Integer topType) {
        ArticleQuery articleQuery = new ArticleQuery();
        articleQuery.setPage(page);
        articleQuery.setPageSize(pageSize);
        articleQuery.setTitle(title);
        articleQuery.setAuthor(author);
        articleQuery.setpBoardId(pBoardId);
        articleQuery.setBoardId(boardId);
        articleQuery.setAttachmentType(attachmentType);
        articleQuery.setStatus(status);
        articleQuery.setTopType(topType);
        articleQuery.setOrderBy("create_time desc");

        PageBean<ArticleVo> voByCondition = articleService.findVoByCondition(articleQuery);

        return Result.success(voByCondition);
    }
```



# ğŸŒåŠ è½½æ–‡ç« æ¥å£

**æ¥å£æè¿°**

è·å–æŒ‡å®š `articleId` çš„æ–‡ç« å†…å®¹ã€‚ä»…è¿”å›æ–‡ç« æ­£æ–‡ï¼Œä¸åŒ…å«é™„ä»¶åŠè¯„è®ºã€‚

**è¯·æ±‚åœ°å€**

```http
GET /admin/article/{aritcle-id}
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| --------- | -------- | -------- | ------ |
| articleId | `string` | `true`   | æ–‡ç« id |

**è¿”å›ç¤ºä¾‹**

```java
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "articleId": "173568352430026",
        "boardId": 7,
        "boardName": "ç¾é£Ÿ",
        "pBoardId": 0,
        "pBoardName": null,
        "avatar": null,
        "userId": "9619980088",
        "nickName": "ling",
        "userIdAddress": "å››å·çœ",
        "title": "ã€Šè¾£æ¤’å¦‚ä½•ä¿˜è·ä¸­å›½äººçš„èƒƒã€‹",
        "cover": "cover/2025-03/576cee8ac4ab44a889445eb68b6ebbe2.jpg",
        "content": "&lt;h1&gt;è¾£æ¤’ï¼Œè±ªèµ¤&lt;/h1&gt;\néƒ½ç»™æˆ‘å»åƒè¾£æ¤’",
        "mdContent": "#è¾£æ¤’ï¼Œè±ªèµ¤\néƒ½ç»™æˆ‘å»åƒè¾£æ¤’",
        "editorType": 1,
        "summary": "è¾£æ¤’çš„å¾æœå†å²",
        "readCount": 0,
        "likeCount": 0,
        "topType": 0,
        "attachmentType": 0,
        "status": 1,
        "createTime": "2025-03-03 13:40:35",
        "commentCount": 0
    }
}
```

## æ¥å£å®ç°

åœ¨æ§åˆ¶å™¨ä¸­å®šä¹‰æ–¹æ³•`loadArticle()`ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚æŸ¥è¯¢å…·ä½“æ–‡ç« ã€‚

>  åˆ é™¤çš„æ–‡ç« åº”æ‹’ç»è®¿é—®ã€‚

```java
/**
     * åŠ è½½æ–‡ç« æ¥å£
     *
     * @param articleId
     * @return
     */
    @GetMapping("/{article-id}")
    @AccessControl
    public Result<ArticleVo> loadArticle(@PathVariable("article-id") @Validation(max = 15) String articleId) {
        ArticleVo articleVo = articleService.findById(articleId);
        if (Objects.isNull(articleVo) || Objects.equals(articleVo.getStatus(), TargetStatusEnum.DELETED.getStatus()))
            throw new BusinessException(ResponseCodeEnum.CODE_404);

        return Result.success(articleVo);
    }
```



# ğŸŒåŠ è½½é™„ä»¶åˆ—è¡¨æ¥å£

**æ¥å£æè¿°**

æ­¤æ¥å£è¿”å›å…·ä½“æ–‡ç« çš„é™„ä»¶ã€‚

**è¯·æ±‚åœ°å€**

```http
GET /admin/article/{article-id}/attachment
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| --------- | -------- | -------- | ------ |
| articleId | `string` | `true`   | æ–‡ç« id |

**è¿”å›ç¤ºä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": [
        {
            "fileId": "56c1a4d6a14045a9904e93243a962fca",
            "filename": "584_2025030164232458 - å‰¯æœ¬.jpeg",
            "filesize": 19272,
            "filetype": 10,
            "downloadCount": 9,
            "downloadPoints": 2
        },
        {
            "fileId": "bd47629eeb8f4c6ea1d3caa6b5d32cfd",
            "filename": "584_2025030164232998 - å‰¯æœ¬.jpeg",
            "filesize": 14827,
            "filetype": 10,
            "downloadCount": 9,
            "downloadPoints": 2
        },
        ......
    ]
}
```

## æ¥å£å®ç°

æ§åˆ¶å™¨ä¸­å®šä¹‰æ–¹æ³•`loadAttachments()`ï¼Œæ ¡éªŒæ–‡ç« æ˜¯å¦å­˜åœ¨ï¼Œå†æŸ¥è¯¢é™„ä»¶åˆ—è¡¨å¹¶è¿”å›ï¼š

```java
/**
     * åŠ è½½é™„ä»¶åˆ—è¡¨æ¥å£
     *
     * @param articleId
     * @return
     */
    @GetMapping("/{article-id}/attachment")
    @AccessControl
    public Result<List<AttachmentVo>> loadAttachments(@PathVariable("article-id")
                                                      @Validation(max = 15) String articleId) {
        ArticleVo articleVo = articleService.findById(articleId);
        if (Objects.isNull(articleVo) || Objects.equals(articleVo.getStatus(), TargetStatusEnum.DELETED.getStatus()))
            throw new BusinessException(ResponseCodeEnum.CODE_404);

        List<Attachment> attachments = attachmentService.findByArticleId(articleId);

        List<AttachmentVo> attachmentVos = attachments.stream().map(e -> {
            AttachmentVo attachmentVo = new AttachmentVo();
            BeanUtils.copyProperties(e, attachmentVo);
            return attachmentVo;
        }).collect(Collectors.toList());

        return Result.success(attachmentVos);
    }
```



# ğŸŒä¸‹è½½é™„ä»¶æ¥å£

**æ¥å£æè¿°**

ä¸‹è½½å¯¹åº”çš„æ–‡ç« çš„é™„ä»¶ï¼Œå¤šé™„ä»¶æ—¶å‹ç¼©ä¸‹è½½ã€‚

**è¯·æ±‚åœ°å€**

```http
GET /admin/aritcle/{article-id}/attachment/download
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| --------- | -------- | -------- | ------ |
| articleId | `string` | `true`   | æ–‡ç« id |

**è¿”å›ç¤ºä¾‹**

```json
æ•°æ®æµ
```

## æ¥å£å®ç°

æ§åˆ¶å™¨ä¸­å®šä¹‰æ–¹æ³•`downloadAttachment()`ã€‚

```java
/**
     * ä¸‹è½½é™„ä»¶æ¥å£
     *
     * @param articleId
     * @return
     * @throws Exception
     */
    @GetMapping("/{article-id}/attachment/download")
    @AccessControl
    public ResponseEntity<byte[]> downloadAttachment(@PathVariable("article-id")
                                                     @Validation(max = 15) String articleId) throws Exception {
        ArticleVo articleVo = articleService.findById(articleId);
        if (Objects.isNull(articleVo) || Objects.equals(articleVo.getStatus(), TargetStatusEnum.DELETED.getStatus()))
            throw new BusinessException(ResponseCodeEnum.CODE_404);

        List<Attachment> attachments = attachmentService.findByArticleId(articleId);
        if (Objects.isNull(attachments) || attachments.isEmpty())
            throw new BusinessException(CommonMsg.FILE_NOT_FOUND);

        if (attachments.size() > 1) {
            return fileService.downloadAsZip(attachments);           // å‹ç¼©ä¸‹è½½
        } else {
            Attachment attachment = attachments.get(0);
            String contentType = MIMETypeEnum.getContentType(attachment.getFiletype());
            // å•æ–‡ä»¶ä¸‹è½½
            return fileService.downloadFile(attachment.getFilepath(), attachment.getFilename(), contentType);
        }
    }
```

è°ƒç”¨æ–‡ä»¶ä¸šåŠ¡å±‚çš„æ–¹æ³•ä¸‹è½½é™„ä»¶ï¼Œæˆ‘å°†å¤šæ–‡ä»¶å‹ç¼©ä¸‹è½½çš„æ–¹æ³•æå–æˆäº†ä¸€ä¸ªé€šç”¨æ–¹æ³•ï¼š

```java
@Override
public ResponseEntity<byte[]> downloadAsZip(List<? extends FileItem> fileItems) throws Exception {
    ByteArrayOutputStream aos = new ByteArrayOutputStream();
    try (ZipOutputStream zos = new ZipOutputStream(aos)) {
        for (FileItem fileItem : fileItems) {
            File file = new File(fileItem.getFilepath());
            if (!file.exists() || file.isDirectory())
                throw new BusinessException(CommonMsg.FILE_NOT_FOUND);
            try (InputStream is = new FileInputStream(file)) {
                ZipEntry zipEntry = new ZipEntry(fileItem.getFilename());
                zos.putNextEntry(zipEntry);
                IOUtils.copy(is, zos);
                zos.closeEntry();
            }
        }
    }

    // å‹ç¼©æµå…³é—­åï¼Œå†å†™å‡ºåˆ°å­—èŠ‚æ•°ç»„ï¼Œå¦åˆ™å‹ç¼©æ–‡ä»¶å†…å®¹ç¼ºå¤±
    byte[] byteArray = aos.toByteArray();
    HttpHeaders headers = new HttpHeaders();
    headers.add("Content-Type", MIMETypeEnum.ZIP.getContentType());
    String filename = URLEncoder.encode(String.format(Constant.ZIP_FILENAME, StrUtil.formatDate("_yyyyMMdd_hhmmss")));
    headers.add("Content-Disposition", "attachment; filename=" + filename);
    headers.add("Content-Length", String.valueOf(byteArray.length));

    return ResponseEntity.ok()
        .headers(headers)
        .body(byteArray);
}
```

å…¶ä¸­`FileItem`æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰åœ¨`FileService`å†…éƒ¨ï¼Œè¯¥æ¥å£æä¾›ä¸¤ä¸ªæ–¹æ³•`getFilepath()`å’Œ`getFilename()`ï¼š

```java
interface FileItem {
    String getFilepath();	// è·å–æ–‡ä»¶è·¯å¾„

    String getFilename();	// è·å–æ–‡ä»¶å
}
```

å‹ç¼©ä¸‹è½½æ—¶ï¼Œé™„ä»¶å®ä½“`Attachment`éœ€è¦å®ç°`FileItem`ã€‚



# ğŸŒæ–‡ç« ç½®é¡¶æ¥å£

**æ¥å£æè¿°**

è¯¥æ¥å£ç”¨äºè®¾ç½®æˆ–å–æ¶ˆæ–‡ç« ç½®é¡¶çŠ¶æ€ã€‚

**è¯·æ±‚åœ°å€**

```http
PUT /admin/{article-id}/top
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| --------- | -------- | -------- | ------ |
| articleId | `string` | `true`   | æ–‡ç« id |

**è¿”å›ç¤ºä¾‹**

```json
// ç½®é¡¶
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "topType": 1,
        "desc": "ç½®é¡¶"
    }
}
// å–æ¶ˆç½®é¡¶
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "topType": 0,
        "desc": "æœªç½®é¡¶"
    }
}
```

## æ¥å£å®ç°

æ§åˆ¶å™¨æ·»åŠ æ–¹æ³•`topArticle()`ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚ç½®é¡¶æ–‡ç« ï¼š

```java
/**
     * æ–‡ç« ç½®é¡¶æ¥å£
     *
     * @param articleId
     * @return
     */
    @PutMapping("/{article-id}/top")
    @AccessControl
    public Result<TragetTopTypeEnum> topArticle(@PathVariable("article-id") @Validation String articleId) {
        TragetTopTypeEnum tragetTopTypeEnum = articleService.topArticle(articleId);
        return Result.success(tragetTopTypeEnum);
    }
```

ä¸šåŠ¡å±‚æ–°å¢ç½®é¡¶æ–¹æ³•ï¼š

```java
/**
     * ç½®é¡¶æ–‡ç« 
     *
     * @param articleId
     */
    TragetTopTypeEnum topArticle(String articleId);
```

å®ç°ï¼š

```java
@Override
public TragetTopTypeEnum topArticle(String articleId) {
    Article article = articleMapper.selectById(articleId);
    if (Objects.isNull(article))
        throw new BusinessException(CommonMsg.ARTICLE_NOT_EXISTS);

    TragetTopTypeEnum topType = Objects.equals(article.getTopType(), TragetTopTypeEnum.TOP.getTopType()) ?
        TragetTopTypeEnum.NO_TOP : TragetTopTypeEnum.TOP;

    Article editArticle = new Article();
    editArticle.setArticleId(article.getArticleId());
    editArticle.setTopType(topType.getTopType());
    editArticle.setUpdateTime(new Date());

    articleMapper.update(editArticle);
    return topType;
}
```

å…ˆæŸ¥è¯¢æ–‡ç« ï¼Œåˆ¤æ–­æ˜¯å¦ç½®é¡¶ï¼Œç„¶åå†åŠ¨æ€è®¾ç½®ç½®é¡¶çŠ¶æ€ï¼Œæœ€åå°†ç½®é¡¶æšä¸¾ç±»å‹è¿”å›ã€‚

> æšä¸¾ç›´æ¥åºåˆ—åŒ–ä¸ºjsonå­—ç¬¦ä¸²æ—¶ï¼Œé»˜è®¤ä¸ºæšä¸¾é¡¹çš„åç§°ã€‚

è‹¥è¦æšä¸¾åºåˆ—åŒ–å†…çš„å®¹ä¸ºæšä¸¾é¡¹çš„å±æ€§ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š

1. éœ€è¦åºåˆ—åŒ–çš„å±æ€§çš„`getter`ä¸Šå£°æ˜`@JsonValue`æ³¨è§£ã€‚
2. åºåˆ—åŒ–æ•´ä¸ªæšä¸¾å¯¹è±¡ï¼Œæšä¸¾ä¸Šå£°æ˜`@JsonFormat(shape = JsonFormat.Shape.OBJECT)`æ³¨è§£ã€‚

```java
/**
 * æ–‡ç« /è¯„è®ºç½®é¡¶ç±»å‹æšä¸¾
 */
@JsonFormat(shape = JsonFormat.Shape.OBJECT)
public enum TragetTopTypeEnum {
    NO_TOP(0, "æœªç½®é¡¶"),
    TOP(1, "ç½®é¡¶");

    private Integer topType;
    private String desc;

    TragetTopTypeEnum(Integer topType, String desc) {
        this.topType = topType;
        this.desc = desc;
    }

    public Integer getTopType() {
        return topType;
    }

    public String getDesc() {
        return desc;
    }
}
```



# ğŸŒå®¡æ ¸æ–‡ç« æ¥å£

**æ¥å£æè¿°**

æœ¬æ¥å£ç”¨äºå®¡æ ¸æ–‡ç« ï¼Œå°†æ–‡ç« çŠ¶æ€æ›´æ–°ä¸º"å·²å®¡æ ¸"ï¼Œå¹¶åœ¨å®¡æ ¸æˆåŠŸåå¢åŠ æ–‡ç« ä½œè€…çš„ç§¯åˆ†ã€‚åŒæ—¶ï¼Œç³»ç»Ÿä¼šè®°å½•å®¡æ ¸æ¶ˆæ¯å¹¶é€šçŸ¥ç”¨æˆ·æ–‡ç« å·²å®¡æ ¸ã€‚

**è¯·æ±‚åœ°å€**

```http
PUT /admin/article/{ids}/audit
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å | å‚æ•°ç±»å‹       | æ˜¯å¦å¿…å¡« | è¯´æ˜     |
| ------ | -------------- | -------- | -------- |
| ids    | `list<string>` | `true`   | æ–‡ç« idé›† |

**è¿”å›å®ä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

## æ¥å£å®ç°

æœ¬æ¥å£æ”¯æŒæ‰¹é‡å®¡æ ¸æ–‡ç« ï¼Œæ¯ç¯‡æ–‡ç« å®¡æ ¸é€šè¿‡åï¼Œç³»ç»Ÿå°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **æ›´æ–°æ–‡ç« çŠ¶æ€**ï¼šå°†æ–‡ç« çŠ¶æ€ä¿®æ”¹ä¸ºâ€œå·²å®¡æ ¸â€ã€‚
2. **å¢åŠ ç”¨æˆ·ç§¯åˆ†**ï¼šæ ¹æ®ç³»ç»Ÿé…ç½®çš„ç§¯åˆ†è§„åˆ™ï¼Œä¸ºæ–‡ç« ä½œè€…å¢åŠ ç›¸åº”ç§¯åˆ†ã€‚
3. **è®°å½•å®¡æ ¸æ¶ˆæ¯**ï¼šåœ¨ç³»ç»Ÿä¸­å­˜å‚¨å®¡æ ¸è®°å½•ï¼Œä¾¿äºåç»­æŸ¥è¯¢ã€‚
4. **æ¨é€ç”¨æˆ·é€šçŸ¥**ï¼šå‘æ–‡ç« ä½œè€…å‘é€å®¡æ ¸é€šè¿‡çš„é€šçŸ¥ã€‚

åœ¨æ§åˆ¶å™¨ä¸­å¢åŠ æ–¹æ³•`auditArticle()`ï¼š

```java
/**
     * å®¡æ ¸æ–‡ç« æ¥å£
     *
     * @param ids
     * @return
     */
    @PutMapping("/{ids}/audit")
    @AccessControl
    public Result<Void> auditArticle(@PathVariable @Validation List<String> ids) {
        articleService.auditArticle(ids);
        return Result.success();
    }
```

è°ƒç”¨ä¸šåŠ¡å¤„ç†ï¼Œä¸šåŠ¡å±‚å¢åŠ æ–¹æ³•`auditArticle()`ï¼š

```java
/**
     * å®¡æ ¸æ–‡ç« 
     *
     * @param ids
     */
    void auditArticle(List<String> ids);
```

å®ç°ï¼š

```java
@Override
    public void auditArticle(List<String> ids) {
        ids.forEach(articleTxService::auditArticle);
    }
```

åœ¨ `auditArticle()` ä¸­ï¼Œéå†æ–‡ç«  ID é›†åˆï¼Œå¹¶ä¾æ¬¡è°ƒç”¨ `articleTxService.auditArticle(articleId)` è¿›è¡Œå®¡æ ¸æ“ä½œã€‚

`articleTxService`ä¸­çš„å®¡æ ¸æ–¹æ³•å¦‚ä¸‹ï¼š

**æ³¨æ„**ï¼šå·²åˆ é™¤çš„æ–‡ç« ä¸èƒ½å®¡æ ¸ï¼

```java
/**
     * å®¡æ ¸æ–‡ç« 
     *
     * @param articleId
     */
    @Transactional(rollbackFor = Exception.class)
    public void auditArticle(String articleId) {
        Article byId = articleMapper.selectById(articleId);
        // å·²åˆ é™¤æ–‡ç« å®¡æ ¸ï¼ŒæŠ›å‡ºå¼‚å¸¸
        if (Objects.equals(byId.getStatus(), TargetStatusEnum.DELETED.getStatus()))
            throw new BusinessException(CommonMsg.UNABLE_AUDIT_DELETE_ARTICLE);
        if (Objects.equals(byId.getStatus(), TargetStatusEnum.AUDITED.getStatus())) return;

        Article article = new Article();
        String aId = byId.getArticleId();
        article.setArticleId(aId);
        article.setStatus(TargetStatusEnum.AUDITED.getStatus());
        article.setUpdateTime(new Date());
        articleMapper.update(article);  // å®¡æ ¸æ–‡ç« 

        // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
        Integer postPoints = SysCacheUtil.getSysSettingManager().getSysSetting4Post().getPostPoints();
        String author = byId.getUserId();
        if (postPoints > 0) {
            userPointsRecordService.processUserPoints(author, OperationTypeEnum.POST_ARTICLE.getType(), postPoints);
        }

        sendMsg(author, aId, byId.getTitle(), Constant.AUDIT_ARTICLE_MESSAGE_CONTENT);  // å‘é€æ¶ˆæ¯
    }
```

å…¶ä¸­ï¼Œ`ArticleTxService`ä¸º`AritcleService`çš„äº‹åŠ¡ä»£ç†ç±»ã€‚

ä¸ºä»€ä¹ˆè¦å°†å…·ä½“æ‰§è¡Œå®¡æ ¸æ–¹æ³•å®šä¹‰åœ¨äº‹åŠ¡ä»£ç†ç±»ä¸­ï¼Œè€Œä¸å®šä¹‰åœ¨æœ¬ç±»ä¸­ï¼Ÿ

> springbootäº‹åŠ¡åº•å±‚é‡‡ç”¨ä»£ç†æœºåˆ¶ï¼Œå®ƒä¾é ä»£ç†æ‹¦æˆªæ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œçš„å‰åè¿›è¡Œäº‹åŠ¡ç®¡ç†ï¼Œå› æ­¤å¿…é¡»ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ‰èƒ½è®©äº‹åŠ¡ç”Ÿæ•ˆ

å‡è®¾æˆ‘ä»¬å°†å…·ä½“æ‰§è¡Œçš„æ–¹æ³•å®šä¹‰åœ¨æœ¬ç±»ä¸­ï¼š

```java
@Override
public void auditArticle(List<String> ids) {
    ids.forEach(this::auditArticle);
}

// å…·ä½“æ‰§è¡Œå®¡æ ¸çš„æ–¹æ³•
@Transactional(rollback = Exception.class)
private void auditArticle(String id) {
    // TODO
}
```

é‚£ä¹ˆåœ¨å¾ªç¯éå†æ—¶è°ƒç”¨æœ¬ç±»çš„å®¡æ ¸æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡`this`æ¥è°ƒç”¨çš„ï¼š

```java
this::auditArticle
```

è€Œ`this`æŒ‡ä»£å½“å‰å®ä¾‹å¯¹è±¡ï¼Œå¹¶éä»£ç†å¯¹è±¡ã€‚ä¸Šé¢è¯´è¿‡å¦‚æœäº‹åŠ¡ä¸æ˜¯é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ï¼Œé‚£ä¹ˆå°±ä¼šå¤±æ•ˆï¼š

```java
@Transactional(rollback = Exception.class)	// äº‹åŠ¡å¤±æ•ˆ
private void auditArticle(String id) {
    // TODO
}
```

æ‰€ä»¥ä¸ºäº†é¿å…`this`è°ƒç”¨ï¼Œæˆ‘ä»¬å°†äº‹åŠ¡ç›¸å…³çš„æ–¹æ³•æ‹†åˆ†åˆ° **äº‹åŠ¡ä»£ç†ç±» `ArticleTxService`** ä¸­(Txæ„ä¸ºTransactional)ï¼Œç¡®ä¿å®¡æ ¸é€»è¾‘åœ¨ **äº‹åŠ¡æœ‰æ•ˆçš„ç¯å¢ƒä¸‹** æ‰§è¡Œ(é€šè¿‡`ArticleTxService`çš„å®ä¾‹è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå®ä¾‹å·²è¢«ä»£ç†)ã€‚

æ–‡ç« å®¡æ ¸æˆåŠŸåï¼Œç³»ç»Ÿéœ€é€šçŸ¥ç”¨æˆ·ã€‚ç”±äº WebSocket è¿æ¥å­˜å‚¨åœ¨ Web ç«¯ï¼Œæ¶ˆæ¯æ¨é€ç”± Web ç«¯å®Œæˆï¼Œå› æ­¤ **å®¡æ ¸ç³»ç»Ÿéœ€è°ƒç”¨ Web ç«¯ API**ï¼Œç”± Web ç«¯æ¨é€é€šçŸ¥ã€‚

`sendMsg()`æ–¹æ³•ï¼š

```java
// è®°å½•æ¶ˆæ¯ && æ¨é€é€šçŸ¥
private void sendMsg(String author, String articleId, String title, String content) {
    UserMessage userMessage = new UserMessage();
    userMessage.setReceivedUserId(author);
    userMessage.setArticleId(articleId);
    userMessage.setArticleTitle(title);
    userMessage.setMessageType(MessageTypeEnum.SYS_MESSAGE.getType());
    userMessage.setMessageContent(content);
    userMessage.setStatus(MessageStatusEnum.NO_READ.getStatus());
    Date date = new Date();
    userMessage.setCreateTime(date);
    userMessage.setUpdateTime(date);

    userMessageService.add(userMessage);

    userMessageService.requestPushNotice(receiver);	// è¯·æ±‚webç«¯ï¼Œæ¨é€æ¶ˆæ¯
}
```

é€šçŸ¥ç”¨æˆ·éœ€è¦ç”¨æˆ·çš„websocketä¼šè¯ï¼Œä½†æ˜¯ä¼šè¯ä¿å­˜åœ¨webç«¯æœåŠ¡ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¯·æ±‚webç«¯ï¼Œè®©webç«¯ç»™ç”¨æˆ·æ¨é€æ¶ˆæ¯ã€‚

è¿™ä¸ªè¯·æ±‚ä¸ºå†…éƒ¨æ¥å£ï¼Œåœ¨webç«¯çš„`InnerAPIController`ä¸­å®šä¹‰ï¼š

Web ç«¯æä¾›å†…éƒ¨ API `InnerAPIController`ï¼Œä¾›å®¡æ ¸ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥å®ç° WebSocket æ¶ˆæ¯æ¨é€ã€‚

`InnerAPIController`ä¸­çš„`sendMessage()`æ–¹æ³•ï¼š

```java
/**
     * å‘é€æ¶ˆæ¯
     *
     * @param userId
     * @param timestamp
     * @param sign
     * @return
     * @throws JsonProcessingException
     */
    @GetMapping("/send-msg")
    public Result<Void> sendMessage(String userId, Long timestamp, String sign) throws JsonProcessingException {
        // æ ¡éªŒæ—¶é—´æˆ³ï¼Œé¿å…ä½¿ç”¨æ—§å€¼
        checkTimestamp(timestamp);

        // æ ¡éªŒç­¾å
        checkSign(sign, userId + timestamp);

        WSMessage wsMessage = WSMessage.ofAdminServer(WSMessageTypeEnum.LOAD_UNREAD);

        String res = JSON_MAPPER.writeValueAsString(wsMessage);

        try {
            webSocketServer.sendMessageToUser(userId, res);
            return Result.success();
        } catch (IOException e) {
            throw new BusinessException(CommonMsg.WS_MESSAGE_SEND_FAIL, e);
        }
    }

/**
     * æ ¡éªŒæ—¶é—´æˆ³
     *
     * @param timestamp
     */
    private void checkTimestamp(Long timestamp) {
        if (Math.abs(System.currentTimeMillis() - timestamp) >= Constant.MILLIS_1 * 30) {
            log.error("æ—¶é—´æˆ³å¤±æ•ˆ");
            throw new BusinessException(ResponseCodeEnum.CODE_600);
        }
    }

    /**
     * æ ¡éªŒç­¾å
     *
     * @param sign
     */
    private void checkSign(String sign, String data) {
        String secretKey = webConfig.getSecretKey();
        String mySign = StrUtil.generateHmacSha256Hex(secretKey, data);
        if (!Objects.equals(mySign, sign)) {
            log.error("ç­¾åé”™è¯¯ï¼Œæ ¡éªŒå¤±è´¥");
            throw new BusinessException(ResponseCodeEnum.CODE_600);
        }
    }
```

é€šç”¨é‡‡ç”¨å‰é¢æ¥éªŒè¯èº«ä»½ï¼Œç­¾åé€šè¿‡ç”¨æˆ·idâ•æ—¶é—´æˆ³ç”Ÿæˆã€‚

åœ¨æ’å…¥æ¶ˆæ¯åï¼Œè°ƒç”¨ã€requestPushNotice()ã€‘ï¼Œè€Œã€requestPushNotice()ã€‘æ˜¯ã€UserMessageServiceã€‘æä¾›çš„æ¥å£ï¼Œä¸“é—¨è¯·æ±‚ä¸Šé¢çš„å†…éƒ¨æ¥å£ï¼Œæ¥å£å¦‚ä¸‹ï¼š

```java
/**
 * è¯·æ±‚webç«¯æ¨é€é€šçŸ¥
 *
 * @param receiver
 */
void requestPushNotice(String receiver);
```

å®ç°ï¼š

```java
@Override
    public void requestPushNotice(String receiver) {
        long currentTime = System.currentTimeMillis();
        String sign = StrUtil.generateHmacSha256Hex(adminConfig.getSecretKey(), receiver + currentTime);
        String url = adminConfig.getInnerUrl() + "/send-msg?userId=" + receiver + "&timestamp=" + currentTime + "&sign=" + sign;
        String result = OkHttpUtil.getRequest(url);
        log.info("å“åº”ç»“æœ: {}", result);
    }
```



# ğŸŒåˆ é™¤æ–‡ç« æ¥å£

**æ¥å£æè¿°**

æœ¬æ¥å£ç”¨äºæ‰¹é‡åˆ é™¤æ–‡ç« ï¼Œåˆ é™¤æ“ä½œé‡‡ç”¨é€»è¾‘åˆ é™¤æ–¹å¼ï¼Œå³ä»…æ›´æ–°æ–‡ç« çŠ¶æ€ä¸º"å·²åˆ é™¤"ï¼Œè€Œéç‰©ç†åˆ é™¤ã€‚åŒæ—¶ï¼Œç³»ç»Ÿå°†åœ¨åˆ é™¤æ“ä½œå®Œæˆåï¼Œå‘æ–‡ç« ä½œè€…å‘é€é€šçŸ¥ï¼Œå‘ŠçŸ¥æ–‡ç« å·²è¢«åˆ é™¤ã€‚

**è¯·æ±‚åœ°å€**

```http
DELETE /admin/article/{ids}
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å | å‚æ•°ç±»å‹       | æ˜¯å¦å¿…å¡« | è¯´æ˜     |
| ------ | -------------- | -------- | -------- |
| ids    | `list<string>` | `true`   | æ–‡ç« idé›† |

**è¿”å›ç¤ºä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

## æ¥å£å®ç°

åŠŸèƒ½è¯´æ˜ï¼š

- æ”¯æŒæ‰¹é‡åˆ é™¤æ–‡ç« ï¼Œä½†ä¸ä¼šçœŸæ­£ä»æ•°æ®åº“ä¸­ç§»é™¤ï¼Œè€Œæ˜¯é€šè¿‡æ›´æ–°æ–‡ç« çŠ¶æ€æ ‡è®°ä¸º"å·²åˆ é™¤"ã€‚

- åˆ é™¤æˆåŠŸåï¼Œç³»ç»Ÿä¼šè®°å½•è¯¥æ“ä½œï¼Œå¹¶å‘æ–‡ç« ä½œè€…å‘é€é€šçŸ¥ï¼Œä»¥ç¡®ä¿ç”¨æˆ·çŸ¥æ‚‰æ–‡ç« è¢«åˆ é™¤çš„æƒ…å†µã€‚

åˆ é™¤çš„æµç¨‹ä¸å®¡æ ¸ç±»ä¼¼ï¼Œå…¶ä¸­çš„å®ç°ç»†èŠ‚ä¸å†èµ˜è¿°ã€‚

åœ¨ `ArticleController` ä¸­æ–°å¢ `delArticle()` æ–¹æ³•ï¼Œè´Ÿè´£æ¥æ”¶è¯·æ±‚å¹¶è°ƒç”¨ä¸šåŠ¡å±‚è¿›è¡Œå¤„ç†ï¼š

```java
/**
     * åˆ é™¤æ–‡ç« 
     *
     * @param ids
     * @return
     */
    @DeleteMapping("/{ids}")
    @AccessControl
    public Result<Void> delArticle(@PathVariable @Validation List<String> ids) {
        articleService.delete(ids);
        return Result.success();
    }
```

ä¸šåŠ¡å±‚`delete()`ï¼š

```java
/**
     * åˆ é™¤
     *
     * @param
     */
    void delete(List<String> list);
```

å®ç°ï¼š

```java
@Override
public void delete(List<String> list) {
    list.forEach(articleTxService::delete);
}
```

åŒæ ·ä¸ºäº†ä¿è¯äº‹åŠ¡çš„æ­£å¸¸æ‰§è¡Œï¼Œå®é™…çš„æ–‡ç« åˆ é™¤é€»è¾‘æ”¾ç½®åœ¨ `ArticleTxService` ä¸­ï¼š

```java
/**
     * åˆ é™¤æ–‡ç« 
     *
     * @param id
     */
    @Transactional(rollbackFor = Exception.class)
    public void delete(String id) {
        Article byId = articleMapper.selectById(id);
        if (Objects.isNull(byId) || Objects.equals(byId.getStatus(), TargetStatusEnum.DELETED.getStatus())) return;

        Article article = new Article();
        article.setArticleId(id);
        article.setStatus(TargetStatusEnum.DELETED.getStatus());
        article.setUpdateTime(new Date());

        articleMapper.update(article);  // åˆ é™¤

        String title = byId.getTitle();
        // å‘é€æ¶ˆæ¯
        sendMsg(byId.getUserId(), byId.getArticleId(), title, String.format(Constant.DEL_ARTICLE_MESSAGE_CONTENT, title));
    }
```

æ›´æ–°æ–‡ç« çŠ¶æ€ä¸º"å·²åˆ é™¤"ï¼Œè°ƒç”¨`sendMsg()`è®°å½•æ¶ˆæ¯å¹¶é€šçŸ¥ç”¨æˆ·ã€‚
