# åˆ›å»ºæ§åˆ¶å™¨

é¦–å…ˆï¼Œåˆ›å»º `ArticleController` ä½œä¸ºæ–‡ç« ç®¡ç†çš„æ§åˆ¶å™¨ï¼Œç»Ÿä¸€è¯·æ±‚å‰ç¼€ä¸º `/article`ã€‚

```java
/**
 * æ–‡ç« ç®¡ç†æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/article")
public class ArticleController {}
```



# ğŸŒè·å–æ–‡ç« åˆ—è¡¨æ¥å£

**æ¥å£æè¿°**

è¯¥æ¥å£æ”¯æŒå¤šæ¡ä»¶æŸ¥è¯¢æ–‡ç« åˆ—è¡¨ï¼ŒæŸ¥è¯¢æ¡ä»¶åŒ…æ‹¬ä½†ä¸é™äºï¼š

- æ ‡é¢˜
- ä½œè€…
- æ¿å—
- é™„ä»¶çŠ¶æ€
- çŠ¶æ€
- ç½®é¡¶çŠ¶æ€

**è¯·æ±‚åœ°å€**

```http
GET /admin/article
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å         | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜                            |
| -------------- | -------- | -------- | ------------------------------- |
| title          | `string` | `false`  | æ ‡é¢˜                            |
| author         | `string` | `false`  | ä½œè€…                            |
| pBoardId       | `int`    | `false`  | çˆ¶æ¿å—id                        |
| boardId        | `int`    | `false`  | å­æ¿å—id                        |
| attachmentType | `int`    | `false`  | 0: æ— é™„ä»¶, 1: æœ‰é™„ä»¶            |
| status         | `int`    | `false`  | 0: å·²åˆ é™¤, 1: å¾…å®¡æ ¸, 2: å·²å®¡æ ¸ |
| topType        | `string` | `false`  | 0: æœªç½®é¡¶, 1: ç½®é¡¶              |
| page           | `int`    | `true`   | é¡µç                             |
| pageSize       | `int`    | `true`   | æ¯é¡µæ¡ç›®                        |

**è¿”å›å®ä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "total": 2,
        "page": 1,
        "pageSize": 10,
        "pageTotal": 1,
        "rows": [
            {
                "articleId": "000981283431340",
                "boardId": 2,
                "boardName": "æ¸¸æˆå’¨è¯¢",
                "pBoardId": 1,
                "pBoardName": "æ¸¸æˆ",
                "avatar": null,
                "userId": "9876175182",
                "nickName": "user_189",
                "userIdAddress": "å››å·çœ",
                "title": "æ³¢å…°è ¢é©´æ–°ä½œã€Šå·«å¸ˆ4ã€‹æœ€æ–°å’¨è¯¢",
                "cover": null,
                "content": null,
                "mdContent": null,
                "editorType": 0,
                "summary": "xxxxxxx",
                "readCount": 20,
                "likeCount": 1,
                "topType": 0,
                "attachmentType": 1,
                "status": 2,
                "createTime": "2025-03-01 18:11:46",
                "commentCount": 0
            },
            ......
        ]
    }
}
```

## æ¥å£å®ç°

æ§åˆ¶å™¨ä¸­å®šä¹‰åŠ è½½æ–‡ç« åˆ—è¡¨çš„æ–¹æ³•`loadArticles()`ï¼Œæ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼Œç›´æ¥è°ƒç”¨æ–‡ç« æŸ¥è¯¢ä¸šåŠ¡å³å¯ã€‚

å› ä¸ºæ˜¯ç®¡ç†ç«¯ï¼Œæ‰€ä»¥å¯ä»¥æŸ¥çœ‹æ–‡ç« çš„æ‰€æœ‰çŠ¶æ€ã€‚

æ–‡ç« æ’åºé»˜è®¤ä¸ºå‘å¸ƒæ—¥æœŸå€’å™æ’åºã€‚

```java
/**
     * åŠ è½½æ–‡ç« åˆ—è¡¨æ¥å£
     *
     * @param page
     * @param pageSize
     * @param title
     * @param author
     * @param pBoardId
     * @param boardId
     * @param attachmentType
     * @param status
     * @param topType
     * @return
     */
    @GetMapping
    @AccessControl
    public Result<PageBean<ArticleVo>> loadArticles(@Validation(min = 1) Integer page, @Validation Integer pageSize,
                                                    @Validation(required = false, max = 50) String title,
                                                    @Validation(required = false, max = 50) String author,
                                                    @Validation(required = false) Integer pBoardId,
                                                    @Validation(required = false, min = 1) Integer boardId,
                                                    @Validation(required = false, max = 1) Integer attachmentType,
                                                    @Validation(required = false, max = 2) Integer status,
                                                    @Validation(required = false, max = 1) Integer topType) {
        ArticleQuery articleQuery = new ArticleQuery();
        articleQuery.setPage(page);
        articleQuery.setPageSize(pageSize);
        articleQuery.setTitle(title);
        articleQuery.setAuthor(author);
        articleQuery.setpBoardId(pBoardId);
        articleQuery.setBoardId(boardId);
        articleQuery.setAttachmentType(attachmentType);
        articleQuery.setStatus(status);
        articleQuery.setTopType(topType);
        articleQuery.setOrderBy("create_time desc");

        PageBean<ArticleVo> voByCondition = articleService.findVoByCondition(articleQuery);

        return Result.success(voByCondition);
    }
```



# ğŸŒåŠ è½½æ–‡ç« æ¥å£

**æ¥å£æè¿°**

è·å–æŒ‡å®š `articleId` çš„æ–‡ç« å†…å®¹ã€‚ä»…è¿”å›æ–‡ç« æ­£æ–‡ï¼Œä¸åŒ…å«é™„ä»¶åŠè¯„è®ºã€‚

**è¯·æ±‚åœ°å€**

```http
GET /admin/article/{aritcle-id}
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| --------- | -------- | -------- | ------ |
| articleId | `string` | `true`   | æ–‡ç« id |

**è¿”å›ç¤ºä¾‹**

```java
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "articleId": "173568352430026",
        "boardId": 7,
        "boardName": "ç¾é£Ÿ",
        "pBoardId": 0,
        "pBoardName": null,
        "avatar": null,
        "userId": "9619980088",
        "nickName": "ling",
        "userIdAddress": "å››å·çœ",
        "title": "ã€Šè¾£æ¤’å¦‚ä½•ä¿˜è·ä¸­å›½äººçš„èƒƒã€‹",
        "cover": "cover/2025-03/576cee8ac4ab44a889445eb68b6ebbe2.jpg",
        "content": "&lt;h1&gt;è¾£æ¤’ï¼Œè±ªèµ¤&lt;/h1&gt;\néƒ½ç»™æˆ‘å»åƒè¾£æ¤’",
        "mdContent": "#è¾£æ¤’ï¼Œè±ªèµ¤\néƒ½ç»™æˆ‘å»åƒè¾£æ¤’",
        "editorType": 1,
        "summary": "è¾£æ¤’çš„å¾æœå†å²",
        "readCount": 0,
        "likeCount": 0,
        "topType": 0,
        "attachmentType": 0,
        "status": 1,
        "createTime": "2025-03-03 13:40:35",
        "commentCount": 0
    }
}
```

## æ¥å£å®ç°

åœ¨æ§åˆ¶å™¨ä¸­å®šä¹‰æ–¹æ³•`loadArticle()`ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚æŸ¥è¯¢å…·ä½“æ–‡ç« ã€‚

>  åˆ é™¤çš„æ–‡ç« åº”æ‹’ç»è®¿é—®ã€‚

```java
/**
     * åŠ è½½æ–‡ç« æ¥å£
     *
     * @param articleId
     * @return
     */
    @GetMapping("/{article-id}")
    @AccessControl
    public Result<ArticleVo> loadArticle(@PathVariable("article-id") @Validation(max = 15) String articleId) {
        ArticleVo articleVo = articleService.findById(articleId);
        if (Objects.isNull(articleVo) || Objects.equals(articleVo.getStatus(), TargetStatusEnum.DELETED.getStatus()))
            throw new BusinessException(ResponseCodeEnum.CODE_404);

        return Result.success(articleVo);
    }
```



# ğŸŒåŠ è½½é™„ä»¶åˆ—è¡¨æ¥å£

**æ¥å£æè¿°**

æ­¤æ¥å£è¿”å›å…·ä½“æ–‡ç« çš„é™„ä»¶ã€‚

**è¯·æ±‚åœ°å€**

```http
GET /admin/article/{article-id}/attachment
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| --------- | -------- | -------- | ------ |
| articleId | `string` | `true`   | æ–‡ç« id |

**è¿”å›ç¤ºä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": [
        {
            "fileId": "56c1a4d6a14045a9904e93243a962fca",
            "filename": "584_2025030164232458 - å‰¯æœ¬.jpeg",
            "filesize": 19272,
            "filetype": 10,
            "downloadCount": 9,
            "downloadPoints": 2
        },
        {
            "fileId": "bd47629eeb8f4c6ea1d3caa6b5d32cfd",
            "filename": "584_2025030164232998 - å‰¯æœ¬.jpeg",
            "filesize": 14827,
            "filetype": 10,
            "downloadCount": 9,
            "downloadPoints": 2
        },
        ......
    ]
}
```

## æ¥å£å®ç°

æ§åˆ¶å™¨ä¸­å®šä¹‰æ–¹æ³•`loadAttachments()`ï¼Œæ ¡éªŒæ–‡ç« æ˜¯å¦å­˜åœ¨ï¼Œå†æŸ¥è¯¢é™„ä»¶åˆ—è¡¨å¹¶è¿”å›ï¼š

```java
/**
     * åŠ è½½é™„ä»¶åˆ—è¡¨æ¥å£
     *
     * @param articleId
     * @return
     */
    @GetMapping("/{article-id}/attachment")
    @AccessControl
    public Result<List<AttachmentVo>> loadAttachments(@PathVariable("article-id")
                                                      @Validation(max = 15) String articleId) {
        ArticleVo articleVo = articleService.findById(articleId);
        if (Objects.isNull(articleVo) || Objects.equals(articleVo.getStatus(), TargetStatusEnum.DELETED.getStatus()))
            throw new BusinessException(ResponseCodeEnum.CODE_404);

        List<Attachment> attachments = attachmentService.findByArticleId(articleId);

        List<AttachmentVo> attachmentVos = attachments.stream().map(e -> {
            AttachmentVo attachmentVo = new AttachmentVo();
            BeanUtils.copyProperties(e, attachmentVo);
            return attachmentVo;
        }).collect(Collectors.toList());

        return Result.success(attachmentVos);
    }
```



# ğŸŒä¸‹è½½é™„ä»¶æ¥å£

**æ¥å£æè¿°**

ä¸‹è½½å¯¹åº”çš„æ–‡ç« çš„é™„ä»¶ï¼Œå¤šé™„ä»¶æ—¶å‹ç¼©ä¸‹è½½ã€‚

**è¯·æ±‚åœ°å€**

```http
GET /admin/aritcle/{article-id}/attachment/download
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| --------- | -------- | -------- | ------ |
| articleId | `string` | `true`   | æ–‡ç« id |

**è¿”å›ç¤ºä¾‹**

```json
æ•°æ®æµ
```

## æ¥å£å®ç°

æ§åˆ¶å™¨ä¸­å®šä¹‰æ–¹æ³•`downloadAttachment()`ã€‚

```java
/**
     * ä¸‹è½½é™„ä»¶æ¥å£
     *
     * @param articleId
     * @return
     * @throws Exception
     */
    @GetMapping("/{article-id}/attachment/download")
    @AccessControl
    public ResponseEntity<byte[]> downloadAttachment(@PathVariable("article-id")
                                                     @Validation(max = 15) String articleId) throws Exception {
        ArticleVo articleVo = articleService.findById(articleId);
        if (Objects.isNull(articleVo) || Objects.equals(articleVo.getStatus(), TargetStatusEnum.DELETED.getStatus()))
            throw new BusinessException(ResponseCodeEnum.CODE_404);

        List<Attachment> attachments = attachmentService.findByArticleId(articleId);
        if (Objects.isNull(attachments) || attachments.isEmpty())
            throw new BusinessException(CommonMsg.FILE_NOT_FOUND);

        if (attachments.size() > 1) {
            return fileService.downloadAsZip(attachments);           // å‹ç¼©ä¸‹è½½
        } else {
            Attachment attachment = attachments.get(0);
            String contentType = MIMETypeEnum.getContentType(attachment.getFiletype());
            // å•æ–‡ä»¶ä¸‹è½½
            return fileService.downloadFile(attachment.getFilepath(), attachment.getFilename(), contentType);
        }
    }
```

è°ƒç”¨æ–‡ä»¶ä¸šåŠ¡å±‚çš„æ–¹æ³•ä¸‹è½½é™„ä»¶ï¼Œæˆ‘å°†å¤šæ–‡ä»¶å‹ç¼©ä¸‹è½½çš„æ–¹æ³•æå–æˆäº†ä¸€ä¸ªé€šç”¨æ–¹æ³•ï¼š

```java
@Override
public ResponseEntity<byte[]> downloadAsZip(List<? extends FileItem> fileItems) throws Exception {
    ByteArrayOutputStream aos = new ByteArrayOutputStream();
    try (ZipOutputStream zos = new ZipOutputStream(aos)) {
        for (FileItem fileItem : fileItems) {
            File file = new File(fileItem.getFilepath());
            if (!file.exists() || file.isDirectory())
                throw new BusinessException(CommonMsg.FILE_NOT_FOUND);
            try (InputStream is = new FileInputStream(file)) {
                ZipEntry zipEntry = new ZipEntry(fileItem.getFilename());
                zos.putNextEntry(zipEntry);
                IOUtils.copy(is, zos);
                zos.closeEntry();
            }
        }
    }

    // å‹ç¼©æµå…³é—­åï¼Œå†å†™å‡ºåˆ°å­—èŠ‚æ•°ç»„ï¼Œå¦åˆ™å‹ç¼©æ–‡ä»¶å†…å®¹ç¼ºå¤±
    byte[] byteArray = aos.toByteArray();
    HttpHeaders headers = new HttpHeaders();
    headers.add("Content-Type", MIMETypeEnum.ZIP.getContentType());
    String filename = URLEncoder.encode(String.format(Constant.ZIP_FILENAME, StrUtil.formatDate("_yyyyMMdd_hhmmss")));
    headers.add("Content-Disposition", "attachment; filename=" + filename);
    headers.add("Content-Length", String.valueOf(byteArray.length));

    return ResponseEntity.ok()
        .headers(headers)
        .body(byteArray);
}
```

å…¶ä¸­`FileItem`æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰åœ¨`FileService`å†…éƒ¨ï¼Œè¯¥æ¥å£æä¾›ä¸¤ä¸ªæ–¹æ³•`getFilepath()`å’Œ`getFilename()`ï¼š

```java
interface FileItem {
    String getFilepath();	// è·å–æ–‡ä»¶è·¯å¾„

    String getFilename();	// è·å–æ–‡ä»¶å
}
```

å‹ç¼©ä¸‹è½½æ—¶ï¼Œé™„ä»¶å®ä½“`Attachment`éœ€è¦å®ç°`FileItem`ã€‚



# ğŸŒæ–‡ç« ç½®é¡¶æ¥å£

**æ¥å£æè¿°**

è¯¥æ¥å£ç”¨äºè®¾ç½®æˆ–å–æ¶ˆæ–‡ç« ç½®é¡¶çŠ¶æ€ã€‚

**è¯·æ±‚åœ°å€**

```http
PUT /admin/{article-id}/top
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| --------- | -------- | -------- | ------ |
| articleId | `string` | `true`   | æ–‡ç« id |

**è¿”å›ç¤ºä¾‹**

```json
// ç½®é¡¶
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "topType": 1,
        "desc": "ç½®é¡¶"
    }
}
// å–æ¶ˆç½®é¡¶
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "topType": 0,
        "desc": "æœªç½®é¡¶"
    }
}
```

## æ¥å£å®ç°

æ§åˆ¶å™¨æ·»åŠ æ–¹æ³•`topArticle()`ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚ç½®é¡¶æ–‡ç« ï¼š

```java
/**
     * æ–‡ç« ç½®é¡¶æ¥å£
     *
     * @param articleId
     * @return
     */
    @PutMapping("/{article-id}/top")
    @AccessControl
    public Result<TragetTopTypeEnum> topArticle(@PathVariable("article-id") @Validation String articleId) {
        TragetTopTypeEnum tragetTopTypeEnum = articleService.topArticle(articleId);
        return Result.success(tragetTopTypeEnum);
    }
```

ä¸šåŠ¡å±‚æ–°å¢ç½®é¡¶æ–¹æ³•ï¼š

```java
/**
     * ç½®é¡¶æ–‡ç« 
     *
     * @param articleId
     */
    TragetTopTypeEnum topArticle(String articleId);
```

å®ç°ï¼š

```java
@Override
public TragetTopTypeEnum topArticle(String articleId) {
    Article article = articleMapper.selectById(articleId);
    if (Objects.isNull(article))
        throw new BusinessException(CommonMsg.ARTICLE_NOT_EXISTS);

    TragetTopTypeEnum topType = Objects.equals(article.getTopType(), TragetTopTypeEnum.TOP.getTopType()) ?
        TragetTopTypeEnum.NO_TOP : TragetTopTypeEnum.TOP;

    Article editArticle = new Article();
    editArticle.setArticleId(article.getArticleId());
    editArticle.setTopType(topType.getTopType());
    editArticle.setUpdateTime(new Date());

    articleMapper.update(editArticle);
    return topType;
}
```

å…ˆæŸ¥è¯¢æ–‡ç« ï¼Œåˆ¤æ–­æ˜¯å¦ç½®é¡¶ï¼Œç„¶åå†åŠ¨æ€è®¾ç½®ç½®é¡¶çŠ¶æ€ï¼Œæœ€åå°†ç½®é¡¶æšä¸¾ç±»å‹è¿”å›ã€‚

> æšä¸¾ç›´æ¥åºåˆ—åŒ–ä¸ºjsonå­—ç¬¦ä¸²æ—¶ï¼Œé»˜è®¤ä¸ºæšä¸¾é¡¹çš„åç§°ã€‚

è‹¥è¦æšä¸¾åºåˆ—åŒ–å†…çš„å®¹ä¸ºæšä¸¾é¡¹çš„å±æ€§ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š

1. éœ€è¦åºåˆ—åŒ–çš„å±æ€§çš„`getter`ä¸Šå£°æ˜`@JsonValue`æ³¨è§£ã€‚
2. åºåˆ—åŒ–æ•´ä¸ªæšä¸¾å¯¹è±¡ï¼Œæšä¸¾ä¸Šå£°æ˜`@JsonFormat(shape = JsonFormat.Shape.OBJECT)`æ³¨è§£ã€‚

```java
/**
 * æ–‡ç« /è¯„è®ºç½®é¡¶ç±»å‹æšä¸¾
 */
@JsonFormat(shape = JsonFormat.Shape.OBJECT)
public enum TragetTopTypeEnum {
    NO_TOP(0, "æœªç½®é¡¶"),
    TOP(1, "ç½®é¡¶");

    private Integer topType;
    private String desc;

    TragetTopTypeEnum(Integer topType, String desc) {
        this.topType = topType;
        this.desc = desc;
    }

    public Integer getTopType() {
        return topType;
    }

    public String getDesc() {
        return desc;
    }
}
```

