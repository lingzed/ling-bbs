# 1 å›¾ç‰‡ä¸Šä¼ 

## 1.1 å›¾ç‰‡å­˜å‚¨è·¯å¾„è¯´æ˜

å›¾ç‰‡ä¸Šä¼ çš„è·¯å¾„åœ¨é…ç½®æ–‡ä»¶ä¸­ç»™å®šï¼š

webæ¨¡å—ï¼š

```yml
project:
  folder: D:/ling-bbs-folder/web   # webç«¯é¡¹ç›®æ–‡ä»¶è·¯å¾„
  folder-attachment: attachment   # é™„ä»¶ç›®å½•
```

adminæ¨¡å—ï¼š

```yml
# é¡¹ç›®é…ç½®
project:
  folder: D:/ling-bbs-folder/admin   # adminç«¯é¡¹ç›®æ–‡ä»¶è·¯å¾„
  folder-attachment: attachment   # é™„ä»¶ç›®å½•
```

å…¶ä¸­`project.folder`æŒ‡å®šé¡¹ç›®çš„æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼Œä½œä¸ºé¡¹ç›®æ–‡ä»¶å­˜å‚¨çš„æ ¹ç›®å½•æ‰€æœ‰ä¸Šä¼ æ–‡ä»¶éƒ½å°†åŸºäºæ­¤è·¯å¾„è¿›è¡Œå­˜å‚¨ã€‚

ç³»ç»Ÿå°†å›¾ç‰‡èµ„æºç»†åˆ†ä¸ºä¸‰ç±»è¿›è¡Œå­˜å‚¨ç®¡ç†ï¼š

- è¯„è®ºå›¾ç‰‡ï¼šå­˜å‚¨åœ¨commentç›®å½•ä¸‹
- å°é¢å›¾ç‰‡ï¼šå­˜å‚¨åœ¨coveræŒ‡å®šç›®å½•ä¸‹
- ç”¨æˆ·å¤´åƒï¼šå­˜å‚¨åœ¨avataræŒ‡å®šç›®å½•ä¸‹

æœ€ç»ˆåœ¨æœåŠ¡å™¨ä¸Šä¼ ç”Ÿæˆè¿™æ ·çš„ç›®å½•ç»“æ„ï¼š
```
æ ¹ç›®å½•ï¼ˆproject.folderï¼‰
    â”œâ”€â”€ å›¾ç‰‡ç±»å‹ç›®å½•ï¼ˆcomment|cover|avatarï¼‰
        â”œâ”€â”€ æ—¥æœŸåˆ†ç»„ç›®å½•ï¼ˆyyyy-MMï¼‰
            â””â”€â”€ å…·ä½“å›¾ç‰‡æ–‡ä»¶
```

æ¯ä¸ªå›¾ç‰‡å­ç›®å½•ä¸­ä¼šæ ¹æ®æ—¥æœŸè¿›è¡Œåˆ†ç»„ï¼Œä»¥"yyyy-MM"æ ¼å¼æ—¥æœŸä¸ºç›®å½•ååˆ›å»ºåˆ†ç»„ç›®å½•ï¼š

```
D:/ling-bbs-folder/web
    â”œâ”€â”€ comment
        â”œâ”€â”€ 2023-08
        â”œâ”€â”€ 2023-09
    â”œâ”€â”€ cover
        â”œâ”€â”€ 2023-08
        â”œâ”€â”€ 2023-09
    â”œâ”€â”€ avatar
        â”œâ”€â”€ 2023-08
        â”œâ”€â”€ 2023-09
```

å›¾ç‰‡æœ€ç»ˆå­˜å‚¨åœ¨æ—¥æœŸç›®å½•ä¸‹ï¼Œå¦‚ï¼š

```
D:/ling-bbs-folder/web/comment/2023-09/example.jpg
```

---

## 1.2 ğŸŒå›¾ç‰‡ä¸Šä¼ æ¥å£

åœ°å€ï¼š

```swift
Post /web/file/upload/image/{comment|cover|avatar}
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å  | ç±»å‹     | å¿…å¡«é¡¹ | è¯´æ˜                                         |
| ------- | -------- | ------ | -------------------------------------------- |
| imgFile | `file`   | `true` | å›¾ç‰‡                                         |
| imgDir  | `string` | `true` | è·¯å¾„å‚æ•°ï¼Œå¯é€‰å€¼ï¼š`image`ã€`cover`ã€`avatar` |

å“åº”ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "filepath": "avatar/2025-02/7e9845344f354ced83b47f9cf904258b.png"
    }
}
```

ä¸Šä¼ æˆåŠŸï¼Œè¿”å›æ–‡ä»¶è·¯å¾„ã€‚

---

## 1.3 ä¸Šä¼ æ¥å£å®ç°

æ§åˆ¶å™¨å±‚ï¼š

é™å®šè·¯å¾„å‚æ•°çš„å–å€¼èŒƒå›´ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š

```java
{è·¯å¾„å:æšä¸¾é¡¹1|æšä¸¾é¡¹2|...}
```

ä¾‹å¦‚ï¼š

é™å®š`imgDir`å¯é€‰å€¼ï¼š`comment`ã€`cover`ã€`avatar`ï¼š

```java
@PostMapping("/upload/image/{imgDir:comment|avatar|cover}")
```

```java
/**
     * å›¾ç‰‡ä¸Šä¼ æ¥å£
     *
     * @param imgFile
     * @return
     */
    @PostMapping("/upload/image/{imgDir:comment|avatar|cover}")
    @AccessControl(loginRequired = true)
    public Result<FileUploadVo> uploadImage(MultipartFile imgFile, @PathVariable String imgDir) {
        try {
            String filename = imgFile.getOriginalFilename();
            String suffix = StrUtil.getFilenameSuffix(filename);
            // åˆ¤æ–­å…è®¸ä¸Šä¼ çš„å›¾ç‰‡æ ¼å¼
            if (!webConfig.getAllowImgSuffixList().contains(suffix))
                throw new BusinessException(CommonMsg.UNSUPPORTED_IMAGE_FORMAT);
            String randomFilename = StrUtil.getUUID() + suffix;
            String dateDir = StrUtil.formatDate("yyyy-MM");
            String imgDirPath = getProjectImgDirPath(imgDir, dateDir);
            File dir = new File(imgDirPath);
            if (!dir.exists()) {
                dir.mkdirs();
            }
            imgFile.transferTo(new File(dir, randomFilename));
            FileUploadVo fileUploadVo = new FileUploadVo();
            fileUploadVo.setFilepath(imgDir + "/" + dateDir + "/" + randomFilename);
            return Result.success(fileUploadVo);
        } catch (BusinessException e) {
            throw e;
        } catch (Exception e) {
            throw new BusinessException(CommonMsg.FILE_UPLOAD_FAIL);
        }
    }

    private String getProjectImgDirPath(String imgDir, String dateDir) {
                StringBuffer sb = new StringBuffer();
                return sb.append(webConfig.getProjectFolder())
                        .append(File.separator)
                        .append(imgDir)
                        .append(File.separator)
                        .append(dateDir)
                        .toString();
            }
```

---

## 1.4 ç”Ÿæˆç¼©ç•¥å›¾

ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šçš„å›¾ç‰‡ï¼Œä¸€èˆ¬éœ€è¦ç”Ÿæˆç¼©ç•¥å›¾ã€‚æŒ‰ä¸€å®šæ¯”ä¾‹æˆ–å®½é«˜è¿›è¡Œç¼©ç•¥ã€‚

ç¼©ç•¥çš„ç›®çš„æ˜¯ï¼š

- **å‡å°‘å›¾ç‰‡å¤§å°**ï¼šæé«˜ç½‘é¡µæˆ–åº”ç”¨çš„åŠ è½½é€Ÿåº¦ã€‚
- **ä¼˜åŒ–å¸¦å®½æ¶ˆè€—**ï¼šç¼©ç•¥å›¾å¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡ï¼Œé™ä½æœåŠ¡å™¨æµé‡å‹åŠ›ã€‚
- **å¿«é€Ÿé¢„è§ˆ**ï¼šåœ¨åˆ—è¡¨ã€ç›¸å†Œã€å•†å“å±•ç¤ºç­‰åœºæ™¯ï¼Œç¼©ç•¥å›¾å¯ç”¨äºå¿«é€Ÿé¢„è§ˆï¼Œæ— éœ€åŠ è½½å¤§å›¾ã€‚

ä»¥Bç«™è¯„è®ºåŒºä¸ºä¾‹ï¼Œè¯„è®ºä¸­çš„å›¾ç‰‡éƒ½æ˜¯ç¼©ç•¥å›¾ï¼Œä¸»è¦ç”¨äºå¿«é€Ÿæµè§ˆï¼š

![image-20250223104234833](assets/image-20250223104234833.png)

åœ¨è¯„è®ºåŒºï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¼ å¤šå¼ å›¾ç‰‡ã€‚å¦‚æœç›´æ¥åŠ è½½åŸå›¾ï¼Œä¸ä»…ä¼šå¢åŠ è¯„è®ºåˆ—è¡¨çš„åŠ è½½æ—¶é—´ï¼Œè¿˜ä¼šå¤§å¹…å ç”¨ç½‘ç»œå¸¦å®½ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚ç„¶è€Œï¼Œè¯„è®ºåŒºçš„å›¾ç‰‡ä¸»è¦ç”¨äºå¿«é€Ÿæµè§ˆï¼Œå¹¶ä¸éœ€è¦ä¸€å¼€å§‹å°±åŠ è½½é«˜æ¸…åŸå›¾ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå±•ç¤ºç»è¿‡å‹ç¼©çš„ç¼©ç•¥å›¾ï¼Œç¡®ä¿é¡µé¢åŠ è½½æ›´æµç•…ã€‚

å½“ç”¨æˆ·éœ€è¦æŸ¥çœ‹å›¾ç‰‡çš„è¯¦ç»†å†…å®¹æ—¶ï¼Œå¯ä»¥ç‚¹å‡»ç¼©ç•¥å›¾è¿›è¡Œå¤§å›¾å±•ç¤ºï¼Œæ­¤æ—¶æœåŠ¡å™¨æ‰è¿”å›åŸå›¾ã€‚è¿™æ ·ä¸€æ¥ï¼Œåªä¼šè¯·æ±‚ç”¨æˆ·çœŸæ­£éœ€è¦æŸ¥çœ‹çš„å›¾ç‰‡ï¼Œæå¤§åœ°å‡å°‘äº†ä¸å¿…è¦çš„å¸¦å®½æ¶ˆè€—ï¼ŒåŒæ—¶ä¹Ÿæå‡äº†æ•´ä½“çš„è®¿é—®æ•ˆç‡å’Œæµç•…åº¦ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20250223104949623](assets/image-20250223104949623.png)

ä¸åŒç±»å‹å›¾ç‰‡èµ„æºç¼©ç•¥å®½é«˜å¦‚ä¸‹ï¼š

| å›¾ç‰‡èµ„æºç±»å‹ | ç¼©ç•¥åå®½ | ç¼©ç•¥åé«˜ |
| ------------ | -------- | -------- |
| è¯„è®ºåŒºå›¾ç‰‡   | 200      | 200      |
| å¤´åƒ         | 120      | 120      |
| å°é¢         | 412      | 232      |

æ ¹æ®è¿™äº›å®½é«˜å®šä¹‰ä¸€ä¸ªç¼©ç•¥å›¾å°ºå¯¸çš„æšä¸¾ï¼š

```java
/**
 * ç¼©ç•¥å›¾å°ºå¯¸
 */
public enum ThumbnailSizeEnum {
    COMMENT_SIZE("comment", 200, 200, "è¯„è®ºç¼©ç•¥å›¾é»˜è®¤å°ºå¯¸"),
    AVATAR_SIZE("avatar", 120, 120, "å¤´åƒç¼©ç•¥å›¾é»˜è®¤å°ºå¯¸"),
    COVER_SIZE("cover", 412, 232, "å°é¢ç¼©ç•¥å›¾é»˜è®¤å°ºå¯¸");

    private String type;
    private Integer width;
    private Integer height;
    private String desc;

    ThumbnailSizeEnum(String type, Integer width, Integer height, String desc) {
        this.type = type;
        this.width = width;
        this.height = height;
        this.desc = desc;
    }

    public static ThumbnailSizeEnum getByType(String type) {
        ThumbnailSizeEnum[] values = ThumbnailSizeEnum.values();
        for (ThumbnailSizeEnum value : values) {
            if (Objects.equals(type, value.getType()))
                return value;
        }
        return null;
    }

    public String getType() {
        return type;
    }

    public Integer getWidth() {
        return width;
    }

    public Integer getHeight() {
        return height;
    }

    public String getDesc() {
        return desc;
    }
}
```

javaç”Ÿæˆç¼©ç•¥å›¾çš„å·¥å…·ç±»ï¼š

```java
package com.ling.utils;

import javax.imageio.ImageIO;
import java.awt.Graphics2D;
import java.awt.RenderingHints;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;

/**
 * ç¼©ç•¥å›¾å·¥å…·ç±»
 */
public class ThumbnailUtil {

    /**
     * æ ¹æ®æŒ‡å®šçš„å®½é«˜ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆæºå›¾ç‰‡ä¸º String è·¯å¾„ï¼‰
     *
     * @param srcPath  æºå›¾ç‰‡è·¯å¾„
     * @param destPath ç¼©ç•¥å›¾ä¿å­˜è·¯å¾„ï¼ˆæ–‡ä»¶åç¼€å†³å®šå›¾ç‰‡æ ¼å¼ï¼Œå¦‚ jpgã€png ç­‰ï¼‰
     * @param width    ç¼©ç•¥å›¾å®½åº¦
     * @param height   ç¼©ç•¥å›¾é«˜åº¦
     * @throws IOException å¦‚æœè¯»å–æˆ–å†™å…¥å›¾ç‰‡å‡ºé”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    public static void createThumbnail(String srcPath, String destPath, int width, int height) throws IOException {
        createThumbnail(new File(srcPath), destPath, width, height);
    }

    /**
     * æ ¹æ®æŒ‡å®šçš„å®½é«˜ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆæºå›¾ç‰‡ä¸º File å¯¹è±¡ï¼‰
     *
     * @param srcFile  æºå›¾ç‰‡æ–‡ä»¶
     * @param destPath ç¼©ç•¥å›¾ä¿å­˜è·¯å¾„ï¼ˆæ–‡ä»¶åç¼€å†³å®šå›¾ç‰‡æ ¼å¼ï¼Œå¦‚ jpgã€png ç­‰ï¼‰
     * @param width    ç¼©ç•¥å›¾å®½åº¦
     * @param height   ç¼©ç•¥å›¾é«˜åº¦
     * @throws IOException å¦‚æœè¯»å–æˆ–å†™å…¥å›¾ç‰‡å‡ºé”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    public static void createThumbnail(File srcFile, String destPath, int width, int height) throws IOException {
        BufferedImage srcImg = ImageIO.read(srcFile);
        if (srcImg == null) {
            throw new IOException("æ— æ³•è¯»å–æºå›¾ç‰‡ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®");
        }
        int originalWidth = srcImg.getWidth();
        int originalHeight = srcImg.getHeight();

        if (originalWidth <= width && originalHeight <= height) {
            ImageIO.write(srcImg, getFormatName(destPath), new File(destPath));
            return;
        }
        double scaleWidth = (double) width / originalWidth;
        double scaleHeight = (double) height / originalHeight;
        double scale = Math.min(scaleWidth, scaleHeight);
        int newWidth = (int) Math.round(originalWidth * scale);
        int newHeight = (int) Math.round(originalHeight * scale);
        createThumbnail(srcImg, destPath, newWidth, newHeight);
    }

    /**
     * æ ¹æ®ç¼©æ”¾æ¯”ä¾‹ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆä¿æŒåŸå›¾æ¯”ä¾‹ï¼Œæºå›¾ç‰‡ä¸º String è·¯å¾„ï¼‰
     *
     * @param srcPath  æºå›¾ç‰‡è·¯å¾„
     * @param destPath ç¼©ç•¥å›¾ä¿å­˜è·¯å¾„
     * @param scale    ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¾‹å¦‚ 0.5 è¡¨ç¤ºç¼©å° 50%ï¼‰
     * @throws IOException å¦‚æœè¯»å–æˆ–å†™å…¥å›¾ç‰‡å‡ºé”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    public static void createThumbnail(String srcPath, String destPath, double scale) throws IOException {
        createThumbnail(new File(srcPath), destPath, scale);
    }

    /**
     * æ ¹æ®ç¼©æ”¾æ¯”ä¾‹ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆä¿æŒåŸå›¾æ¯”ä¾‹ï¼Œæºå›¾ç‰‡ä¸º File å¯¹è±¡ï¼‰
     *
     * @param srcFile  æºå›¾ç‰‡æ–‡ä»¶
     * @param destPath ç¼©ç•¥å›¾ä¿å­˜è·¯å¾„
     * @param scale    ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¾‹å¦‚ 0.5 è¡¨ç¤ºç¼©å° 50%ï¼‰
     * @throws IOException å¦‚æœè¯»å–æˆ–å†™å…¥å›¾ç‰‡å‡ºé”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    public static void createThumbnail(File srcFile, String destPath, double scale) throws IOException {
        BufferedImage srcImg = ImageIO.read(srcFile);
        if (srcImg == null) {
            throw new IOException("æ— æ³•è¯»å–æºå›¾ç‰‡ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®");
        }
        int width = (int) (srcImg.getWidth() * scale);
        int height = (int) (srcImg.getHeight() * scale);
        createThumbnail(srcImg, destPath, width, height);
    }

    /**
     * æ ¹æ®æœ€å¤§å®½åº¦ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆä¿æŒåŸå›¾æ¯”ä¾‹ï¼Œæºå›¾ç‰‡ä¸º String è·¯å¾„ï¼‰
     * å¦‚æœåŸå›¾å®½åº¦å°äºç­‰äº maxWidthï¼Œåˆ™ç›´æ¥ä¿å­˜åŸå›¾
     *
     * @param srcPath  æºå›¾ç‰‡è·¯å¾„
     * @param destPath ç¼©ç•¥å›¾ä¿å­˜è·¯å¾„
     * @param maxWidth æœ€å¤§å®½åº¦
     * @throws IOException å¦‚æœè¯»å–æˆ–å†™å…¥å›¾ç‰‡å‡ºé”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    public static void createThumbnail(String srcPath, String destPath, int maxWidth) throws IOException {
        createThumbnail(new File(srcPath), destPath, maxWidth);
    }

    /**
     * æ ¹æ®æœ€å¤§å®½åº¦ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆä¿æŒåŸå›¾æ¯”ä¾‹ï¼Œæºå›¾ç‰‡ä¸º File å¯¹è±¡ï¼‰
     * å¦‚æœåŸå›¾å®½åº¦å°äºç­‰äº maxWidthï¼Œåˆ™ç›´æ¥ä¿å­˜åŸå›¾
     *
     * @param srcFile  æºå›¾ç‰‡æ–‡ä»¶
     * @param destPath ç¼©ç•¥å›¾ä¿å­˜è·¯å¾„
     * @param maxWidth æœ€å¤§å®½åº¦
     * @throws IOException å¦‚æœè¯»å–æˆ–å†™å…¥å›¾ç‰‡å‡ºé”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    public static void createThumbnail(File srcFile, String destPath, int maxWidth) throws IOException {
        BufferedImage srcImg = ImageIO.read(srcFile);
        if (srcImg == null) {
            throw new IOException("æ— æ³•è¯»å–æºå›¾ç‰‡ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®");
        }
        int originalWidth = srcImg.getWidth();
        int originalHeight = srcImg.getHeight();

        if (originalWidth <= maxWidth) {
            // å¦‚æœåŸå›¾å®½åº¦ä¸å¤§äº maxWidthï¼Œåˆ™ç›´æ¥å†™å…¥åŸå›¾
            ImageIO.write(srcImg, getFormatName(destPath), new File(destPath));
            return;
        }
        double scale = (double) maxWidth / originalWidth;
        int newWidth = maxWidth;
        int newHeight = (int) (originalHeight * scale);
        createThumbnail(srcImg, destPath, newWidth, newHeight);
    }

    /**
     * ç§æœ‰æ–¹æ³•ï¼Œæ ¹æ® BufferedImage ç”Ÿæˆç¼©ç•¥å›¾
     *
     * @param srcImg   æºå›¾ç‰‡å¯¹è±¡
     * @param destPath ç¼©ç•¥å›¾ä¿å­˜è·¯å¾„
     * @param width    ç¼©ç•¥å›¾å®½åº¦
     * @param height   ç¼©ç•¥å›¾é«˜åº¦
     * @throws IOException å¦‚æœå†™å…¥å›¾ç‰‡å‡ºé”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    private static void createThumbnail(BufferedImage srcImg, String destPath, int width, int height) throws IOException {
        BufferedImage destImg = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
        Graphics2D g2d = destImg.createGraphics();
        // è®¾ç½®é«˜è´¨é‡æ¸²æŸ“å‚æ•°
        g2d.setRenderingHint(RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR);
        g2d.setRenderingHint(RenderingHints.KEY_RENDERING, RenderingHints.VALUE_RENDER_QUALITY);
        g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
        // ç»˜åˆ¶ç¼©æ”¾åçš„å›¾åƒ
        g2d.drawImage(srcImg, 0, 0, width, height, null);
        g2d.dispose();
        String formatName = getFormatName(destPath);
        ImageIO.write(destImg, formatName, new File(destPath));
    }

    /**
     * ä»æ–‡ä»¶åä¸­è·å–å›¾ç‰‡æ ¼å¼
     *
     * @param filename æ–‡ä»¶å
     * @return å›¾ç‰‡æ ¼å¼ï¼ˆä¸å«ç‚¹å·ï¼‰ï¼Œå¦‚ "jpg" æˆ– "png"
     */
    private static String getFormatName(String filename) {
        int dotIndex = filename.lastIndexOf('.');
        if (dotIndex >= 0 && dotIndex < filename.length() - 1) {
            return filename.substring(dotIndex + 1);
        }
        return "jpg"; // é»˜è®¤æ ¼å¼
    }
}
```

ä¸ºäº†å’ŒåŸå›¾è¿›è¡ŒåŒºåˆ†ï¼Œä¹Ÿä¸ºäº†æ–¹ä¾¿è®¿é—®ï¼Œç”Ÿæˆçš„ç¼©ç•¥å›¾é‡‡ç”¨åŸå›¾å(æ— åç¼€)+`_t_n`çš„æ ¼å¼å‘½åï¼Œä¾‹å¦‚ï¼š

```swift
// åŸå›¾
example.jpg
// ç¼©ç•¥å›¾
example_t_n.jpg
```

tã€nä¸ºç¼©ç•¥å›¾Thumbnailçš„ç¼©å†™ã€‚åªè¦çŸ¥é“åŸå›¾è·¯å¾„ï¼Œé‚£ä¹ˆåªéœ€åŠ ä¸Š`_t_n`å°±èƒ½è®¿é—®åˆ°ç¼©ç•¥å›¾ã€‚

åœ¨ä¸Šä¼ å›¾ç‰‡çš„æ¥å£ä¸­å¢åŠ ä¸¤ä¸ªè¯·æ±‚å‚æ•°ã€wã€‘ã€ã€hã€‘æ¥è¡¨ç¤ºç¼©ç•¥ä¹‹åçš„å®½é«˜ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¸æ˜¯å¿…å¡«é¡¹ï¼Œå½“å®½é«˜ä¸ºç©ºæ—¶ï¼Œè®¾ç½®é»˜è®¤å®½é«˜ã€‚

å¢åŠ ç”Ÿæˆç¼©ç•¥å›¾çš„æ­¥éª¤ï¼š

```java
/**
     * å›¾ç‰‡ä¸Šä¼ æ¥å£
     *
     * @param imgFile
     * @return
     */
    @PostMapping("/upload/image/{imgDir:comment|avatar|cover}")
    @AccessControl(loginRequired = true)
    public Result<FileUploadVo> uploadImage(MultipartFile imgFile, @PathVariable String imgDir) {
        try {
            String filename = imgFile.getOriginalFilename();
            String suffix = StrUtil.getFilenameSuffix(filename);
            // åˆ¤æ–­å…è®¸ä¸Šä¼ çš„å›¾ç‰‡æ ¼å¼
            if (!webConfig.getAllowImgSuffixList().contains(suffix))
                throw new BusinessException(CommonMsg.UNSUPPORTED_IMAGE_FORMAT);
            String randomFilename = StrUtil.getUUID() + suffix;
            String dateDir = StrUtil.formatDate("yyyy-MM");
            String imgDirPath = getProjectImgDirPath(imgDir, dateDir);
            File dir = new File(imgDirPath);
            if (!dir.exists()) {
                dir.mkdirs();
            }
            File resourceImg = new File(dir, randomFilename);
            // å­˜å‚¨å›¾ç‰‡
            imgFile.transferTo(resourceImg);

            // ç¼©ç•¥å›¾å®½é«˜
            ThumbnailSizeEnum tSize = ThumbnailSizeEnum.getByType(imgDir);
            w = w == null ? tSize.getWidth() : w;
            h = h == null ? tSize.getHeight() : h;
            
            // ç”Ÿæˆç¼©ç•¥å›¾
            String destPath = imgDirPath + File.separatorChar + randomFilename.replace(".", "_t_n.");
            ThumbnailUtil.createThumbnail(resourceImg, destPath, w, h);

            FileUploadVo fileUploadVo = new FileUploadVo();
            fileUploadVo.setFileUrl(imgDir + "/" + dateDir + "/" + randomFilename);
            return Result.success(fileUploadVo);
        } catch (BusinessException e) {
            throw e;
        } catch (Exception e) {
            throw new BusinessException(CommonMsg.FILE_UPLOAD_FAIL);
        }
    }
```

---

## 1.5 ğŸŒå›¾ç‰‡è¯»å–æ¥å£

åœ°å€ï¼š

```swift
localhost:8091/web/file/read/{imgDir}/{dateDir}/{filename}
```

æ–¹å¼ï¼š

`GET`

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å   | ç±»å‹     | å¿…å¡«é¡¹ | è¯´æ˜       |
| -------- | -------- | ------ | ---------- |
| imgDir   | `string` | `true` | å›¾ç‰‡ç›®å½•   |
| dateDir  | `string` | `true` | æ—¥æœŸç›®å½•   |
| filename | `string` | `true` | å›¾ç‰‡æ–‡ä»¶å |

å“åº”ï¼š

```
ä»¥æµå½¢å¼è¿”å›
```

åŸºäºURLè·¯å¾„å‚æ•°è¯»å–å¹¶è¿”å›æŒ‡å®šå›¾ç‰‡ï¼Œç¡®ä¿è®¿é—®è·¯å¾„ä¸å­˜å‚¨è·¯å¾„ä¸€è‡´ã€‚

---

## 1.6 è¯»å–æ¥å£å®ç°

æ§åˆ¶å™¨ï¼š

è¯»å–çš„å›¾ç‰‡ç¼“å­˜3å¤©ã€‚

```java
/**
     * è¯»å–å›¾ç‰‡æ¥å£
     *
     * @param response
     * @param imgDir
     * @param dateDir
     * @param filename
     * @throws Exception
     */
    @GetMapping("/read/{imgDir}/{dateDir}/{filename}")
    public void readImg(HttpServletResponse response,
                        @PathVariable String imgDir, @PathVariable String dateDir, @PathVariable String filename) throws Exception {
        String imgDirPath = getProjectImgDirPath(imgDir, dateDir);
        File file = new File(imgDirPath, filename);
        if (!file.exists())
            throw new BusinessException(CommonMsg.FILE_NOT_FOUND);
        response.setContentType("image/" + StrUtil.getFilenameSuffixWithoutDot(filename));
        response.setHeader("Cache-Control", "max-age=259200");  // ç¼“å­˜3å¤©
        ByteArrayOutputStream aos = new ByteArrayOutputStream();
        try (OutputStream os = response.getOutputStream();
             InputStream is = new FileInputStream(file)) {
            IOUtils.copy(is, aos);
            response.setHeader("Content-Length", String.valueOf(aos.size()));
            os.write(aos.toByteArray());
        }
    }
```

