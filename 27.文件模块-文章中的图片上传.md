# 1 æ–‡ç« å›¾ç‰‡ä¸Šä¼ 

## 1.1 æ–‡ç« å›¾ç‰‡æœ‰æ•ˆæ€§é—®é¢˜

åœ¨ç³»ç»Ÿä¸­ï¼Œå›¾ç‰‡èµ„æºè¢«åˆ’åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼Œå®é™…ä¸Šï¼Œè¿˜å­˜åœ¨å¦ä¸€ç§ç‰¹æ®Šç±»å‹â€”â€”**æ–‡ç« å›¾ç‰‡**(ä»¥ä¸‹ç®€ç§°æ–‡å›¾)ï¼Œå³æ–‡ç« å†…å®¹ä¸­çš„æ’å›¾ã€‚

åœ¨æœåŠ¡å™¨ä¸Šçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```java
D:/ling-bbs-folder/web
    â”œâ”€â”€ article
        â”œâ”€â”€ 2023-08
        	â”œâ”€â”€ example.png
```

å…¶ä¸­ï¼Œ`article` ç›®å½•ä¸“é—¨ç”¨äºå­˜å‚¨æ–‡ç« ç›¸å…³çš„å›¾ç‰‡èµ„æºã€‚

ç”±äºæ–‡å›¾å…·æœ‰ç‹¬ç‰¹çš„ä¸šåŠ¡éœ€æ±‚ï¼Œç›´æ¥å¤ç”¨å›¾ç‰‡ä¸Šä¼ çš„æ¥å£å¹¶ä¸å¯è¡Œï¼Œä¸»è¦åŸå› å¦‚ä¸‹ï¼š

1ã€**æ— éœ€ç”Ÿæˆç¼©ç•¥å›¾**

æ–‡å›¾é€šå¸¸æ˜¯åŸå°ºå¯¸æ’å…¥æ–‡ç« å†…å®¹çš„ï¼Œä¸æ¶‰åŠç¼©ç•¥å›¾å±•ç¤ºï¼Œå› æ­¤æ— éœ€é¢å¤–çš„ç¼©ç•¥å›¾å¤„ç†é€»è¾‘ã€‚

2ã€**æ–‡å›¾çš„æœ‰æ•ˆæ€§é—®é¢˜**

æ–‡å›¾çš„ä¸Šä¼ æµç¨‹ä¸æ–‡ç« çš„ä¿å­˜æµç¨‹æ˜¯åˆ†å¼€çš„ã€‚ç”¨æˆ·åœ¨æ’°å†™æ–‡ç« æ—¶ï¼Œå¯ä»¥æå‰ä¸Šä¼ å¤šå¼ å›¾ç‰‡ï¼Œä½†æ–‡ç« å¹¶æœªçœŸæ­£æäº¤ä¿å­˜ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‘ç”Ÿä»¥ä¸‹é—®é¢˜ï¼š

- ç”¨æˆ·ä¸Šä¼ äº†å¤šå¼ å›¾ç‰‡ï¼Œä½†æœ€ç»ˆæœªæäº¤æ–‡ç« ï¼ˆå¦‚å–æ¶ˆç¼–è¾‘æˆ–å…³é—­ç¼–è¾‘é¡µé¢ï¼‰ã€‚
- è¿™äº›æœªè¢«æ–‡ç« å¼•ç”¨çš„å›¾ç‰‡ä»ç„¶å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šï¼Œå ç”¨å­˜å‚¨ç©ºé—´ï¼Œæˆä¸º**æ— æ•ˆå›¾ç‰‡**ã€‚

å¦‚æœä¸åŠ ä»¥æ§åˆ¶ï¼Œé•¿æœŸç§¯ç´¯çš„æ— æ•ˆå›¾ç‰‡ä¼šå¯¼è‡´å­˜å‚¨èµ„æºæµªè´¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æœºåˆ¶æ¥ç®¡ç†æ–‡å›¾çš„æœ‰æ•ˆæ€§ï¼Œç¡®ä¿åªæœ‰ä¸æ–‡ç« å…³è”çš„å›¾ç‰‡æ‰ä¼šè¢«ä¿ç•™ï¼Œæœªè¢«ä½¿ç”¨çš„å›¾ç‰‡èƒ½å¤ŸåŠæ—¶æ¸…ç†ã€‚åŸºäºè¿™äº›å·®å¼‚å°±ä¸èƒ½å¤ç”¨ä¹‹å‰çš„æ¥å£ï¼Œåªèƒ½é‡æ–°å®šä¹‰ã€‚

---



## 1.2 ç®¡ç†æœ‰æ•ˆæ€§è®¾è®¡æ€è·¯

ä¸ºäº†æœ‰æ•ˆç®¡ç†æ–‡å›¾çš„ä½¿ç”¨çŠ¶æ€ï¼Œå¹¶æ¸…ç†æœªè¢«ä½¿ç”¨çš„æ— æ•ˆå›¾ç‰‡ï¼Œæˆ‘ä»¬å¼•å…¥**æ–‡ä»¶ä½¿ç”¨è®°å½•è¡¨ï¼ˆfile_use_recordï¼‰**ï¼Œç”¨äºè¿½è¸ªå›¾ç‰‡çš„ä¸Šä¼ ä¸ä½¿ç”¨æƒ…å†µã€‚

è¡¨ç»“æ„å¦‚ä¸‹ï¼š

```sql
create table file_use_record
(
    record_id   varchar(50)  not null comment 'id',
    target_id   varchar(50)  null comment 'ç›®æ ‡id',
    uploader_id varchar(15)  not null comment 'ä¸Šä¼ äººid',
    filename    varchar(50)  null comment 'æ–‡ä»¶å',
    filepath    varchar(150) not null comment 'æ–‡ä»¶è·¯å¾„',
    status      tinyint      null comment '0: æœªä½¿ç”¨, 1: å·²ä½¿ç”¨ '
)
    comment 'æ–‡ä»¶ä½¿ç”¨è®°å½•';

create index file_use_record_target_id_index
    on file_use_record (target_id);
```

å…¶ä¸­ï¼š

- `status`ï¼šç”¨äºæ ‡è¯†å›¾ç‰‡çš„ä½¿ç”¨çŠ¶æ€ï¼Œ`0` ä»£è¡¨æœªä½¿ç”¨ï¼Œ`1` ä»£è¡¨å·²ä½¿ç”¨ã€‚

-  `target_id`ï¼šç”¨äºå­˜å‚¨å›¾ç‰‡çš„å½’å±ç›®æ ‡ã€‚åœ¨æ–‡å›¾åœºæ™¯ä¸‹ï¼Œ`target_id` ä»£è¡¨æ–‡ç«  IDã€‚ç„¶è€Œï¼Œä¸ºäº†æå‡é€šç”¨æ€§ï¼Œè¯¥å­—æ®µæœªå‘½åä¸º `article_id`ï¼Œä»¥ä¾¿æœªæ¥æ‰©å±•è‡³å…¶ä»–ä½¿ç”¨åœºæ™¯ï¼ˆå¦‚å¤´åƒã€è¯„è®ºå›¾ç‰‡ç­‰ï¼‰ã€‚

**å›¾ç‰‡ä¸Šä¼ ä¸ç®¡ç†æµç¨‹**

ä¸ºäº†ç¡®ä¿æ¯å¼ å›¾ç‰‡çš„ä½¿ç”¨çŠ¶æ€å¯è¿½è¸ªï¼Œæˆ‘ä»¬åœ¨ä¸Šä¼ æµç¨‹ä¸­å¼•å…¥ **`image-id` è¯·æ±‚å¤´**ï¼Œç”±æœåŠ¡å™¨ç”Ÿæˆå¹¶ç®¡ç†ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š

1. **é¦–æ¬¡ä¸Šä¼ **ï¼š

   - ç”¨æˆ·å‘æœåŠ¡å™¨ä¸Šä¼ å›¾ç‰‡ï¼Œ`image-id` ä¸ºç©ºã€‚
   - æœåŠ¡å™¨æ£€æµ‹åˆ° `image-id` ä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„å›¾ç‰‡ IDï¼Œå¹¶å°†å›¾ç‰‡ç›¸å…³ä¿¡æ¯å­˜å…¥ `file_use_record` è¡¨ï¼ŒåŒæ—¶è¿”å› `image-id` å’Œå›¾ç‰‡è®¿é—®è·¯å¾„ã€‚

2. **åç»­ä¸Šä¼ **ï¼š

   - ç”¨æˆ·åœ¨åŒä¸€ç¯‡æ–‡ç« çš„ç¼–è¾‘è¿‡ç¨‹ä¸­ï¼Œåç»­ä¸Šä¼ çš„å›¾ç‰‡è¯·æ±‚ä¼šæºå¸¦é¦–æ¬¡è¿”å›çš„ `image-id`ã€‚

   - æœåŠ¡å™¨æ ¹æ® `image-id` ç»§ç»­å­˜å‚¨æ–°ä¸Šä¼ çš„å›¾ç‰‡ï¼Œå¹¶è®°å½•å…¶ä¸ `image-id` çš„å…³è”å…³ç³»ã€‚
   - å› æ­¤ï¼ŒåŒä¸€ç¯‡æ–‡ç« ä¸‹çš„æ‰€æœ‰å›¾ç‰‡åœ¨ `file_use_record` ä¸­å…±äº«ç›¸åŒçš„ `image-id`ï¼Œç¡®ä¿å›¾ç‰‡å½’å±äºåŒä¸€ç¯‡æ–‡ç« ã€‚

**æ–‡ç« ä¿å­˜ä¸å›¾ç‰‡çŠ¶æ€æ›´æ–°**

- **ç”¨æˆ·æäº¤æ–‡ç« æ—¶**ï¼Œå‰ç«¯æ¥æ”¶åˆ°æ–‡ç« ä¿å­˜æˆåŠŸçš„å“åº”åï¼Œä¼šå‘é€ä¸€ä¸ªé¢å¤–çš„è¯·æ±‚ï¼Œå°† `image-id` ä¼ é€’ç»™æœåŠ¡å™¨ã€‚
- æœåŠ¡å™¨æ ¹æ® `image-id` æ›´æ–° `file_use_record` è¡¨ï¼Œå°†è¯¥ `image-id` å…³è”çš„æ‰€æœ‰å›¾ç‰‡çš„ `status` è®¾ç½®ä¸º `1`ï¼ˆå·²ä½¿ç”¨ï¼‰ï¼Œå¹¶å°† `target_id` æ›´æ–°ä¸ºæ–‡ç«  IDï¼Œå®Œæˆå›¾ç‰‡ä¸æ–‡ç« çš„æ­£å¼ç»‘å®šã€‚

**æ–‡ç« å®¡æ ¸ä¸å›¾ç‰‡çŠ¶æ€ç®¡ç†**

- **æ— éœ€å®¡æ ¸çš„æ–‡ç« **ï¼š

  - æ–‡ç« æäº¤å³å®¡æ ¸æˆåŠŸï¼Œä¸éœ€è¦é¢å¤–å¤„ç†ã€‚

  **éœ€è¦å®¡æ ¸çš„æ–‡ç« **ï¼š

  - **å®¡æ ¸é€šè¿‡**ï¼šå›¾ç‰‡çŠ¶æ€ä¿æŒä¸å˜ï¼Œæ— éœ€é¢å¤–æ“ä½œã€‚
  - **å®¡æ ¸å¤±è´¥**ï¼šæœåŠ¡å™¨ä¼šæ ¹æ® `target_id`ï¼ˆå³æ–‡ç«  IDï¼‰å°† `file_use_record` è¡¨ä¸­å¯¹åº”å›¾ç‰‡çš„ `status` é‡æ–°è®¾ä¸º `0`ï¼ˆæœªä½¿ç”¨ï¼‰ã€‚

**æ— æ•ˆå›¾ç‰‡æ¸…ç†æœºåˆ¶**

ä¸ºäº†é¿å…æœåŠ¡å™¨å­˜å‚¨ç©ºé—´æµªè´¹ï¼Œæˆ‘ä»¬å¼•å…¥**å®šæœŸæ¸…ç†ä»»åŠ¡**ï¼Œæ¸…é™¤é•¿æœŸæœªè¢«ä½¿ç”¨çš„å›¾ç‰‡ã€‚

- æ‰«æ `file_use_record` è¡¨ï¼ŒæŸ¥æ‰¾ `status = 0`ï¼ˆæœªä½¿ç”¨ï¼‰çš„å›¾ç‰‡ã€‚
- åˆ é™¤è¶…è¿‡è®¾å®šæ—¶é—´æœªè¢«ä½¿ç”¨çš„å›¾ç‰‡ï¼Œå¹¶ä»æ•°æ®åº“ä¸­ç§»é™¤å¯¹åº”è®°å½•ã€‚

---



# 2 æ”¹é€ å›¾ç‰‡ä¸Šä¼ æ¥å£

æˆ‘ä»¬å¼•å…¥å›¾ç‰‡ä¸Šä¼ çš„ä¸šåŠ¡å±‚`FileService`ï¼Œå°†ä¸Šä¼ çš„é€»è¾‘æå–åˆ°ä¸šåŠ¡å±‚ï¼Œæ–¹ä¾¿å›¾ç‰‡ä¸Šä¼ å’Œæ–‡å›¾ä¸Šä¼ è°ƒç”¨ã€‚

ä¸šåŠ¡å±‚ï¼š

```java
/**
     * å¤„ç†å›¾ç‰‡ä¸Šä¼ 
     *
     * @param imgFile
     * @param imgDir
     * @param w
     * @param h
     * @return
     */
    UploadResultVo processUploadImage(MultipartFile imgFile, String imgDir, Integer w, Integer h);

/**
     * å­˜å‚¨æ–‡ä»¶
     *
     * @param file     // æ–‡ä»¶
     * @param rTypeDir // èµ„æºç±»å‹ç›®å½•
     * @return
     * @throws Exception
     */
    UploadFileProp saveFile(MultipartFile file, String rTypeDir) throws Exception;

/**
     * è·å–æœåŠ¡å™¨èµ„æºè·¯å¾„
     *
     * @param rTypeDir èµ„æºç±»å‹ç›®å½•
     * @param dateDir  æ—¥æœŸç›®å½•
     * @return
     */
    String getSysResourceDirPath(String rTypeDir, String dateDir);
```

```java
@Override
    public UploadResultVo processUploadImage(MultipartFile imgFile, String imgDir, Integer w, Integer h) {
        try {
            UploadFileProp uploadFileProp = saveFile(imgFile, imgDir);
            String filepath = uploadFileProp.getFilepath();

            // ç”Ÿæˆç¼©ç•¥å›¾
            ThumbnailSizeEnum tSize = ThumbnailSizeEnum.getByType(imgDir);
            w = w == null ? tSize.getWidth() : w;
            h = h == null ? tSize.getHeight() : h;
            String destPath = filepath.replace(".", "_t_n.");
            ThumbnailUtil.createThumbnail(filepath, destPath, w, h);

            UploadResultVo uploadResultVo = new UploadResultVo();
            BeanUtils.copyProperties(uploadFileProp, uploadResultVo);

            return uploadResultVo;
        } catch (Exception e) {
            throw new BusinessException(CommonMsg.FILE_UPLOAD_FAIL, e);
        }
    }

/**
     * å­˜å‚¨æ–‡ä»¶
     *
     * @param file      // æ–‡ä»¶
     * @param rTypeDir  // èµ„æºç±»å‹ç›®å½•
     * @return 
     * @throws Exception
     */
    public UploadFileProp saveFile(MultipartFile file, String rTypeDir) throws Exception {
        String originalFilename = file.getOriginalFilename();
        String fileId = StrUtil.getUUID();
        String filename = fileId + StrUtil.getFilenameSuffix(originalFilename);
        String dateDir = StrUtil.formatDate("yyyy-MM");
        File dir = new File(getSysResourceDirPath(rTypeDir, dateDir));
        if (!dir.exists()) {
            dir.mkdirs();
        }
        File rFile = new File(dir, filename);
        // å­˜å‚¨å›¾ç‰‡
        file.transferTo(rFile);

        UploadFileProp uploadFileProp = new UploadFileProp();
        uploadFileProp.setFileId(fileId);
        uploadFileProp.setOriginalName(originalFilename);
        uploadFileProp.setFilepath(rFile.getAbsolutePath());
        uploadFileProp.setFileURL(rTypeDir + "/" + dateDir + "/" + filename);
        uploadFileProp.setFilesize(file.getSize());
        return uploadFileProp;
    }

    public String getSysResourceDirPath(String rTypeDir, String dateDir) {
        StringBuffer sb = new StringBuffer();
        return sb.append(webConfig.getProjectFolder())
                .append(File.separator)
                .append(rTypeDir)
                .append(File.separator)
                .append(dateDir)
                .toString();
    }
```

æå–å‡ºå…¬å…±çš„æ–¹æ³•`saveFile()`æ‰§è¡Œå­˜å‚¨æ“ä½œï¼Œè¿”å›`UploadFileProp`ï¼Œæ— è®ºæ˜¯å­˜å‚¨å›¾ç‰‡è¿˜æ˜¯å…¶ä»–æ–‡ä»¶éƒ½å¯ä»¥å¤ç”¨æ­¤æ–¹æ³•ã€‚

`UploadFileProp`æ˜¯ä¸Šä¼ å›¾ç‰‡å±æ€§ä¼ è¾“å®ä½“ï¼Œç”¨äºå­˜å‚¨å›¾ç‰‡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œç¡®ä¿ä¸Šä¼ æ–‡ä»¶çš„å±æ€§å¯è¿½æº¯ï¼š

```java
/**
 * ä¸Šä¼ æ–‡ä»¶å±æ€§ä¼ è¾“å¯¹è±¡
 */
public class UploadFileProp {
    private String fileId;      // æ–‡ä»¶id
    private String originalName;    // åŸå§‹æ–‡ä»¶å
    private String filepath;        // æ–‡ä»¶è·¯å¾„
    private String fileURL;         // æ–‡ä»¶URLè·¯å¾„
    private Long filesize;      // å¤§å°

    // getter && setter
}
```

æ§åˆ¶å™¨ï¼š

åŸæ¥çš„ä¸Šä¼ å›¾ç‰‡æ¥å£æ”¹ä¸ºè°ƒç”¨`processUploadImage()`:

```java
/**
     * å›¾ç‰‡ä¸Šä¼ æ¥å£
     *
     * @param imgFile
     * @return
     */
    @PostMapping("/upload/image/{imgDir:comment|avatar|cover}")
    @AccessControl(loginRequired = true)
    public Result<UploadResultVo> uploadImageHandle(MultipartFile imgFile, @PathVariable String imgDir, Integer w, Integer h) {
        checkAllowImgSuffix(imgFile.getOriginalFilename());
        UploadResultVo uploadResultVo = fileService.processUploadImage(imgFile, imgDir, w, h);
        return Result.success(uploadResultVo);
    }

/**
     * æ£€æŸ¥æ”¯æŒå›¾ç‰‡æ ¼å¼
     *
     * @param filename
     */
    private void checkAllowImgSuffix(String filename) {
        String suffix = StrUtil.getFilenameSuffix(filename);
        // åˆ¤æ–­å…è®¸ä¸Šä¼ çš„å›¾ç‰‡æ ¼å¼
        if (!webConfig.getAllowImgSuffixList().contains(suffix))
            throw new BusinessException(CommonMsg.UNSUPPORTED_IMAGE_FORMAT);
    }
```

---



# 3 æ–‡å›¾ä¸Šä¼ æ¥å£

## 3.1 ğŸŒæ¥å£è¯¦æƒ…

æ¥å£åœ°å€ï¼š

```swift
Post /web/file/upload/image/article
```

è¯·æ±‚å¤´ï¼š

| è¯·æ±‚å¤´   | å€¼                       |
| -------- | ------------------------ |
| image-id | `null` \| æœåŠ¡å™¨ç”Ÿæˆçš„id |

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å  | ç±»å‹   | å¿…å¡«é¡¹ | è¯´æ˜     |
| ------- | ------ | ------ | -------- |
| imgFile | `file` | `true` | æ–‡ç« å›¾ç‰‡ |

è¿”å›ç¤ºä¾‹ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "fileId": "64a4a683f352466b91749c772e01dfb5",
        "fileURL": "article/2025-02/64a4a683f352466b91749c772e01dfb5.png"
    }
}
```

---

## 3.2 æ¥å£å®ç°

ä¸šåŠ¡å±‚å¢åŠ å¤„ç†æ–‡å›¾ä¸Šä¼ çš„æ–¹æ³•ï¼š

```java
/**
     * å¤„ç†æ–‡ç« å›¾ç‰‡ä¸Šä¼ 
     *
     * @param imgFile
     * @param fileUseRecord
     * @return
     */
    UploadResultVo processArticleImageUpload(MultipartFile imgFile, FileUseRecord fileUseRecord);
```

```java
@Override
    public UploadResultVo processArticleImageUpload(MultipartFile imgFile, FileUseRecord fileUseRecord) {
        try {
            // æ‹¿åˆ°ç”Ÿæˆçš„å›¾ç‰‡id
            String recordId = fileUseRecord.getRecordId();
            if (!Objects.isNull(recordId)) {
                List<FileUseRecord> rList = fileUseRecordService
                        .findByIdAndUploaderId(recordId, fileUseRecord.getUploaderId());
                // æ ¡éªŒimage-idçš„æœ‰æ•ˆæ€§
                if (Objects.isNull(rList) || rList.isEmpty())
                    throw new BusinessException(CommonMsg.FILE_UPLOAD_FAIL);
            }

            // ä¸Šä¼ å›¾ç‰‡
            UploadFileProp uploadFileProp = saveFile(imgFile, "article");
			
            // å¦‚æœæœ‰image-idï¼Œåˆ™ä»¥æ­¤ä½œä¸ºè¡¨ä¸»é”®ï¼Œå¦åˆ™ä½¿ç”¨ç”Ÿæˆçš„å›¾ç‰‡id
            recordId = Objects.isNull(recordId) ? uploadFileProp.getFileId() : recordId;
            fileUseRecord.setRecordId(recordId);
            fileUseRecord.setFilename(uploadFileProp.getOriginalName());
            fileUseRecord.setFilepath(uploadFileProp.getFilepath());
            fileUseRecord.setStatus(UseStatusEnum.NOT_USE.getStatus().shortValue());
            fileUseRecordService.add(fileUseRecord);

            UploadResultVo uploadResultVo = new UploadResultVo();
            uploadResultVo.setFileId(recordId);
            uploadResultVo.setFileURL(uploadFileProp.getFileURL());
            return uploadResultVo;
        } catch (Exception e) {
            throw new BusinessException(CommonMsg.FILE_UPLOAD_FAIL, e);
        }
    }
```

`image-id`å¯èƒ½è¢«ä¼ªé€ ï¼Œæ‰€ä»¥è¦æ£€æŸ¥å…¶æœ‰æ•ˆæ€§ã€‚ç”±äº `image-id` æ˜¯å”¯ä¸€çš„ï¼Œä¸”ä¸åŒç”¨æˆ·ä¸ä¼šç”Ÿæˆç›¸åŒçš„ `image-id`ï¼Œé€šè¿‡ä¸Šä¼ äººidå’Œå›¾ç‰‡idæŸ¥è¯¢ï¼Œè‹¥æŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œåˆ™è¯´æ˜ `image-id` æ— æ•ˆï¼Œç›´æ¥æ‹’ç»ä¸Šä¼ ã€‚

éœ€è¦ä¿è¯ä»ç¬¬2æ¬¡å¼€å§‹çš„å›¾ç‰‡idä½¿ç”¨ç¬¬1æ¬¡ç”Ÿæˆçš„å›¾ç‰‡idï¼Œå¤ç”¨è¯·æ±‚å¤´ä¸­çš„ `image-id`ï¼Œç¡®ä¿åŒä¸€æ–‡ç« çš„æ‰€æœ‰å›¾ç‰‡ä½¿ç”¨ç›¸åŒçš„ `image-id`ï¼Œæ–¹ä¾¿åç»­ç®¡ç†ã€‚

æ§åˆ¶å™¨ï¼š

```java
/**
     * æ–‡ç« å›¾ç‰‡ä¸Šä¼ æ¥å£
     *
     * @param session
     * @param request
     * @param imgFile
     * @return
     */
    @PostMapping("/upload/image/article")
    @AccessControl(loginRequired = true)
    public Result<UploadResultVo> uploadArticleImgHandle(HttpSession session, HttpServletRequest request,
                                                         MultipartFile imgFile) {
        checkAllowImgSuffix(imgFile.getOriginalFilename());
        String imgId = request.getHeader(Constant.IMAGE_ID_HEADER);   // è¯·æ±‚å¤´è·å–å›¾ç‰‡id
        UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);

        FileUseRecord fileUseRecord = new FileUseRecord();
        fileUseRecord.setRecordId(imgId);
        fileUseRecord.setUploaderId(userinfo.getUserId());

        UploadResultVo uploadResultVo = fileService.processArticleImageUpload(imgFile, fileUseRecord);
        return Result.success(uploadResultVo);
    }
```

`UploadResultVo`ä¸ºä¸Šä¼ æ–‡ä»¶ç»“æœè§†å›¾å¯¹è±¡ï¼Œç”¨äºå‰ç«¯å±•ç¤ºï¼š

```java
/**
 * æ–‡ä»¶ä¸Šä¼ è¿”å›ç»“æœvo
 */
public class UploadResultVo {
    private String fileId;      // æ–‡ä»¶id
    private String fileURL;    // ä¸Šä¼ å®Œæˆè¿”å›çš„æ–‡ä»¶è·¯å¾„
    
    // getter && setter
}
```

---



# 4 æ›´æ–°å›¾ç‰‡ä¸ºå·²ä½¿ç”¨

## 4.1 ğŸŒæ¥å£è¯¦æƒ…

æ¥å£åœ°å€ï¼š

```swift
Put /web/file/used
```

è¯·æ±‚å¤´ï¼š

| è¯·æ±‚å¤´   | å€¼             |
| -------- | -------------- |
| image-id | æœåŠ¡å™¨ç”Ÿæˆçš„id |

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å   | ç±»å‹     | å¿…å¡«é¡¹ | è¯´æ˜   |
| -------- | -------- | ------ | ------ |
| targetId | `string` | `true` | ç›®æ ‡id |

è¿”å›ç¤ºä¾‹ï¼š

```java
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

---

## 4.2 æ¥å£å®ç°

å°†æ–‡ä»¶æ›´æ–°ä¸ºå·²ä½¿ç”¨çŠ¶æ€ï¼ŒåŒæ—¶æ›´æ–°æ–‡ä»¶çš„ç›®æ ‡idï¼Œè®©æ–‡ä»¶å’Œç›®æ ‡å»ºç«‹è”ç³»ï¼Œé€šè¿‡æ–‡ä»¶çš„idã€‚

`image-id`éœ€è¦æ ¡éªŒæœ‰æ•ˆæ€§ï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ï¼ŒåŒæ—¶è¦ç”¨æ ¡éªŒæ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·å‘é€çš„æ–‡ä»¶ï¼Œé˜²æ­¢é€ æˆè¯¯æ›´æ–°ã€‚

åœ¨`FileService`ä¸­å¢åŠ æ¥å£ï¼š

```java
/**
     * å˜æ›´æ–‡ç« ä½¿ç”¨çš„å›¾ç‰‡: å·²ä½¿ç”¨
     *
     * @param uploaderId
     * @param articleId
     * @param imageId
     */
    void processArticleImage2Used(String uploaderId, String articleId, String imageId);
```

å®ç°ï¼š

```java
@Override
    public void processArticleImage2Used(String uploaderId, String articleId, String imageId) {
        Article article = articleMapper.selectById(articleId);
        if (Objects.isNull(article))
            throw new BusinessException(ResponseCodeEnum.CODE_600);
        file2Used(uploaderId, articleId, imageId);
    }

    /**
     * æ›´æ–°æ–‡ä»¶: å·²ä½¿ç”¨
     *
     * @param uploaderId
     * @param targetId
     * @param imageId
     */
    private void file2Used(String uploaderId, String targetId, String imageId) {
        // æ ¡éªŒimage-idçš„æœ‰æ•ˆæ€§
        List<FileUseRecord> fileUseRecords = fileUseRecordService.findByIdAndUploaderId(imageId, uploaderId);
        if (Objects.isNull(fileUseRecords) || fileUseRecords.isEmpty())
            throw new BusinessException(CommonMsg.INVALID_IMAGE_ID);
        FileUseRecord fileUseRecord = new FileUseRecord();
        fileUseRecord.setRecordId(imageId);
        fileUseRecord.setStatus(UseStatusEnum.USE.getStatus().shortValue());
        fileUseRecord.setTargetId(targetId);

        fileUseRecordService.edit(fileUseRecord);
    }
```

æ›´æ–°çš„æ ¸å¿ƒé€»è¾‘æŠ½ç¦»å‡ºå•ç‹¬çš„æ–¹æ³•`file2Used()`,ç›®çš„æ˜¯æ–¹ä¾¿å¤ç”¨ã€‚å› ä¸ºç›®å‰åªè€ƒè™‘äº†æ–‡å›¾çš„ä½¿ç”¨çŠ¶æ€ï¼Œå¦‚æœä¸æŠ½ç¦»é‚£ä¹ˆå°±éœ€è¦åˆ¤æ–­`targetId`å¯¹åº”ç›®æ ‡æ˜¯å¦å­˜åœ¨ï¼Œä½†æ˜¯é™¤äº†æ–‡ç« å¤–ï¼Œå¯èƒ½è¿˜æœ‰å…¶ä»–ç›®æ ‡ï¼Œæ¯ä¸ªç›®æ ‡è°ƒç”¨è‡ªå·±çš„ä¸šåŠ¡å±‚æŸ¥è¯¢æ— æ³•åšåˆ°ç»Ÿä¸€ï¼Œåªèƒ½åœ¨å„è‡ªçš„æ–¹æ³•ä¸­è¿›è¡Œåˆ¤æ–­ï¼Œè€Œåç»­æ›´æ–°çš„é€»è¾‘æ˜¯ä¸€è‡´çš„ï¼Œå› æ­¤åšæŠ½ç¦»ã€‚

---



# 5 æ€»ç»“

åœ¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªç±»ä¼¼`UploadFileProp`çš„å®ä½“ç±»ï¼Œç”¨äºå°è£…å’Œè®°å½•ä¸Šä¼ æ–‡ä»¶çš„ç›¸å…³æ•°æ®ã€‚è¯¥å®ä½“ç±»å°†ä½œä¸ºä¸Šä¼ æ–‡ä»¶æ–¹æ³•çš„è¿”å›å€¼ï¼Œç¡®ä¿æ¯æ¬¡è°ƒç”¨ä¸Šä¼ æ–‡ä»¶æ–¹æ³•æ—¶ï¼Œéƒ½èƒ½è·å–åˆ°ä¸€ä¸ªåŒ…å«æ–‡ä»¶è¯¦ç»†ä¿¡æ¯çš„`UploadFileProp`å¯¹è±¡ã€‚ä¾¿æ·åœ°è®¿é—®æ–‡ä»¶æ•°æ®ï¼Œåªéœ€æ“ä½œ`UploadFileProp`å¯¹è±¡å³å¯ã€‚è¿™ç§å°è£…æ–¹å¼ä¸ä»…æå‡äº†ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œè¿˜ä¸ºåç»­çš„æ–‡ä»¶æ“ä½œæä¾›äº†æå¤§çš„ä¾¿åˆ©æ€§ï¼Œä½¿å¾—æ–‡ä»¶æ•°æ®çš„å¤„ç†æ›´åŠ é«˜æ•ˆå’Œçµæ´»ã€‚
