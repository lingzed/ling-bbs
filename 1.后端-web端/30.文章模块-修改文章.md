# 1 ä¿®æ”¹æ–‡ç« 

åœ¨æœ¬ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å…è®¸å¯¹æ–‡ç« çš„ä»¥ä¸‹å†…å®¹è¿›è¡Œä¿®æ”¹ï¼š

- æ ‡é¢˜
- å°é¢
- å†…å®¹
- æ‘˜è¦
- é™„ä»¶

æ–‡ç« çš„å†…å®¹ä¿®æ”¹ä¸é™„ä»¶çš„è°ƒæ•´å°†ä½œä¸ºä¸¤ä¸ªç‹¬ç«‹çš„æ“ä½œè¿›è¡Œç®¡ç†ï¼Œç”¨æˆ·å¯ä»¥å•ç‹¬æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åˆå¹¶æ“ä½œã€‚

æ–‡ç« ä¿®æ”¹åï¼Œæ–‡ç« çŠ¶æ€å°†è‡ªåŠ¨é‡ç½®ä¸ºâ€œå¾…å®¡æ ¸â€ï¼Œéœ€é‡æ–°å®¡æ ¸é€šè¿‡åæ–¹å¯å‘å¸ƒã€‚å¦‚æœä¿®æ”¹ç”±ç®¡ç†å‘˜ç›´æ¥æ“ä½œï¼Œæˆ–è€…ç³»ç»Ÿè®¾ç½®ä¸­æœªå¼€å¯æ–‡ç« å®¡æ ¸ï¼Œé‚£ä¹ˆæ–‡ç« çŠ¶æ€å°†ä¿æŒä¸ºâ€œå·²å®¡æ ¸â€ï¼Œæ— éœ€é‡æ–°å®¡æ ¸ã€‚å¯¹æ–‡ç« é™„ä»¶çš„è°ƒæ•´ä¸ä¼šå½±å“æ–‡ç« çš„å®¡æ ¸çŠ¶æ€ï¼Œå³æ–‡ç« ä»ç»´æŒåŸæœ‰çŠ¶æ€ï¼Œæ— éœ€é‡æ–°æäº¤å®¡æ ¸ã€‚

**é™„ä»¶æ›´æ–°**

æˆ‘ä»¬æä¾›ä»¥ä¸‹é™„ä»¶æ›´æ–°æ“ä½œï¼Œä»¥ä¾¿æ›´å¥½åœ°ç»´æŠ¤æ–‡ç« çš„é…å¥—èµ„æºï¼š

- è¡¥å……é™„ä»¶
- åˆ é™¤é™„ä»¶
- æ›´æ–°é™„ä»¶çš„ç§¯åˆ†

## 1.1 è¡¥å……é™„ä»¶

è¡¥å……é™„ä»¶çš„æ“ä½œé€‚ç”¨äºä»¥ä¸‹ä¸¤ç§åœºæ™¯ï¼š

- **æ–‡ç« å·²æœ‰é™„ä»¶**ï¼šç”¨æˆ·å¯¹æ–‡ç« çš„é™„ä»¶è¿›è¡Œè¡¥å……ï¼Œæ·»åŠ æ–°çš„é™„ä»¶ã€‚
- **æ–‡ç« æ— é™„ä»¶**ï¼šæ–‡ç« æœ€åˆæœªåŒ…å«ä»»ä½•é™„ä»¶ï¼Œç”¨æˆ·åç»­æ–°å¢é™„ä»¶ã€‚

å¦‚æœæ–‡ç« åŸæœ¬æ²¡æœ‰é™„ä»¶ï¼Œåœ¨è¡¥å……é™„ä»¶åï¼Œåº”å°†æ–‡ç« çš„é™„ä»¶çŠ¶æ€æ›´æ–°ä¸º **â€œæœ‰é™„ä»¶â€**ï¼Œç¡®ä¿ç³»ç»Ÿå¯¹æ–‡ç« é™„ä»¶çš„ç®¡ç†çŠ¶æ€ä¿æŒä¸€è‡´ã€‚

### 1.1.1 ğŸŒæ¥å£è¯¦æƒ…

è¯·æ±‚åœ°å€ï¼š

```HTTP
POST /web/article/{articleId}/attachment
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å     | ç±»å‹     | å¿…å¡«é¡¹ | è¯´æ˜   |
| - | -- |  |  |
| articleId  | `string` | `true` | æ–‡ç« id |
| attachment | `file`   | `true` | é™„ä»¶   |
| points     | `int`    | `true` | ç§¯åˆ†   |

è¿”å›ç¤ºä¾‹ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

### 1.1.2 æ¥å£å®ç°

åœ¨ `ArticleController` ä¸­å®šä¹‰ **è¡¥å……é™„ä»¶æ¥å£**ï¼Œå¹¶è°ƒç”¨ `ArticleService` å¤„ç†é™„ä»¶ä¸Šä¼ é€»è¾‘ï¼š

```java
/**
     * é™„ä»¶è¡¥å……æ¥å£
     *
     * @param session
     * @param articleId
     * @param attachmentUploadItem
     * @return
     */
    @PostMapping("/{articleId}/attachment")
    @AccessControl(loginRequired = true)
    public Result<Void> attachmentSupplementHandle(HttpSession session,
                                                   @PathVariable @Validation(max = 15) String articleId,
                                                   @Validation AttachmentUploadItem attachmentUploadItem) {
        checkAttachmentUploadItem(attachmentUploadItem);
        UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        articleService.processAttachmentSupplement(articleId, userinfo.getUserId(), attachmentUploadItem);
        return Result.success();
    }

// å¯¹é™„ä»¶è¿›è¡Œæ ¡éªŒ: æ–‡ä»¶æ ¼å¼ && å¤§å° && ç§¯åˆ†
    private void checkAttachmentUploadItem(AttachmentUploadItem item) {
        MultipartFile attachment = item.getAttachment();
        String suffix = StrUtil.getFilenameSuffix(attachment.getOriginalFilename());
        MIMETypeEnum mimeTypeEnum = MIMETypeEnum.getMIMEBySuffix(suffix);
        if (Objects.isNull(mimeTypeEnum))
            throw new BusinessException(CommonMsg.UNSUPPORTED_FILE_FORMAT);
        Integer allowSize = SysCacheUtil.getSysSettingManager().getSysSetting4Post().getAttachmentSize();
        double size = attachment.getSize() / (1024.0 * 1024.0);
        if (size > allowSize)
            throw new BusinessException(String.format(CommonMsg.FILE_TOO_LARGE, size, allowSize));
        if (item.getPoints() < 0)
            throw new BusinessException(ResponseCodeEnum.CODE_600);
        item.setMimeTypeEnum(mimeTypeEnum);    // æ ¡éªŒé€šè¿‡æ·»åŠ é™„ä»¶ç±»å‹
    }
```

`AttachmentUploadItem`ä¹‹å‰è¯´è¿‡äº†ï¼Œç”¨æ¥å°è£…`attachment`å’Œ`points`å‚æ•°ã€‚

è¯¥æ¥å£éœ€è¦æ ¡éªŒé™„ä»¶ï¼Œå› æ­¤æˆ‘å°†ä¹‹å‰å‘å¸ƒæ–‡ç« ä¸­å¤„ç†æ ¡éªŒçš„é€»è¾‘æŠ½ç¦»å‡ºæ¥å½¢æˆ`checkAttachmentUploadItem()`ã€‚

ç„¶ååœ¨ `ArticleService` ä¸­å®šä¹‰ **`processAttachmentSupplement()`** æ–¹æ³•ï¼Œè´Ÿè´£å¤„ç†é™„ä»¶è¡¥å……é€»è¾‘ã€‚

```java
/**
     * å¤„ç†é™„ä»¶è¡¥å……
     *
     * @param articleId
     * @param userId
     * @param attachmentUploadItem
     */
    void processAttachmentSupplement(String articleId, String userId, AttachmentUploadItem attachmentUploadItem);
```

å®ç°ï¼š

```java
@Override
    public void processAttachmentSupplement(String articleId, String userId, AttachmentUploadItem attachmentUploadItem) {
        Article article = articleMapper.selectById(articleId);
        if (Objects.isNull(article))
            throw new BusinessException(CommonMsg.ARTICLE_NOT_EXISTS);
        if (!Objects.equals(article.getUserId(), userId))
            throw new BusinessException(CommonMsg.FILE_UPLOAD_FAIL);
        Attachment attachment = saveAttachment(articleId, userId, attachmentUploadItem);
        // å¦‚æœæ²¡æœ‰é™„ä»¶ï¼Œæ›´æ–°ä¸ºæœ‰é™„ä»¶
        if (Objects.equals(AttachmentTypeEnum.NOT_ATTACHMENT.getType(), article.getAttachmentType())) {
            articleMapper.updateAttachmentType(articleId, AttachmentTypeEnum.HAVE_ATTACHMENT.getType());
        }
        attachmentMapper.insert(attachment);
    }
```

åœ¨æ–¹æ³•ä¸­æˆ‘ä»¬éœ€è¦æ ¡éªŒæ–‡ç« idæ˜¯å¦å­˜åœ¨ä»¥åŠä½œè€…æ˜¯å¦ä¸ºå½“å‰ä¸Šä¼ äººã€‚æ ¡éªŒé€šè¿‡åï¼Œè°ƒç”¨ `saveAttachment()` æ–¹æ³•å¤„ç†é™„ä»¶ä¸Šä¼ å’Œå­˜å‚¨é€»è¾‘ã€‚æœ€åï¼Œåœ¨æ’åº“ä¹‹å‰å…ˆåˆ¤æ–­æ–‡ç« ä¹‹å‰æ˜¯å¦å·²æœ‰é™„ä»¶ï¼Œå¦‚æœä¹‹å‰æ²¡æœ‰é‚£ä¹ˆæ›´æ–°æ–‡ç« ä¸º"æœ‰é™„ä»¶"ã€‚

æ›´æ–°æ–¹æ³•ä¸º`updateAttachmentType()`ï¼Œå…¶SQLå¦‚ä¸‹ï¼š

```xml
<!-- æ›´æ–°é™„ä»¶çŠ¶æ€ -->
<update id="updateAttachmentType">
    update article
    set attachment_type = #{attachmentType}
    where article_id = #{articleId}
</update>
```

## 1.2 é™„ä»¶åˆ é™¤

é™„ä»¶åˆ é™¤ä¹Ÿæ¶‰åŠä¸¤ç§åœºæ™¯ï¼š

- **åˆ é™¤åä»æœ‰é™„ä»¶**ï¼šä»…ç§»é™¤é€‰å®šçš„é™„ä»¶ï¼Œä¸å½±å“æ–‡ç« çš„é™„ä»¶çŠ¶æ€ã€‚
- **åˆ é™¤åæ— é™„ä»¶**ï¼šæ–‡ç« çš„æ‰€æœ‰é™„ä»¶è¢«åˆ é™¤ï¼Œæ–‡ç« çŠ¶æ€éœ€è¦æ›´æ–°ä¸º **â€œæ— é™„ä»¶â€**ã€‚

### 1.2.1 ğŸŒæ¥å£è¯¦æƒ…

è¯·æ±‚åœ°å€ï¼š

```http
DELETE /web/article/{articleId}/{attachmentIds}
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å        | ç±»å‹       | å¿…å¡«é¡¹ | è¯´æ˜       |
| - | - |  | - |
| articleId     | `string`   | `true` | æ–‡ç« id     |
| attachmentIds | `string[]` | `true` | é™„ä»¶idé›†åˆ |

è¿”å›ç¤ºä¾‹ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

### 1.2.2 æ¥å£å®ç°

åœ¨ `ArticleController` ä¸­å®šä¹‰ **åˆ é™¤é™„ä»¶æ¥å£**ï¼Œè°ƒç”¨ `ArticleService` å¤„ç†é™„ä»¶åˆ é™¤é€»è¾‘ï¼š

```java
/**
     * åˆ é™¤é™„ä»¶æ¥å£
     *
     * @param session
     * @param attachmentIds
     * @return
     */
    @DeleteMapping("/{articleId}/{attachmentIds}")
    @AccessControl(loginRequired = true)
    public Result<Void> attachmentDelHandle(HttpSession session,
                                            @PathVariable @Validation(max = 15) String articleId,
                                            @PathVariable List<String> attachmentIds) {
        UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        articleService.processAttachmentDel(userinfo.getUserId(), articleId, attachmentIds);
        return Result.success();
    }
```

åœ¨ `ArticleService` ä¸­å®šä¹‰ **`processAttachmentDel()`** æ–¹æ³•ï¼Œè´Ÿè´£å¤„ç†é™„ä»¶åˆ é™¤é€»è¾‘ï¼š

```java
/**
     * å¤„ç†é™„ä»¶åˆ é™¤
     *
     * @param userId
     * @param articleId
     * @param attachmentIds
     */
    void processAttachmentDel(String userId, String articleId, List<String> attachmentIds);
```

å®ç°ï¼š

```java
@Transactional(rollbackFor = Exception.class)
    public void processAttachmentDel(String userId, String articleId, List<String> attachmentIds) {
        List<Attachment> attachments = attachmentMapper.findByArticleIdAndUploaderAndAttachmentIds(articleId, userId,
                attachmentIds);
        if (Objects.isNull(attachments) || attachments.isEmpty())
            throw new BusinessException(ResponseCodeEnum.CODE_600);

        attachmentMapper.delete(attachmentIds);
        attachments.forEach(e -> {
            File file = new File(e.getFilepath());
            if (!file.exists()) log.error(CommonMsg.FILE_NOT_FOUND);
            file.delete();
        });

        List<Attachment> attachmentsList = attachmentMapper.selectByArticleId(articleId);
        if (attachmentsList.isEmpty()) {
            articleMapper.updateAttachmentType(articleId, AttachmentTypeEnum.NOT_ATTACHMENT.getType());
        }
    }
```

åœ¨æ‰§è¡Œé™„ä»¶åˆ é™¤æ“ä½œæ—¶ï¼Œéœ€è¦è¿›è¡Œæƒé™æ ¡éªŒï¼Œç¡®ä¿ä»…æ–‡ç« ä½œè€…æœ‰æƒåˆ é™¤é™„ä»¶ã€‚å› æ­¤éœ€è¦æ ¹æ®é™„ä»¶idå’Œä½œè€…æŸ¥è¯¢ï¼Œè‹¥æœ‰æ•°æ®åˆ™è¡¨ç¤ºé™„ä»¶idå’Œåˆ é™¤äººæ˜¯æ­£ç¡®çš„ã€‚åŒæ—¶è¿˜è¦æ ¡éªŒæ–‡ç«  ID çš„æœ‰æ•ˆæ€§ï¼Œä¸ä»…è¦ç¡®ä¿è¯¥æ–‡ç«  ID å­˜åœ¨ï¼Œè¿˜éœ€è¿›ä¸€æ­¥éªŒè¯å¾…åˆ é™¤çš„é™„ä»¶æ˜¯å¦ç¡®å®å½’å±äºè¯¥æ–‡ç« ã€‚å› ä¸ºå°½ç®¡æ–‡ç« å¯èƒ½å­˜åœ¨ï¼Œä½†å®ƒå¯èƒ½å±äºå…¶ä»–ç”¨æˆ·ï¼Œæˆ–è€…å³ä¾¿æ˜¯å½“å‰ç”¨æˆ·çš„æ–‡ç« ï¼Œä¹Ÿå¯èƒ½å¹¶éè¯¥é™„ä»¶æ‰€å±çš„æ–‡ç« ã€‚å¦‚æœåœ¨åˆ é™¤é™„ä»¶æ—¶æœªåŠ ä»¥ä¸¥æ ¼æ ¡éªŒï¼Œå¯èƒ½ä¼šå¯¼è‡´è¯¯æ“ä½œï¼Œå°†å…¶ä»–æ–‡ç« çš„é™„ä»¶çŠ¶æ€é”™è¯¯åœ°æ›´æ–°ä¸ºâ€œæ— é™„ä»¶â€ï¼Œè€Œéä»…é’ˆå¯¹å½“å‰é™„ä»¶æ‰€å±çš„æ–‡ç« è¿›è¡Œæ›´æ–°ã€‚

æ‰€ä»¥æˆ‘ä»¬é€šè¿‡æ–‡ç« idã€ä¸Šä¼ äººidå’Œé™„ä»¶idé›†è¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢SQLå¦‚ä¸‹ï¼š

```xml
<!-- é€šè¿‡ æ–‡ç« id && ä¸Šä¼ äºº && é™„ä»¶idé›† æŸ¥è¯¢ -->
<select id="findByArticleIdAndUploaderAndAttachmentIds" resultType="com.ling.entity.po.Attachment">
    select
    <include refid="commonField"/>
    from attachment where article_id = #{articleId} and user_id = #{userId} and file_id in
    <foreach collection="list" item="attachmentId" separator="," open="(" close=")">
        #{attachmentId}
    </foreach>
</select>
```

æ ¡éªŒé€šè¿‡åæ‰§è¡Œåˆ é™¤æ“ä½œï¼Œåˆ é™¤æ•°æ®åº“ä¸­å­˜å‚¨çš„é™„ä»¶ä¿¡æ¯ã€‚éå†é™„ä»¶åˆ—è¡¨ï¼Œåˆ é™¤ç‰©ç†æ–‡ä»¶ï¼Œå¹¶è®°å½•æ—¥å¿—ï¼ˆè‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼‰ã€‚æœ€åï¼ŒæŸ¥è¯¢æ–‡ç« çš„å‰©ä½™é™„ä»¶æ•°é‡ï¼Œè‹¥å·²æ— é™„ä»¶ï¼Œåˆ™æ›´æ–°æ–‡ç« ä¸º **â€œæ— é™„ä»¶â€**ã€‚

## 1.3 æ›´æ–°é™„ä»¶ç§¯åˆ†

### 1.3.1 ğŸŒæ¥å£è¯¦æƒ…

è¯·æ±‚åœ°å€ï¼š

```http
PUT /web/article/{attachmentId}/points
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å       | ç±»å‹     | å¿…å¡«é¡¹ | è¯´æ˜   |
| ------------ | -------- | ------ | ------ |
| attachmentId | `string` | `true` | é™„ä»¶id |
| points       | `int`    | `true` | ç§¯åˆ†   |

è¿”å›ç¤ºä¾‹ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

### 1.3.2 æ¥å£å®ç°

åœ¨ `ArticleController` ä¸­æ–°å¢ **`attachmentEditPointsHandle()`** æ–¹æ³•ï¼Œè´Ÿè´£æ¥æ”¶è¯·æ±‚å¹¶è°ƒç”¨ `ArticleService` å¤„ç†é™„ä»¶ç§¯åˆ†æ›´æ–°é€»è¾‘ï¼š

```java
/**
     * æ›´æ–°é™„ä»¶ç§¯åˆ†æ¥å£
     *
     * @param session
     * @param attachmentId
     * @return
     */
    @PutMapping("/{attachmentId}/points")
    @AccessControl(loginRequired = true)
    public Result<Void> attachmentEditPointsHandle(HttpSession session,
                                                   @PathVariable @Validation String attachmentId,
                                                   @Validation Integer points) {
        UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        Attachment attachment = new Attachment();
        attachment.setFileId(attachmentId);
        attachment.setDownloadPoints(points);
        articleService.processEditAttachmentPoints(userinfo, attachment);
        return Result.success();
    }
```

åœ¨ `ArticleService` ä¸­æ–°å¢ `processEditAttachmentPoints()` æ–¹æ³•ï¼Œä¸“é—¨ç”¨äºå¤„ç†é™„ä»¶ç§¯åˆ†æ›´æ–°é€»è¾‘ï¼š

```java
/**
     * å¤„ç†é™„ä»¶ç§¯åˆ†æ›´æ–°
     *
     * @param attachment
     */
    void processEditAttachmentPoints(UserInfoSessionDto userinfo, Attachment attachment);
```

å®ç°ï¼š

```java
/**
     * å¤„ç†é™„ä»¶ç§¯åˆ†æ›´æ–°
     *
     * @param attachment
     */
    public void processEditAttachmentPoints(UserInfoSessionDto userinfo, Attachment attachment) {
        Attachment attachmentById = attachmentMapper.selectById(attachment.getFileId());
        if (Objects.isNull(attachmentById))
            throw new BusinessException(CommonMsg.FILE_NOT_FOUND);
        if (!Objects.equals(attachmentById.getUserId(), userinfo.getUserId()))
            throw new BusinessException(CommonMsg.POINTS_OPERATION_FAIL);
        // æ›´æ–°å‰åç§¯åˆ†ç›¸åŒï¼Œä¸ç”¨å¤„ç†ï¼Œç›´æ¥è¿”å›
        if (Objects.equals(attachment.getDownloadPoints(), attachment.getDownloadPoints())) return;
        attachmentMapper.update(attachment);
    }
```

åœ¨æ‰§è¡Œé™„ä»¶ç§¯åˆ†æ›´æ–°æ“ä½œæ—¶ï¼Œä¹Ÿéœ€è¦è¿›è¡Œæƒé™æ ¡éªŒï¼Œç¡®ä¿ä»…æ–‡ç« ä½œè€…èƒ½æ›´æ–°ç§¯åˆ†ã€‚æˆ‘ä»¬é€šè¿‡idæŸ¥è¯¢å‡ºé™„ä»¶ï¼Œå…ˆåˆ¤æ–­é™„ä»¶idæ˜¯å¦æ­£ç¡®ï¼Œç„¶åå†åˆ¤æ–­ä½œè€…æ˜¯ä¸æ˜¯æœ¬äººã€‚æœ€åæ›´æ–°æ•°æ®ã€‚

> è‹¥æ›´æ–°å‰åçš„ç§¯åˆ†å€¼ç›¸åŒï¼Œåˆ™æ— éœ€æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œç›´æ¥è¿”å›ï¼Œä»¥æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚

## 1.4 ä¿®æ”¹æ–‡ç« å†…å®¹

### 1.4.1 ğŸŒæ¥å£è¯¦æƒ…

è¯·æ±‚åœ°å€ï¼š

```http
PUT /web/article/{articleId}
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å    | ç±»å‹     | å¿…å¡«é¡¹  | è¯´æ˜                 |
| --------- | -------- | ------- | -------------------- |
| title     | `string` | `true`  | æ–‡ç« å›¾ç‰‡             |
| cover     | `string` | `false` | å°é¢                 |
| content   | `string` | `true`  | æ–‡ç« å†…å®¹HTMLæ ¼å¼     |
| mdContent | `string` | `false` | æ–‡ç« å†…å®¹Markdownæ ¼å¼ |
| summary   | `string` | `false` | æè¿°                 |

è¿”å›ç¤ºä¾‹ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "articleId": "000981283431340"
    }
}
```

### 1.4.2 æ¥å£å®ç°

åœ¨`ArticleController`ä¸­å®šä¹‰æ¥å£ï¼Œæ›´æ–°æˆåŠŸåè¿”å›æ–‡ç« idï¼š

```java
/**
     * ä¿®æ”¹æ–‡ç« 
     *
     * @param session
     * @param articleId
     * @param title
     * @param cover
     * @param content
     * @param mdContent
     * @param summary
     * @return
     */
    @PutMapping("/{articleId}")
    @AccessControl(loginRequired = true)
    public Result<Map<String, String>> editArticleHandle(HttpSession session,
                                                         @PathVariable @Validation(max = 15) String articleId,
                                                         @Validation(required = false, max = 50) String title,
                                                         String cover,
                                                         @Validation String content,
                                                         String mdContent,
                                                         @Validation(required = false, max = 200) String summary) {
        UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);

        Article editArticle = new Article();
        editArticle.setArticleId(articleId);
        editArticle.setTitle(title);
        editArticle.setCover(cover);
        editArticle.setContent(content);
        editArticle.setMdContent(mdContent);
        editArticle.setSummary(summary);
        editArticle.setUserIdAddress(userinfo.getProvince());   // ä½œè€…çš„ipåœ°å€å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–
        boolean postAudit = SysCacheUtil.getSysSettingManager().getSysSetting4Audit().isPostAudit();
        // ç®¡ç†å‘˜ä¿®æ”¹ç›´æ¥å·²å®¡æ ¸ï¼Œå¦åˆ™è‹¥æœªå¼€å¯å®¡æ ¸åˆ™ä¸ºå·²å®¡æ ¸ï¼Œå·²å¼€å¯ä¸ºå¾…å®¡æ ¸
        TargetStatusEnum statusEnum = userinfo.getIsAdmin()
                ? TargetStatusEnum.AUDITED
                : postAudit ? TargetStatusEnum.PENDING : TargetStatusEnum.AUDITED;
        editArticle.setStatus(statusEnum.getStatus());
        editArticle.setUpdateTime(new Date());

        articleService.processAttachmentEdit(userinfo, editArticle);    // ä¿®æ”¹æ–‡ç« çš„æ“ä½œ
        Map<String, String> res = new HashMap<>();
        res.put("articleId", articleId);
        return Result.success(res);
    }
```

æ„å»º`Article`ç„¶åè°ƒç”¨`processAttachmentEdit()`å¤„ç†æ–‡ç« ç¼–è¾‘çš„æ“ä½œã€‚æ³¨æ„ï¼Œåœ¨æ„å»º`Article`æ—¶ï¼Œè¦ç»“åˆå®¡æ ¸å¼€å…³å’Œæ˜¯å¦ä¸ºç®¡ç†å‘˜æ¥åŠ¨æ€è®¾ç½®çŠ¶æ€ã€‚

ç„¶ååœ¨`ArticleService`ä¸­å®šä¹‰æ–‡ç« ä¿®æ”¹å¤„ç†æ–¹æ³•ï¼š

```java
/**
     * å¤„ç†æ–‡ç« ç¼–è¾‘(æœªåŒ…æ‹¬é™„ä»¶)
     *
     * @param userinfo
     * @param article
     * @return
     */
    void processAttachmentEdit(UserInfoSessionDto userinfo, Article article);
```

å®ç°ï¼š

```java
/**
     * å¤„ç†æ–‡ç« ç¼–è¾‘(æœªåŒ…æ‹¬é™„ä»¶)
     *
     * @param userinfo
     * @param editArticle
     */
    @Override
    public void processAttachmentEdit(UserInfoSessionDto userinfo, Article editArticle) {
        Article article = articleMapper.selectById(editArticle.getArticleId());
        if (Objects.isNull(article))
            throw new BusinessException(ResponseCodeEnum.CODE_600);
        if (!Objects.equals(article.getUserId(), userinfo.getUserId()))
            throw new BusinessException(CommonMsg.UNAUTHORIZED_ACCESS);

        // å¦‚æœæ˜¯Markdownç¼–è¾‘å™¨ï¼Œä½†æ²¡æœ‰Markdownå†…å®¹ï¼ŒæŠ›å‡ºå¼‚å¸¸
        boolean isMdEdit = Objects.equals(EditorTypeEnum.MD_EDITOR.getType(), article.getEditorType());
        boolean notMdContent = StrUtil.isEmpty(editArticle.getMdContent());
        if (isMdEdit && notMdContent)
            throw new BusinessException(ResponseCodeEnum.CODE_600);

        edit(editArticle);
    }
```

åœ¨æ–¹æ³•ä¸­éœ€è¦æ ¡éªŒæƒé™ï¼Œä»…ä½œè€…èƒ½ä¿®æ”¹è‡ªå·±çš„æ–‡ç« ã€‚åŒæ—¶è¿˜è¦å¯¹ç¼–è¾‘å™¨è¿›è¡Œåˆ¤æ–­ï¼Œå› ä¸ºç”¨Markdownç¼–è¾‘å™¨ç¼–è¾‘çš„æ–‡ç« è¦æ±‚`MdContent`ä¸èƒ½ä¸ºç©ºï¼Œé˜²æ­¢ç»•è¿‡å‰ç«¯æ ¡éªŒç›´æ¥æäº¤ç©ºå†…å®¹ã€‚æ ¡éªŒé€šè¿‡åï¼Œæ›´æ–°æ–‡ç« çš„æ•°æ®ã€‚



