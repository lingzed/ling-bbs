# 1 æ–‡ç« è¡¨

è¡¨ç»“æ„å¦‚ä¸‹ï¼š

```sql
create table article
(
    article_id      varchar(15)       not null comment 'æ–‡ç« id'
        primary key,
    board_id        int               not null comment 'æ¿å—id',
    board_name      varchar(50)       not null comment 'æ¿å—åç§°',
    p_board_id      int               null comment 'çˆ¶çº§æ¿å—id',
    p_board_name    varchar(50)       null comment 'çˆ¶çº§æ¿å—åç§°',
    user_id         varchar(15)       not null comment 'ç”¨æˆ·id',
    nick_name       varchar(20)       not null comment 'æ˜µç§°',
    user_id_address varchar(100)      not null comment 'æœ€åç™»å½•ipåœ°å€',
    title           varchar(150)      not null comment 'æ–‡ç« æ ‡é¢˜',
    cover           varchar(100)      null comment 'æ–‡ç« å°é¢',
    content         text              null comment 'å†…å®¹',
    md_content      text              null comment 'markdownæ ¼å¼çš„å†…å®¹',
    editor_type     tinyint           null comment 'æ–‡ç« ç¼–è¾‘å™¨ç±»å‹, 0: å¯Œæ–‡æœ¬ç¼–è¾‘å™¨, 1: markdownç¼–è¾‘å™¨',
    summary         varchar(200)      null comment 'æ‘˜è¦',
    read_count      int     default 0 not null comment 'æµè§ˆé‡',
    like_count      int     default 0 not null comment 'ç‚¹èµé‡',
    comment_count   int     default 0 not null comment 'è¯„è®ºæ•°é‡',
    top_type        tinyint default 0 not null comment '0: æœªç½®é¡¶, 1: å·²ç½®é¡¶',
    attachment_type tinyint default 0 not null comment '0: æ²¡æœ‰é™„ä»¶, 1: æœ‰é™„ä»¶',
    status          tinyint default 1 not null comment '0: å·²åˆ é™¤, 1: å¾…å®¡æ ¸, 2: å·²å®¡æ ¸',
    create_time     datetime          not null comment 'åˆ›å»º/å‘å¸ƒæ—¶é—´',
    update_time     datetime          not null comment 'ç¼–è¾‘æ—¶é—´'
)
    comment 'æ–‡ç« è¡¨';

create index article_idx_board_id
    on article (board_id);

create index article_idx_create_time
    on article (create_time);

create index article_idx_p_board_id
    on article (p_board_id);

create index article_idx_title
    on article (title);

create index article_idx_top_type
    on article (top_type);

create index article_idx_user_id
    on article (user_id);
```

è¿™å¼ è¡¨ä¸­å†—ä½™äº†`user_info`è¡¨å’Œ`forum_board`è¡¨çš„ä¸€äº›å­—æ®µï¼Œæ˜¯ä¸ºäº†å‡å°‘è”æŸ¥ï¼Œä¿è¯æŸ¥è¯¢é€Ÿåº¦ã€‚ä¹Ÿå› æ­¤ï¼Œåœ¨æ›´æ–°`user_info`æˆ–è€…`forum_board`æ—¶ï¼Œ`article`è¡¨ä¹Ÿè¦å¯¹åº”æ›´æ–°ã€‚

è¡¨ä¸­`content`å’Œ`md_content`å­—æ®µæ˜¯ç”¨æ¥å­˜å‚¨æ–‡ç« å†…å®¹çš„ï¼Œç¬¬ä¸€ä¸ªå­˜å‚¨HTMLæ ¼å¼çš„å†…å®¹ï¼Œå¦ä¸€ä¸ªå­˜å‚¨markdownæ ¼å¼çš„å†…å®¹ã€‚

å­—æ®µçš„å…¶ä»–ç»†èŠ‚ï¼Œä¸‹é¢ç»“åˆåŠŸèƒ½å®ç°è¯´æ˜ã€‚

---



# 2 æŸ¥è¯¢æ–‡ç« åˆ—è¡¨

## 2.1 æ–‡ç« æŸ¥è¯¢DTO

ä¸»è¦é€šè¿‡ä»¥ä¸‹å‡ ä¸ªå­—æ®µæŸ¥è¯¢ï¼š

```java
package com.ling.entity.dto;

import java.util.Date;

/**
 * æ–‡ç« æŸ¥è¯¢DTO
 */
public class ArticleQueryDto extends BaseQueryDto {
    private String title;
    private Integer boardId;
    private Integer pBoardId;
    private Integer status;
    private String orderBy;
    private String userId;

    // getter && setter
}
```

`status`å­—æ®µçœ‹æƒ…å†µï¼Œæ˜¯å¦é€šè¿‡`status`æŸ¥è¯¢æ–‡ç« çœ‹éœ€æ±‚ã€‚å¦å¤–è¡¨ä¸­åˆ›å»ºäº†è¿™äº›å­—æ®µçš„ç´¢å¼•ï¼Œå¢åŠ æŸ¥è¯¢é€Ÿåº¦ï¼š

![image-20250106163047869](assets/image-20250106163047869.png)

## 2.2 ArticleVo

å±•ç¤ºç»™å‰ç«¯çš„VOï¼Œæœ‰äº›å­—æ®µä¸éœ€è¦å±•ç¤ºç»™ç”¨æˆ·ï¼š

```java
package com.ling.entity.vo;

import com.fasterxml.jackson.annotation.JsonFormat;

import java.util.Date;

public class ArticleVo {
    private String articleId; //æ–‡ç« id
    private Integer boardId; //æ¿å—id
    private String boardName; //æ¿å—åç§°
    private Integer pBoardId; //çˆ¶æ¿å—id
    private String pBoardName; //çˆ¶æ¿å—åç§°
    private String userId; //ç”¨æˆ·id
    private String nickName; //ç”¨æˆ·æ˜µç§°
    private String userIdAddress; //ç”¨æˆ·åœ°å€
    private String title; //æ ‡é¢˜
    private String cover; //å°é¢å›¾
    private String content; //å†…å®¹
    private String mdContent; //markdownå†…å®¹
    private Integer editorType; //ç¼–è¾‘å™¨ç±»å‹, 0: å¯Œæ–‡æœ¬ç¼–è¾‘å™¨, 1: markdownç¼–è¾‘å™¨
    private String summary; //æ‘˜è¦
    private Integer readCount; //é˜…è¯»æ•°
    private Integer likeCount; //ç‚¹èµæ•°
    private Integer CommentCount; //è¯„è®ºæ•°
    private Integer topType; //ç½®é¡¶ç±»å‹, 0: æœªç½®é¡¶, 1: å·²ç½®é¡¶
    private Integer attachmentType; //é™„ä»¶ç±»å‹, 0: æ²¡æœ‰é™„ä»¶, 1: æœ‰é™„ä»¶
    private Integer status; //çŠ¶æ€, 0: å·²åˆ é™¤, 1: å¾…å®¡æ ¸, 2: å·²å®¡æ ¸
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private Date createTime; //åˆ›å»ºæ—¶é—´

    // getter && setter
}
```

## 2.3 æ’åºæŸ¥è¯¢çš„å®ç°æ€è·¯

å‰ç«¯é¡µé¢ä¸­æœ‰3ä¸ªæ’åºé€‰é¡¹ï¼š

- çƒ­æ¦œ
- å‘å¸ƒæ—¶é—´
- æœ€æ–°

å¦‚ä¸‹å›¾ï¼š

![image-20250103211945895](assets/image-20250103211945895.png)

æ–‡ç« åˆ—è¡¨æ”¯æŒè¿™ä¸‰ç§æ’åºæ–¹å¼ï¼Œæ ¹æ®è§„åˆ™è°ƒæ•´æ–‡ç« æ’åˆ—é¡ºåºï¼ˆå¦‚çƒ­åº¦ã€å‘å¸ƒæ—¶é—´ç­‰ï¼‰ã€‚æ’åºé€šè¿‡`order by` è¯­å¥å®ç°ï¼Œåœ¨ `ArticleQueryDto` ä¸­ï¼Œå­—æ®µ`orderBy` è¡¨ç¤ºæŸ¥è¯¢æ’åºè§„åˆ™ã€‚`orderBy` æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºä¼ é€’ SQL çš„`order by` è¯­å¥ã€‚æ’åºçš„å…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š

**1. çƒ­æ¦œ**

çƒ­æ¦œæ ¹æ®ç½®é¡¶ã€è¯„è®ºæ•°ã€ç‚¹èµæ•°ã€æµè§ˆæ•°å€’åºæ’åˆ—ï¼ŒSQL å¦‚ä¸‹ï¼š

```sql
order by top_type desc, comment_count desc, like_count desc, read_count desc
```

**2. å‘å¸ƒæ—¶é—´**

æŒ‰ç…§æ–‡ç« å‘å¸ƒæ—¶é—´æ­£åºæ’åˆ—ï¼š

```sql
order by create_time
```

**3. æœ€æ–°**

æŒ‰ç…§æ–‡ç« å‘å¸ƒæ—¶é—´å€’åºæ’åˆ—ï¼š

```sql
order by create_time desc
```

å‰ç«¯é€šè¿‡å‚æ•°ä¼ é€’æ’åºç±»å‹ï¼Œåç«¯æ ¹æ®å‚æ•°åŠ¨æ€ç”Ÿæˆå¯¹åº”çš„`order by` è¯­å¥ï¼Œæ„å»º SQLï¼Œå®ç°æ–‡ç« åˆ—è¡¨çš„åŠ¨æ€æ’åºï¼Œä¾‹å¦‚ï¼š

```xml
<select>
    <if test="orderBy != null and orderBy != ''">
        order by ${orderBy}
    </if>
</select>
```

æˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªæšä¸¾ï¼Œæ¥è¡¨ç¤ºè¿™3ç§æ’åºè§„åˆ™ï¼š

```java
package com.ling.enums;

/**
 * æ–‡ç« æ’åºæšä¸¾ç±»
 */
public enum ArticleOrderEnum {
    HOT(0, "top_type desc, comment_count desc, like_count desc, read_count desc", "çƒ­æ¦œ"),
    POST_TIME(1, "create_time", "å‘å¸ƒæ—¶é—´"),
    NEW(2, "create_time desc", "æœ€æ–°");

    private Integer orderType;
    private String orderBySql;
    private String desc;

    ArticleOrderEnum(Integer orderType, String orderBySql, String desc) {
        this.orderType = orderType;
        this.orderBySql = orderBySql;
        this.desc = desc;
    }

    public static ArticleOrderEnum getArticleOrderEnum(Integer orderType) {
        for (ArticleOrderEnum value : ArticleOrderEnum.values()) {
            if (orderType.equals(value.getOrderType())) {
                return value;
            }
        }
        return null;
    }

    // getter
}
```

æ ¹æ®å‰ç«¯ä¼ é€’çš„æ’åºç±»å‹å‚æ•°ä¾‹å¦‚`orderType`ï¼Œè·å–å¯¹åº”çš„æ’åºsqlï¼Œç„¶åå­˜å…¥æŸ¥è¯¢Dtoä¸­è¿›è¡Œä¼ é€’ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š

```java
{
    ArticleQueryDto articleQueryDto = new ArticleQueryDto();
    // orderType=0 | 1 | 2, é€šè¿‡orderTypeæ‹¿åˆ°å¯¹åº”æšä¸¾
	ArticleOrderEnum articleOrder = ArticleOrderEnum.getArticleOrderEnum(orderType);
    // è·å–æšä¸¾å¯¹åº”çš„order by sqlè¯­å¥ï¼Œç„¶åå°è£…åˆ°QueryDtoä¸­
    articleQueryDto.setOrderBy(articleOrder.getOrderBySql());
    articleService.findByCondition(articleQueryDto);
}
```

## 2.4 æ–‡ç« çŠ¶æ€æŸ¥è¯¢

æ–‡ç« ä¸€å…±æœ‰3ç§çŠ¶æ€ï¼Œç”¨å­—æ®µ`status`è¡¨ç¤ºï¼Œå…¶ä¸­ï¼š

- 0ï¼šå·²åˆ é™¤
- 1ï¼šå¾…å®¡æ ¸
- 2ï¼šå·²å®¡æ ¸

ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ä¼šå¯¹æ–‡ç« åˆ—è¡¨äº§ç”Ÿå½±å“ï¼Œç»“åˆ`status`å­—æ®µï¼š

1. å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œå¯ä»¥çœ‹åˆ°è‡ªå·±å‘å¸ƒçš„å¾…å®¡æ ¸æ–‡ç« ï¼Œä»¥åŠæ‰€æœ‰å·²å®¡æ ¸æ–‡ç« ã€‚
2. å½“æœªç™»å½•æ—¶ï¼Œç”¨æˆ·åªèƒ½çœ‹åˆ°æ‰€æœ‰å·²å®¡æ ¸çš„æ–‡ç« ã€‚

åœ¨åŠ¨æ€æ„å»ºsqlæ—¶ï¼Œéœ€è¦é€šè¿‡userIdæ˜¯å¦æœª`null`æ¥åˆ¤æ–­æ˜¯å¦ç™»å½•ï¼Œä»è€Œäº§ç”Ÿä¸åŒçš„æ¡ä»¶ï¼Œå½“userIdä¸ä¸º`null`å³ç”¨æˆ·ç™»å½•ï¼Œæ¡ä»¶å¦‚ä¸‹ï¼š

```xml
<if test="userId != null">
    <!-- ç™»å½•ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2å’Œè‡ªå·±çš„çŠ¶æ€ä¸º1çš„æ–‡ç«  -->
    and (status = 2 or status = 1 and user_id = #{userId})
</if>
```

å½“`userId`ä¸º`null`æ—¶ï¼Œæ¡ä»¶åº”ä¸ºï¼š

```xml
<if test="userId == null">
    <!-- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2çš„æ–‡ç«  -->
    and status = 2
</if>
```

> åœ¨sqlä¸­æ¡ä»¶çš„ä¼˜å…ˆçº§æœ€é«˜çš„æ˜¯`()`ï¼Œå…¶æ¬¡æ˜¯`not`ï¼Œç„¶åæ˜¯`and`ã€`or`ï¼Œç›¸åŒä¼˜å…ˆçº§æŒ‰ä»å·¦å¾€å³çš„é¡ºåºæ¯”è¾ƒã€‚

æˆ‘ä»¬è¿™é‡Œå°†å‰é¢çš„å…¶ä»–æ¡ä»¶å‡è®¾ä¸ºaï¼Œé‚£ä¹ˆå°±æ˜¯åœ¨æ»¡è¶³açš„æ–‡ç« ä¸­é€‰å‡ºçŠ¶æ€ä¸º2ï¼Œå’Œå½“å‰ç”¨æˆ·çš„çŠ¶æ€ä¸º1çš„æ–‡ç« ã€‚å¦‚æœä¸åŠ `()`æå‡ä¼˜å…ˆçº§ï¼Œç›´æ¥å†™æˆè¿™æ ·ï¼š

```sql
a and status = 2 or status = 1 and user_id = ?
```

é‚£ä¹ˆæ•ˆæœå°±æ˜¯åœ¨æ»¡è¶³açš„æ–‡ç« ä¸­é€‰å‡ºçŠ¶æ€ä¸º2çš„æ–‡ç« åŠ ä¸Šå½“å‰ç”¨æˆ·çš„çŠ¶æ€ä¸º1çš„æ–‡ç« ï¼Œ`status = 1 and user_id = ?`é€‰æ‹©å‡ºæ¥çš„æ•°æ®æ²¡æœ‰ç»è¿‡æ¡ä»¶açš„ç­›é€‰ã€‚å› æ­¤éœ€è¦å°†`status = 2 or status = 1 and user_id =  ï¼Ÿ`çœ‹ä½œä¸€ä¸ªæ•´ä½“å†åœ¨æ»¡è¶³açš„æ–‡ç« ä¸­è¿›è¡Œç­›é€‰ï¼Œæ‰€ä»¥åŠ `()`:

```sql
a and (status = 2 or status = 1 and user_id = ?)
```

ç­‰æ•ˆå†™æ³•ï¼š

```sql
-- å› ä¸ºandä¼˜å…ˆäºorè®¡ç®—ï¼Œæ‰€ä»¥åŠ ä¸åŠ ()ä¸å½±å“é¡ºåº
(status = 2 or status = 1 and user_id = ?) = (status = 2 or (status = 1 and user_id = ?))
```

ä¸‹é¢æ˜¯æ¼”ç¤ºï¼š

å½“å‰å·²ç™»å½•ï¼Œèƒ½çœ‹åˆ°çŠ¶æ€2å’Œè‡ªå·±çš„çŠ¶æ€1çš„æ–‡ç« çš„æ–‡ç« ï¼š

![åŠ¨ç”»](assets/åŠ¨ç”».gif)

æœªç™»å½•æ—¶ï¼Œåªèƒ½çœ‹åˆ°çŠ¶æ€2çš„æ–‡ç« ï¼š

![åŠ¨ç”»](assets/åŠ¨ç”»-1735987522201-2.gif)

## 2.5 æŸ¥è¯¢é›†ä¸åå›æ–‡ç« å†…å®¹

æ–‡ç« çš„å†…å®¹æ˜¯HTMLæ–‡æœ¬æˆ–è€…markdownæ–‡æœ¬ï¼Œå­˜å‚¨åœ¨textå­—æ®µä¸­ã€‚ç”±äºå†…å®¹æ•°æ®é‡é€šå¸¸éå¸¸åºå¤§ï¼Œå¦‚æœåœ¨æŸ¥è¯¢æ–‡ç« åˆ—è¡¨æ—¶ç›´æ¥å°†è¿™äº›å†…å®¹å…¨éƒ¨æŸ¥è¯¢å‡ºæ¥ï¼Œä¼šå¸¦æ¥ä»¥ä¸‹é—®é¢˜ï¼š

- **æŸ¥è¯¢æ•ˆç‡ä½**ï¼šå¤§é‡æ— å…³æ•°æ®çš„æŸ¥è¯¢å¢åŠ äº†æ•°æ®åº“å’ŒæœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚

- **ç½‘ç»œä¼ è¾“æ…¢**ï¼šæ•°æ®é‡è¿‡å¤§å¯¼è‡´ä¼ è¾“æ—¶é—´å˜é•¿ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

æ–‡ç« åˆ—è¡¨ä»…å±•ç¤ºåŸºç¡€ä¿¡æ¯ï¼Œå¦‚æ ‡é¢˜ã€æµè§ˆé‡ã€ç‚¹èµé‡ã€ä½œè€…ç­‰ï¼Œè¯¦ç»†å†…å®¹åªæœ‰åœ¨ç”¨æˆ·ç‚¹å‡»å…·ä½“æ–‡ç« æ—¶æ‰éœ€è¦åŠ è½½ã€‚å› æ­¤ï¼š

1. **æŸ¥è¯¢æ–‡ç« åˆ—è¡¨æ—¶**ï¼šåªæŸ¥è¯¢å¿…è¦çš„å­—æ®µï¼ˆå¦‚æ ‡é¢˜ã€ä½œè€…ç­‰ï¼‰ï¼Œ**ä¸æŸ¥è¯¢ `text` å­—æ®µ**ã€‚
2. **æŸ¥çœ‹å…·ä½“æ–‡ç« æ—¶**ï¼šå•ç‹¬æŸ¥è¯¢æ‰€éœ€æ–‡ç« çš„ `text` å†…å®¹ï¼Œæ­¤æ—¶ä»…æŸ¥è¯¢ **ä¸€ä¸ªæ–‡ç« çš„å†…å®¹**ï¼Œé¿å…äº†ä¸å¿…è¦çš„æ€§èƒ½æ¶ˆè€—ã€‚

é€šç”¨çš„æŸ¥è¯¢å­—æ®µé‡Œæ²¡æœ‰`content`å’Œ`md_content`å­—æ®µï¼š

![image-20250104185536550](assets/image-20250104185536550.png)

å…·ä½“æŸ¥è¯¢æ—¶ï¼Œæ‰ä¼šæŸ¥è¿™ä¸¤ä¸ªå­—æ®µï¼š

![image-20250104185605049](assets/image-20250104185605049.png)

æŸ¥è¯¢å‡ºæ¥çš„`Article`å®ä½“éœ€è¦è½¬æ¢æœª`ArticleVo`è¿”å›ã€‚

## 2.6 ğŸŒæŸ¥è¯¢æ–‡ç« æ¥å£

åœ°å€ï¼š

```
http://localhost:8091/web/articles
```

è¯·æ±‚æ–¹å¼ï¼š

`GET`

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å    | ç±»å‹     | å¿…å¡«é¡¹  | è¯´æ˜                                             |
| --------- | -------- | ------- | ------------------------------------------------ |
| title     | `string` | `false` | æ–‡ç« æ ‡é¢˜                                         |
| boardId   | `int`    | `false` | æ¿å—id                                           |
| pBoardId  | `int`    | `false` | çˆ¶æ¿å—id                                         |
| orderType | `int`    | `false` | æ’åºç±»å‹ï¼Œ0ï¼šçƒ­æ¦œï¼Œ1ï¼šå‘å¸ƒæ—¶é—´ï¼Œ2ï¼šæœ€è¿‘ï¼Œé»˜è®¤ä¸º0 |
| page      | `int`    | `false` | é¡µç ï¼Œé»˜è®¤ä¸º1                                    |
| status    | `int`    | `false` | æ–‡ç« çŠ¶æ€ï¼Œ0ï¼šå·²åˆ é™¤ï¼Œ1ï¼šå¾…å®¡æ ¸ï¼Œ2ï¼šå·²å®¡æ ¸        |

å“åº”ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "total": 1,
        "page": 1,
        "pageSize": 10,
        "pageTotal": 1,
        "rows": [
            {
                "articleId": "11",
                "boardId": 3,
                "boardName": "æ¸¸æˆæ”»ç•¥",
                "pBoardId": 1,
                "pBoardName": "æ¸¸æˆ",
                "userId": "9619980088",
                "nickName": "ling",
                "userIdAddress": "å››å·",
                "title": "å·«å¸ˆ3æ”»ç•¥1",
                "cover": null,
                "content": null,
                "mdContent": null,
                "editorType": null,
                "summary": "å·«å¸ˆ3è‰¯å¿ƒæ”»ç•¥",
                "readCount": 0,
                "likeCount": 0,
                "topType": 0,
                "attachmentType": 0,
                "status": 2,
                "createTime": "2025-01-06 16:38:14",
                "commentCount": 0
            }
        ]
    }
}
```

---

## 2.7 æ¥å£å®ç°

æŸ¥è¯¢çš„sqlï¼š

```xml
	<!-- é€šç”¨å­—æ®µ -->
    <sql id="commonField">
        article_id
        , board_id
        , board_name
        , p_board_id
        , p_board_name
        , user_id
        , nick_name
        , user_id_address
        , title
        , cover
        , editor_type
        , summary
        , read_count
        , like_count
        , comment_count
        , top_type
        , attachment_type
        , status
        , create_time
        , update_time
    </sql>

    <!-- æŸ¥è¯¢æ¡ä»¶ -->
    <sql id="queryCondition">
        <where>
            <if test="title != null and title != ''">
                title like concat('%', #{title}, '%')
            </if>
            <if test="boardId != null">
                and board_id = #{boardId}
            </if>
            <if test="pBoardId != null">
                and p_board_id = #{pBoardId}
            </if>
            <if test="userId != null">
                <!-- ç™»å½•ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2å’Œè‡ªå·±çš„çŠ¶æ€ä¸º1çš„æ–‡ç«  -->
                and (status = 2 or (status = 1 and user_id = #{userId}))
            </if>
            <if test="userId == null">
                <!-- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2çš„æ–‡ç«  -->
                and status = 2
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="topType != null">
                and top_type = #{topType}
            </if>
            <if test="createTime != null">
                and create_time = #{createTime}
            </if>
        </where>
    </sql>

    <!-- æ¡ä»¶åˆ†é¡µæŸ¥è¯¢ï¼Œè¿”å›po -->
    <select id="selectByCondition" resultType="com.ling.entity.po.Article">
        select <include refid="commonField"/> from article
        <include refid="queryCondition"/>
        <if test='orderBy != null and orderBy != ""'>
            order by ${orderBy}
        </if>
        <if test="index != null and size != null">
            limit #{index}, #{size}
        </if>
    </select>

	<!-- æ¡ä»¶æŸ¥è¯¢æ€»æ•°é‡ -->
    <select id="selectCountByCondition" resultType="java.lang.Long">
        select count(0) total from article <include refid="queryCondition"/>
    </select>
```

ä¸šåŠ¡å±‚ï¼š

```java
/**
 * æ¡ä»¶æŸ¥è¯¢Vo
 *
 * @param articleQueryDto
 * @return
 */
@Override
public PageBean<ArticleVo> findVoByCondition(ArticleQueryDto articleQueryDto) {
    List<Article> list = articleMapper.selectByCondition(articleQueryDto);
    List<ArticleVo> articleVos = list.stream().map(e -> {
        ArticleVo vo = new ArticleVo();
        BeanUtils.copyProperties(e, vo);
        return vo;
    }).collect(Collectors.toList());
    Long total = findTotalByCondition(articleQueryDto);
    return PageBean.of(total, articleQueryDto.getPage(), articleQueryDto.getPageSize(), articleVos);
}
```

æ§åˆ¶å™¨ï¼š

```java
@GetMapping
@AccessControl
public Result loadArticles(HttpSession session, String title,
                           @Validation(required = false) Integer boardId,
                           @Validation(required = false) Integer pBoardId,
                           @RequestParam(defaultValue = "0") @Validation(max = 2, required = false) Integer orderType,
                           @Validation(required = false, max = 2) Integer status,
                           @RequestParam(defaultValue = "1") @Validation(min = 1, required = false) Integer page) {
    ArticleQueryDto articleQueryDto = new ArticleQueryDto();
    articleQueryDto.setTitle(title);
    articleQueryDto.setBoardId(Objects.equals(boardId, 0) ? null : boardId); // æ¿å—idä¸º0æ—¶ï¼Œè¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰ä¸“æ çš„æ–‡ç« 
    articleQueryDto.setpBoardId(pBoardId);
    // æ ¹æ®å‰ç«¯ä¼ æ¥çš„orderTypeï¼Œè·å–å¯¹åº”çš„æ’åºè§„åˆ™
    ArticleOrderEnum articleOrderEnum = ArticleOrderEnum.getArticleOrderEnum(orderType);
    articleQueryDto.setOrderBy(articleOrderEnum.getOrderBySql());
    UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
    articleQueryDto.setUserId(userinfo == null ? null : userinfo.getUserId());
    articleQueryDto.setPage(page);
    articleQueryDto.setPageSize(Constant.NUM_10);
    PageBean<ArticleVo> voByCondition = articleService.findVoByCondition(articleQueryDto);
    return Result.success(voByCondition);
}
```

æŸ¥è¯¢Dtoå°±æ˜¯ç”¨æ¥æºå¸¦æŸ¥è¯¢sqlçš„æ¡ä»¶ï¼Œå·§å¦™çš„æ„å»ºDtoå­—æ®µä¸sqlæ¡ä»¶å­—æ®µçš„å¯¹åº”å…³ç³»ï¼ŒåŠ¨æ€æ”¹å˜æŸ¥è¯¢Dtoçš„å­—æ®µï¼ŒæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µä¹Ÿä¼šåŠ¨æ€æ”¹å˜ï¼Œè¿™æ˜¯æŸ¥è¯¢Dtoçš„ä¸€ç§èƒ½åŠ›ã€‚

---



## 2.8 æ¥å£æ›´æ–°

æŸ¥è¯¢æ–‡ç« æ—¶ï¼Œæ²¡æœ‰è€ƒè™‘ç®¡ç†å‘˜æŸ¥è¯¢çš„æƒ…å†µï¼Œå½“å‰çš„æŸ¥è¯¢sqlçš„æ¡ä»¶æ˜¯è¿™æ ·çš„ï¼š

```xml
<sql id="queryCondition">
    <where>
        <if test="title != null and title != ''">
            title like concat('%', #{title}, '%')
        </if>
        <if test="boardId != null">
            and board_id = #{boardId}
        </if>
        <if test="pBoardId != null">
            and p_board_id = #{pBoardId}
        </if>
        <if test="userId != null">
            <!-- ç™»å½•ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2å’Œè‡ªå·±çš„çŠ¶æ€ä¸º1çš„æ–‡ç«  -->
            and (status = 2 or (status = 1 and user_id = #{userId}))
        </if>
        <if test="userId == null">
            <!-- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2çš„æ–‡ç«  -->
            and status = 2
        </if>
        <if test="status != null">
            and status = #{status}
        </if>
        <if test="topType != null">
            and top_type = #{topType}
        </if>
        <if test="createTime != null">
            and create_time = #{createTime}
        </if>
    </where>
</sql>
```

å¦‚æœæ˜¯ç®¡ç†å‘˜ç™»å½•ï¼Œé‚£ä¹ˆæŸ¥è¯¢æƒ…å†µä¸ä¸€èˆ¬ç”¨æˆ·ç™»å½•ä¸€æ ·ï¼Œéƒ½ä¸èƒ½æŸ¥çœ‹éä½œè€…æœ¬äººå¾…å®¡æ ¸æ–‡ç« ï¼Œå®é™…ä¸Šç®¡ç†å‘˜æ‹¥æœ‰æŸ¥è¯¢é™¤åˆ é™¤ä»¥å¤–æ‰€æœ‰æ–‡ç« çš„æƒé™ã€‚å› æ­¤ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶ä¸ºï¼š

```xml
<sql id="queryCondition">
    <where>
        <if test="title != null and title != ''">
            title like concat('%', #{title}, '%')
        </if>
        <if test="boardId != null">
            and board_id = #{boardId}
        </if>
        <if test="pBoardId != null">
            and p_board_id = #{pBoardId}
        </if>
        <if test="userId != null and isAdmin == true">
            <!-- ç®¡ç†å‘˜ä»…ä¸èƒ½çœ‹åˆ é™¤æ–‡ç«  -->
            and status != 0
        </if>
        <if test="userId != null and isAdmin == false">
            <!-- ç™»å½•ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2å’Œè‡ªå·±çš„çŠ¶æ€ä¸º1çš„æ–‡ç«  -->
            and (status = 2 or (status = 1 and user_id = #{userId}))
        </if>
        <if test="userId == null">
            <!-- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2çš„æ–‡ç«  -->
            and status = 2
        </if>
        <if test="status != null">
            and status = #{status}
        </if>
        <if test="topType != null">
            and top_type = #{topType}
        </if>
        <if test="createTime != null">
            and create_time = #{createTime}
        </if>
    </where>
</sql>
```

æŸ¥è¯¢Dtoä¸­åŠ å…¥`isAdmin`å±æ€§ï¼ŒæŸ¥è¯¢æ—¶å°†è¿™ä¸ªå±æ€§ä¼ é€’è¿‡å»ï¼š

![image-20250108201527247](assets/image-20250108201527247.png)



# çŠ¶æ€æŸ¥è¯¢æ¡ä»¶è°ƒæ•´

ä¸Šé¢æˆ‘ä»¬æ§åˆ¶ç™»å½•çŠ¶æ€ä¸æ–‡ç« çŠ¶æ€çš„å…³ç³»ç”¨çš„æ¡ä»¶æ˜¯`userId`å’Œ`isAdmin`ï¼Œæœ€å¥½æ˜¯é‡æ–°å®šä¹‰ä¸€ä¸ªå±æ€§æ¥æ§åˆ¶è¿™å±‚å…³ç³»ï¼Œå› ä¸º`userId`æ—¢è¦æ§åˆ¶`user_id`å­—æ®µï¼Œè¿˜è¦æ§åˆ¶ç™»å½•çŠ¶æ€ä¸æ–‡ç« çŠ¶æ€çš„å…³ç³»ï¼š

```xml
<if test="userId != null and isAdmin == true">
    <!-- ç®¡ç†å‘˜ä»…ä¸èƒ½çœ‹åˆ é™¤æ–‡ç«  -->
    and status != 0
</if>
<if test="userId != null and isAdmin == false">
    <!-- ç™»å½•ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2å’Œè‡ªå·±çš„çŠ¶æ€ä¸º1çš„æ–‡ç«  -->
    and (status = 2 or (status = 1 and user_id = #{userId}))
</if>
<if test="userId == null">
    <!-- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2çš„æ–‡ç«  -->
    and status = 2
</if>

<!-- å…¶ä»–æ¡ä»¶ -->

<if test="userId != null and userId != ''">
	and user_id = #{userId}
</if>
```

è¿™å°±å¯¼è‡´è€¦åˆäº†ï¼Œä»¥adminç«¯ä¸ºä¾‹ï¼Œadminç«¯å¯ä»¥æŸ¥çœ‹åˆ°æ‰€æœ‰çŠ¶æ€çš„æ–‡ç« ï¼Œåœ¨æŸ¥è¯¢æ—¶ä¸ä¼šè®¾ç½®`userId`æ¡ä»¶ï¼Œè¿™æ„å‘³ç€`userId = null`ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ¡ä»¶ï¼Œè‹¥`userId = null`ï¼Œé‚£ä¹ˆæ¡ä»¶`and status = 2`ä¼šä¸€ç›´å­˜åœ¨ã€‚å‡å¦‚adminç«¯åªæƒ³æŸ¥çœ‹`status = 0`çš„æ–‡ç« ï¼Œä¼šåŒæ—¶æŠŠ`status = 2`çš„æ–‡ç« ä¹ŸæŸ¥å‡ºæ¥ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œè¦ä¿è¯`userId`çš„å€¼ä¸ä¼šå½±å“åˆ°ç™»å½•çŠ¶æ€ä¸æ–‡ç« çŠ¶æ€çš„å…³ç³»ï¼Œå› æ­¤è§£è€¦ã€‚

æˆ‘ä»¬åº”è¯¥é‡æ–°å®šä¹‰ä¸€ä¸ªå±æ€§`statusControl`æ¥æ§åˆ¶ç™»å½•çŠ¶æ€ä¸æ–‡ç« çŠ¶æ€çš„å…³ç³»ï¼š

`statusControl`ä¸ºæ•´å‹ï¼Œå–0ã€1ã€2ä¸‰ä¸ªæ•°å€¼å½±å“ä¸åŒçš„å…³ç³»åˆ†æ”¯ï¼š

```xml
<if test="statusControl != null and statusControl == 0">
    <!-- ç®¡ç†å‘˜ä»…ä¸èƒ½çœ‹åˆ é™¤æ–‡ç«  -->
    and status != 0
</if>
<if test="statusControl != null and statusControl == 1">
    <!-- ç™»å½•ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2å’Œè‡ªå·±çš„çŠ¶æ€ä¸º1çš„æ–‡ç«  -->
    and (status = 2 or (status = 1 and user_id = #{scUserId}))
</if>
<if test="statusControl != null and statusControl == 2">
    <!-- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹åˆ°æ‰€æœ‰çŠ¶æ€ä¸º2çš„æ–‡ç«  -->
    and status = 2
</if>
```

åœ¨`loadArticles()`ä¸­åˆ é™¤è¿™ä¸¤æ®µä»£ç ï¼š

```java
articleQueryDto.setUserId(userinfo == null ? null : userinfo.getUserId());
articleQueryDto.setAdmin(userinfo != null && userinfo.getIsAdmin());
```

æ”¹ä¸º`statusControl`æ§åˆ¶ï¼š

```java
int statusControl;
if (userinfo == null) {
    statusControl = 2;
} else {
    statusControl = userinfo.getIsAdmin() ? 0 : 1;
    articleQuery.setScUserId(userinfo.getUserId());
}
articleQuery.setStatusControl(statusControl);
```



