# ä¸€ã€ğŸŒæ›´æ–°ç¼“å­˜ä¸­ç³»ç»Ÿè®¾ç½®çš„æ¥å£

## 1.1 æ¥å£æè¿°

æ­¤æ¥å£ç”¨äºæ›´æ–°ç¼“å­˜ä¸­çš„ç³»ç»Ÿè®¾ç½®ï¼Œä¸ºadminç«¯ä½¿ç”¨ï¼Œå› ä¸ºè®¾ç½®æ˜¯åœ¨adminç«¯æ›´æ–°ï¼Œè€Œwebç«¯å’Œadminç«¯åˆæ˜¯ä¸åŒçš„æœåŠ¡ï¼Œå› æ­¤æä¾›è¿™æ ·çš„æ¥å£åœ¨adminç«¯æ›´æ–°ååŒæ­¥æ›´æ–°webç«¯ã€‚

## 1.2 è¯·æ±‚åœ°å€

```http
PUT /web/inner/refresh-cache
```

## 1.3 è¯·æ±‚å‚æ•°

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| --------- | -------- | -------- | ------ |
| timestamp | `int`    | `true`   | æ—¶é—´æˆ³ |
| secretKey | `string` | `true`   | å¯†é’¥   |

## 1.4 è¿”å›å®ä¾‹

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

## 1.5 æ¥å£å®ç°

è¯¥æ¥å£ä¸ºå†…éƒ¨æœåŠ¡æ¥å£ï¼Œå¹¶éç”±æµè§ˆå™¨ç›´æ¥è®¿é—®ï¼Œè€Œæ˜¯ç”±åç«¯æœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ã€‚ç”±äºè¯¥æ¥å£ä¸ä¾èµ–ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œå› æ­¤å±äºä¸€ä¸ªé€æ˜æ¥å£ï¼Œä»»ä½•çŸ¥é“è¯·æ±‚åœ°å€çš„äººå‡å¯è®¿é—®ã€‚ä¸ºäº†ä¿è¯æ¥å£çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œè®¿é—®èº«ä»½éªŒè¯ã€‚

ä¸ºé˜²æ­¢æ¶æ„è®¿é—®ï¼Œéœ€è¦é€šè¿‡æ ¡éªŒè®¿é—®æ–¹çš„èº«ä»½æ¥ä¿éšœæ¥å£çš„å®‰å…¨ã€‚å…·ä½“åšæ³•å¦‚ä¸‹ï¼š

1ã€é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå¯†é’¥ï¼Œå®ƒæ˜¯ä¸€ä¸ªå”¯ä¸€çš„éšæœºå­—ç¬¦ä¸²ï¼ˆä»¥ä¸‹å›¾ç¤ºï¼‰ã€‚è¯¥å¯†é’¥ä»…é™äºæœåŠ¡åŒæ–¹ï¼ˆå³webç«¯å’Œadminç«¯ï¼‰ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸å¾—å…±äº«ç»™å…¶ä»–ä»»ä½•äººã€‚

![image-20250328164547202](assets/image-20250328164547202.png)

2ã€å½“è¯·æ±‚æ–¹ï¼ˆå³ç®¡ç†ç«¯ï¼‰å‘é€è¯·æ±‚æ—¶ï¼Œéœ€è¦æºå¸¦è¯·æ±‚çš„æ—¶é—´æˆ³å’Œç­¾åã€‚æ—¶é—´æˆ³æ˜¯è¯·æ±‚å‘èµ·æ—¶çš„æ¯«ç§’å€¼ï¼Œè€Œç­¾åæ˜¯æ ¹æ®æ—¶é—´æˆ³å’Œå¯†é’¥ç»è¿‡åŠ å¯†ç®—æ³•ç”Ÿæˆçš„ã€‚åŠ å¯†é‡‡ç”¨ **HMAC-SHA256** ç®—æ³•ï¼Œç¡®ä¿ç›¸åŒçš„å†…å®¹ç”Ÿæˆç›¸åŒçš„ç­¾åã€‚

3ã€å½“æ¥æ”¶åˆ°è¯·æ±‚åï¼ŒæœåŠ¡ç«¯ä¼šä½¿ç”¨ç›¸åŒçš„åŠ å¯†ç®—æ³•ï¼Œå°†å¯†é’¥å’Œæ—¶é—´æˆ³ç”Ÿæˆä¸€ä¸ªæ–°çš„ç­¾åï¼Œå¹¶ä¸è¯·æ±‚ä¸­ä¼ é€’çš„ç­¾åè¿›è¡Œæ¯”å¯¹ã€‚å¦‚æœä¸€è‡´ï¼Œè¯´æ˜è¯·æ±‚åˆæ³•ï¼ŒæœåŠ¡å™¨æ¥å—è¯¥è¯·æ±‚ï¼›å¦åˆ™ï¼Œæ‹’ç»è¯¥è¯·æ±‚ã€‚

4ã€ä¸ºäº†é˜²æ­¢ç¬¬ä¸‰æ–¹ä½¿ç”¨å·²è¿‡æ—¶çš„æ—¶é—´æˆ³å’Œç­¾åå‘èµ·è¯·æ±‚ï¼Œæˆ‘ä»¬å¯¹æ—¶é—´æˆ³è¿›è¡Œäº†æœ‰æ•ˆæ€§æ ¡éªŒã€‚å…·ä½“å®ç°æ–¹å¼æ˜¯ï¼Œå½“è¯·æ±‚çš„æ—¶é—´æˆ³ä¸å½“å‰æ—¶é—´å·®å¼‚è¶…è¿‡30ç§’æ—¶ï¼Œè®¤ä¸ºè¯¥è¯·æ±‚çš„æ—¶é—´æˆ³å·²å¤±æ•ˆã€‚

æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ—¶é—´æˆ³æˆ–è€…ç­¾åæœ‰ä»»ä½•ä¸€ä¸ªè¢«ç¯¡æ”¹ï¼Œé‚£ä¹ˆæœ€ç»ˆç”Ÿæˆçš„ç­¾åéƒ½ä¼šä¸ä¸€è‡´ã€‚

åœ¨ `InnerAPIController` æ§åˆ¶å™¨ä¸­ï¼Œå®šä¹‰äº†æ¥å£å¤„ç†æ–¹æ³• `refreshSysCache()`ï¼Œç”¨äºå®ç°ä¸Šè¿°é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
package com.ling.controller.inner;

import com.ling.annotation.AccessControl;
import com.ling.annotation.Validation;
import com.ling.config.web.WebpageConfig;
import com.ling.constant.Constant;
import com.ling.entity.vo.Result;
import com.ling.enums.ResponseCodeEnum;
import com.ling.exception.BusinessException;
import com.ling.service.SysSettingService;
import com.ling.utils.StrUtil;
import org.apache.commons.codec.digest.HmacUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.Objects;

@RestController
@RequestMapping("/inner-api")
public class InnerAPIController {
    private Logger log = LoggerFactory.getLogger(InnerAPIController.class);
    @Resource
    private SysSettingService sysSettingService;
    @Resource
    private WebpageConfig webpageConfig;

    @PutMapping("/refresh-cache")
    @AccessControl
    public Result<Void> refreshSysCache(@Validation Long timestamp, @Validation String sign) {
        // æ ¡éªŒæ—¶é—´æˆ³ï¼Œé¿å…ä½¿ç”¨æ—§å€¼
        if (Math.abs(System.currentTimeMillis() - timestamp) >= Constant.MILLIS_1 * 30) {
            log.error("æ—¶é—´æˆ³å¤±æ•ˆ");
            throw new BusinessException(ResponseCodeEnum.CODE_600);
        }

        // æ ¡éªŒç­¾å
        String secretKey = webpageConfig.getSecretKey();
        String mySign = StrUtil.generateHmacSha256Hex(secretKey, String.valueOf(timestamp));
        if (!Objects.equals(mySign, sign)) {
            log.error("ç­¾åé”™è¯¯ï¼Œæ ¡éªŒå¤±è´¥");
            throw new BusinessException(ResponseCodeEnum.CODE_600);
        }

        sysSettingService.refreshCache();
        return Result.success();
    }
}
```

å…¶å®è¿™é‡Œå¯¹æ—¶é—´æˆ³çš„æ ¡éªŒè¿˜ä¸ç®—ä¸¥è°¨ï¼Œæ¯•ç«Ÿåªè¦ä¸è¶…è¿‡30ç§’ï¼Œæˆ‘ä»ç„¶å¯ä»¥ä½¿ç”¨æ—§çš„æ—¶é—´æˆ³ã€‚æœ€å®‰å…¨çš„åšæ³•æ˜¯æ—¶é—´æˆ³ç”¨è¿‡ä¸€æ¬¡åç«‹åˆ»å¤±æ•ˆï¼Œä¸è¿‡è¦å®ç°è¿™ä¸ªæŠ€æœ¯æœ‰ç‚¹å¤æ‚ï¼Œè¿™é‡Œå°±ç®€å•çš„é‡‡ç”¨æ—¶é—´é™åˆ¶ã€‚

ç­¾åæ˜¯é€šè¿‡ **HMAC-SHA256** ç®—æ³•è®¡ç®—å¾—å‡ºçš„ï¼Œå®ƒå°†å¯†é’¥å’Œæ—¶é—´æˆ³ç»“åˆåŠ å¯†åç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å¦‚æœè®¡ç®—å‡ºçš„ç­¾åä¸è¯·æ±‚ä¸­æä¾›çš„ç­¾åä¸€è‡´ï¼Œåˆ™è¯´æ˜è¯·æ±‚åˆæ³•ã€‚

> æ­¤æ–¹æ³•ä¾èµ– **Apache Commons Codec** åº“æ¥è¿›è¡Œ SHA256 åŠ å¯†ã€‚

```java
/**
     * HMAC-SHA256 ç®—æ³•
     * ç”Ÿæˆ16è¿›åˆ¶éšæœºå­—ç¬¦ä¸²
     * è‹¥å¯†é’¥å’Œæ•°æ®ä¸€è‡´ï¼Œåˆ™ç”Ÿæˆçš„ç»“æœä¸€è‡´
     *
     * @param secretKey
     * @param data
     * @return
     */
    public static String generateHmacSha256Hex(String secretKey, String data) {
        // 1. åˆå§‹åŒ– Mac å®ä¾‹
        Mac mac = HmacUtils.getInitializedMac(HmacAlgorithms.HMAC_SHA_256, secretKey.getBytes(StandardCharsets.UTF_8));

        // 2. æ›´æ–°æ•°æ®å¹¶ç”Ÿæˆæ‘˜è¦
        byte[] digestBytes = mac.doFinal(data.getBytes(StandardCharsets.UTF_8));

        // 3. è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²
        return Hex.encodeHexString(digestBytes);
    }
```
