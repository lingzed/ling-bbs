# 1 æ¶ˆæ¯åŠŸèƒ½æ¨¡å—è¯´æ˜

æœ¬æ¨¡å—è´Ÿè´£å¤„ç†ç³»ç»Ÿæ¶ˆæ¯çš„æ¨é€ä¸ç®¡ç†ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š

- **æœªè¯»æ¶ˆæ¯æŸ¥è¯¢**ï¼šæä¾›æ¥å£ï¼Œæ”¯æŒå®¢æˆ·ç«¯è·å–å½“å‰æœªè¯»æ¶ˆæ¯çš„æ•°é‡ï¼Œä»¥ä¾¿åŠæ—¶æé†’ç”¨æˆ·å¤„ç†ã€‚
- **æ¶ˆæ¯åˆ—è¡¨åŠ è½½**ï¼šæ”¯æŒåˆ†é¡µåŠ è½½æ¶ˆæ¯åˆ—è¡¨ï¼Œæ–¹ä¾¿ç”¨æˆ·æŸ¥çœ‹å†å²æ¶ˆæ¯ï¼Œæå‡ä½¿ç”¨ä½“éªŒã€‚
- **æ¶ˆæ¯è¯¦æƒ…æŸ¥è¯¢**ï¼šå…è®¸ç”¨æˆ·æŸ¥çœ‹å…·ä½“æ¶ˆæ¯å†…å®¹ï¼Œç¡®ä¿ä¿¡æ¯çš„å®Œæ•´æ€§å’Œå¯è¯»æ€§ã€‚
- **å®æ—¶æ¶ˆæ¯æ¨é€**ï¼šé‡‡ç”¨ **WebSocket** æŠ€æœ¯ï¼Œå®ç°æ¶ˆæ¯çš„ **ä¸»åŠ¨æ¨é€**ï¼Œç¡®ä¿é‡è¦é€šçŸ¥èƒ½å¤Ÿ **å³æ—¶åˆ°è¾¾** å®¢æˆ·ç«¯ï¼Œæé«˜ç³»ç»Ÿçš„äº¤äº’æ€§ä¸å“åº”æ•ˆç‡ã€‚

è¯¥æ¨¡å—çš„æ¶ˆæ¯æ¥å£ç”± **`MessageController`** è´Ÿè´£ç®¡ç†ã€‚



# 2 ğŸŒåŠ è½½æœªè¯»æ¶ˆæ¯æ•°é‡æ¥å£

**æ¥å£æè¿°**

è¯¥æ¥å£ç”¨äº **ç»Ÿè®¡å½“å‰ç”¨æˆ·çš„æœªè¯»æ¶ˆæ¯æ•°é‡**ã€‚

**è¯·æ±‚åœ°å€**

```http
GET /web/message/count
```

**è¯·æ±‚å‚æ•°**

`null`

**è¿”å›å®ä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "msgCount": xxx
    }
}
```

### 2.1 æ¥å£å®ç°

è¯¥æ¥å£çš„æ ¸å¿ƒé€»è¾‘æ˜¯ **æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æœªè¯»æ¶ˆæ¯æ•°é‡** å¹¶è¿”å›ç›¸åº”ç»“æœã€‚åœ¨æ§åˆ¶å™¨ä¸­å®šä¹‰æ–¹æ³•`loadMessageCount()`:

```java
/**
     * ç»Ÿè®¡æœªè¯»æ¶ˆæ¯æ•°é‡çš„æ¥å£
     *
     * @param session
     * @return
     */
    @GetMapping("/count")
    @AccessControl(loginRequired = true)
    public Result<Map<String, Long>> loadMessageCount(HttpSession session) {
         // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
        SessionUserinfo userinfo = getUserinfo(session);

        // æ„é€ æŸ¥è¯¢æ¡ä»¶ï¼šæ¥æ”¶äººä¸ºå½“å‰ç”¨æˆ·ï¼Œæ¶ˆæ¯çŠ¶æ€ä¸ºæœªè¯»
        UserMessageQuery query = new UserMessageQuery();
        query.setReceivedUserId(userinfo.getUserId());
        query.setStatus(MessageStatusEnum.NO_READ.getStatus());

        // ç»Ÿè®¡ç¬¦åˆæ¡ä»¶çš„æœªè¯»æ¶ˆæ¯æ•°é‡
        Long total = userMessageService.countByCondition(query);

        // ç»„è£…è¿”å›æ•°æ®
        HashMap<String, Long> res = new HashMap<>();
        res.put("msgCount", total);

        return Result.success(res);
    }
```



# 3 ğŸŒåŠ è½½æ¶ˆæ¯åˆ—è¡¨æ¥å£

**æ¥å£æè¿°**

æœ¬æ¥å£ç”¨äº **æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯åˆ—è¡¨**ï¼Œæ”¯æŒåˆ†é¡µåŠ è½½ï¼Œå¹¶å¯é€šè¿‡ **å¤šç§ç­›é€‰æ¡ä»¶** ç²¾ç¡®æŸ¥è¯¢ã€‚

**è¯·æ±‚åœ°å€**

```http
GET /web/message
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å      | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜                                                         |
| ----------- | -------- | -------- | ------------------------------------------------------------ |
| page        | `int`    | `true`   | é¡µç                                                          |
| pageSize    | `int`    | `true`   | æ¯é¡µæ¡ç›®                                                     |
| messageType | `int`    | `false`  | 0: ç³»ç»Ÿæ¶ˆæ¯, 1: è¯„è®º, 2: æ–‡ç« ç‚¹èµ,<br /> 3: è¯„è®ºç‚¹èµ, 4: é™„ä»¶ä¸‹è½½ |
| status      | `int`    | `false`  | 0: æœªè¯», 1: å·²è¯»                                             |
| startDate   | `date`   | `false`  | èµ·å§‹æ—¶é—´                                                     |
| endDate     | `date`   | `false`  | ç»“æŸæ—¶é—´                                                     |

**è¿”å›å®ä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "total": 37,
        "page": 1,
        "pageSize": 10,
        "pageTotal": 4,
        "rows": [
            {
                "messageId": 169,
                "articleId": "uukicbc29eqo",
                "articleTitle": "å·«å¸ˆ3æ”»ç•¥1",
                "commentId": 87,
                "senderAvatar": "avatar/2025-03/31f311b3a680488eafce05a41d54e575.jpg",
                "sendUserId": "1835487851",
                "sendNickName": "su7 Ultra",
                "messageType": 1,
                "messageContent": "è¯„è®ºäº†æ‚¨çš„æ–‡ç« %s",
                "status": 0,
                "createTime": "2025-03-26 20:00:32"
            },
            {
                "messageId": 168,
                "articleId": null,
                "articleTitle": null,
                "commentId": 41,
                "senderAvatar": "avatar/2025-03/31f311b3a680488eafce05a41d54e575.jpg",
                "sendUserId": "1835487851",
                "sendNickName": "su7 Ultra",
                "messageType": 3,
                "messageContent": "ç‚¹èµäº†æ‚¨çš„è¯„è®º%s",
                "status": 0,
                "createTime": "2025-03-26 19:57:51"
            },
            ......
        ]
    }
}
```

## 3.1 æ¥å£å®ç°

åœ¨ `MessageController` æ§åˆ¶å™¨ä¸­å®šä¹‰ `loadMessageList()` æ–¹æ³•ï¼Œæ„å»ºæŸ¥è¯¢æ¡ä»¶åè°ƒç”¨ä¸šåŠ¡å±‚æŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨æ•°æ®ï¼š

```java
/**
     * åŠ è½½æ¶ˆæ¯åˆ—è¡¨æ¥å£
     *
     * @param session
     * @param page
     * @param pageSize
     * @param status
     * @return
     */
    @GetMapping
    @AccessControl(loginRequired = true)
    public Result<PageBean<MessageListVo>> loadMessageList(HttpSession session,
                                                           @Validation(min = 1) Integer page,
                                                           @Validation Integer pageSize,
                                                           @Validation(required = false, max = 4) Integer messageType,
                                                           @Validation(max = 1, required = false) Integer status,
                                                           @DateTimeFormat(pattern = "yyyy-MM-dd")
                                                           @Validation(required = false) Date startDate,
                                                           @DateTimeFormat(pattern = "yyyy-MM-dd")
                                                           @Validation(required = false) Date endDate) {
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
        SessionUserinfo userinfo = getUserinfo(session);

        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        UserMessageQuery query = new UserMessageQuery();
        query.setReceivedUserId(userinfo.getUserId());
        query.setPage(page);
        query.setPageSize(pageSize);
        query.setMessageType(messageType);
        query.setStatus(status);
        query.setStartDate(startDate);
        query.setEndDate(endDate);

        // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åº
        query.setOrderBy("create_time desc");

        // æŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨
        PageBean<MessageListVo> voPageByCondition = userMessageService.findVoPageByCondition(query);

        return Result.success(voPageByCondition);
    }
```



# 4 ğŸŒåŠ è½½æ¶ˆæ¯è¯¦æƒ…æ¥å£

**æ¥å£æè¿°**

è¯¥æ¥å£ç”¨äºè·å–æŒ‡å®šæ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ã€‚ç”¨æˆ·åœ¨è®¿é—®æŸæ¡æ¶ˆæ¯æ—¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ›´æ–°å…¶çŠ¶æ€ä¸º **â€œå·²è¯»â€**ã€‚å¦‚æœæ¶ˆæ¯ç±»å‹æ¶‰åŠ **è¯„è®º**ï¼Œæ¥å£è¿˜ä¼šè¿”å›è¯„è®ºçš„å…·ä½“å†…å®¹ã€‚

**è¯·æ±‚åœ°å€**

```http
GET /web/message/{message-id}
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å     | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| ---------- | -------- | -------- | ------ |
| message-id | `int`    | `true`   | æ¶ˆæ¯id |

**è¿”å›å®ä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "messageId": 169,
        "articleId": "uukicbc29eqo",
        "articleTitle": "å·«å¸ˆ3æ”»ç•¥1",
        "commentId": 87,
        "commentContent": "ä½œè€…å†™çš„ä¸é”™ï¼Œå¿«å¤„ç¬¬äºŒç« ğŸ‘",
        "senderAvatar": "avatar/2025-03/31f311b3a680488eafce05a41d54e575.jpg",
        "sendUserId": "1835487851",
        "sendNickName": "su7 Ultra",
        "messageType": 1,
        "messageContent": "è¯„è®ºäº†æ‚¨çš„æ–‡ç« %s",
        "createTime": "2025-03-26 20:00:32"
    }
}
```

## 4.1 æ¥å£å®ç°

åœ¨ **æ§åˆ¶å™¨** ä¸­å®šä¹‰ `loadMessageDetail()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£æ¥æ”¶ç”¨æˆ·è¯·æ±‚å¹¶è°ƒç”¨ä¸šåŠ¡å±‚æ¥å£è·å–æ¶ˆæ¯è¯¦æƒ…ï¼š

```java
/**
     * åŠ è½½æ¶ˆæ¯è¯¦æƒ…æ¥å£
     *
     * @param session
     * @param messageId
     * @return
     */
    @GetMapping("/{message-id}")
    @AccessControl(loginRequired = true)
    public Result<MessageDetailVo> loadMessageDetail(HttpSession session,
                                                     @PathVariable("message-id") @Validation Integer messageId) {
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
        SessionUserinfo userinfo = getUserinfo(session);
        // è°ƒç”¨ä¸šåŠ¡å±‚æ–¹æ³•æŸ¥è¯¢æ¶ˆæ¯è¯¦æƒ…
        MessageDetailVo messageDetailVo = userMessageService.loadMessageDetail(messageId, userinfo.getUserId());
        return Result.success(messageDetailVo);
    }
```

åœ¨ **ä¸šåŠ¡å±‚** æ–°å¢ `loadMessageDetail()` æ–¹æ³•ï¼Œè´Ÿè´£æ ¹æ® `messageId` æŸ¥è¯¢æ¶ˆæ¯è¯¦æƒ…ï¼š

```java
/**
     * æŸ¥è¯¢æ¶ˆæ¯è¯¦æƒ…
     *
     * @param messageId
     * @param userId
     * @return
     */
    MessageDetailVo loadMessageDetail(Integer messageId, String userId);
```

å®ç°ï¼š

```java
@Override
    public MessageDetailVo loadMessageDetail(Integer messageId, String userId) {
        UserMessage message = findById(messageId);
        // æ ¡éªŒidæœ‰æ•ˆæ€§
        if (Objects.isNull(message))
            throw new BusinessException(ResponseCodeEnum.CODE_404);
        if (!Objects.equals(message.getReceivedUserId(), userId))
            throw new BusinessException(CommonMsg.UNAUTHORIZED_ACCESS);
		
        // å°è£…æ¶ˆæ¯è¯¦æƒ…å¯¹è±¡
        MessageDetailVo messageDetailVo = new MessageDetailVo();
        BeanUtils.copyProperties(message, messageDetailVo);
        
        // è‹¥æ¶ˆæ¯ç±»å‹æ¶‰åŠè¯„è®ºï¼Œåˆ™æŸ¥è¯¢è¯„è®ºå†…å®¹
        if (Objects.equals(MessageTypeEnum.COMMENT.getType(), message.getMessageType())
                || Objects.equals(MessageTypeEnum.COMMENT_LIKE.getType(), message.getMessageType())) {
            Comment comment = commentMapper.selectById(message.getCommentId());
            messageDetailVo.setCommentContent(comment.getContent());
        }

        // è‹¥æœªè¯»ï¼Œåˆ™æ›´æ–°ä¸ºå·²è¯»
        if (Objects.equals(message.getStatus(), MessageStatusEnum.NO_READ.getStatus())) {
            UserMessage userMessage = new UserMessage();
            userMessage.setMessageId(message.getMessageId());
            userMessage.setStatus(MessageStatusEnum.READ.getStatus());
            edit(userMessage);
            
            // é€šçŸ¥å‰ç«¯é‡æ–°åŠ è½½æœªè¯»æ¶ˆæ¯
            try {
                String jsonString = OBJECT_MAPPER.writeValueAsString(WSMessage.ofServer(WSMessageTypeEnum.LOAD_UNREAD));
                webSocketServer.sendMessageToUser(userId, jsonString);
            } catch (IOException e) {
                throw new BusinessException(CommonMsg.WS_MESSAGE_SEND_FAIL, e);
            }
        }

        return messageDetailVo;
    }
```



# 5 ğŸŒåˆ é™¤æ¶ˆæ¯æ¥å£

**æ¥å£æè¿°**

è¯¥æ¥å£ç”¨äº **åˆ é™¤æŒ‡å®šæ¶ˆæ¯**ï¼Œç³»ç»Ÿä¼šéªŒè¯ **æ¶ˆæ¯å½’å±æƒ**ï¼Œé¿å…è¶Šæƒåˆ é™¤æ“ä½œã€‚

**è¯·æ±‚åœ°å€**

```http
DELETE /web/message/{message-id}
```

**è¯·æ±‚å‚æ•°**

| å‚æ•°å     | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜   |
| ---------- | -------- | -------- | ------ |
| message-id | `int`    | `true`   | æ¶ˆæ¯id |

**è¿”å›å®ä¾‹**

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

## 5.1 æ¥å£å®ç°

åœ¨ **æ§åˆ¶å™¨** ä¸­å®šä¹‰ `delMessage()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼Œå¹¶è°ƒç”¨ä¸šåŠ¡å±‚æ¥å£è¿›è¡Œæ¶ˆæ¯åˆ é™¤ï¼š

```java
/**
     * åˆ é™¤æ¶ˆæ¯æ¥å£
     *
     * @param session
     * @param messageIds
     * @return
     */
    @DeleteMapping("/{message-ids}")
    @AccessControl(loginRequired = true)
    public Result<Void> delMessage(HttpSession session, @PathVariable("message-ids") List<Integer> messageIds) {
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
        SessionUserinfo userinfo = getUserinfo(session);
        // è°ƒç”¨ä¸šåŠ¡å±‚æ–¹æ³•åˆ é™¤æ¶ˆæ¯
        userMessageService.delete(userinfo.getUserId(), messageIds);
        return Result.success();
    }
```

åœ¨ **ä¸šåŠ¡å±‚** å®šä¹‰ `delete()` æ–¹æ³•ï¼Œè´Ÿè´£æ‰§è¡Œ **åˆ é™¤æ“ä½œ**ï¼Œå¹¶è¿›è¡Œ **æ¶ˆæ¯å½’å±æ ¡éªŒ**ï¼šï¼š

```java
/**
     * åˆ é™¤
     *
     * @param userId
     * @param list
     */
    void delete(String userId, List<Integer> list);
```

å®ç°ï¼š

```java
@Override
    public void delete(String userId, List<Integer> list) {
        // æŸ¥è¯¢è¯¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è¿™äº›æ¶ˆæ¯
        Long total = userMessageMapper.countByReceiverAndIds(userId, list);

        // è‹¥æŸ¥è¯¢ç»“æœä¸º 0ï¼Œè¯´æ˜æ¶ˆæ¯ä¸å±äºå½“å‰ç”¨æˆ·ï¼ŒæŠ›å‡ºå¼‚å¸¸
        if (Objects.equals(total, (long) Constant.NUM_0)) {
            throw new BusinessException(ResponseCodeEnum.CODE_404, "æ¶ˆæ¯ä¸å­˜åœ¨æˆ–æ— æƒé™åˆ é™¤");
        }

        // æ‰§è¡Œåˆ é™¤æ“ä½œ
        delete(list);
    }
```

ä¸ºäº† **æ ¡éªŒæ¶ˆæ¯å½’å±æƒ**ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª **æŸ¥è¯¢æ¶ˆæ¯å½’å±çš„ SQL è¯­å¥**ï¼Œç¡®ä¿ **ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„æ¶ˆæ¯**ï¼š

```xml
<!-- è®¡æ•° é€šè¿‡ æ¥æ”¶äºº && idé›† -->
<select id="countByReceiverAndIds" resultType="java.lang.Long">
    select count(0) total from user_message where received_user_id = #{userId} and message_id in
    <foreach collection="list" item="id" open="(" close=")" separator=",">
        #{id}
    </foreach>
</select>
```

è‹¥è®¡æ•°ä¸º0ï¼Œåˆ™æ¶ˆæ¯ä¸å±äºå½“å‰ç”¨æˆ·ã€‚



# 6 æ¶ˆæ¯æ¨é€

## 6.1 åˆ›å»ºWebSocketæœåŠ¡

ä¸ºäº†å®ç°æ¶ˆæ¯çš„ **å®æ—¶æ¨é€**ï¼Œåç«¯é‡‡ç”¨ WebSocket æŠ€æœ¯ï¼Œåœ¨ç‰¹å®šæ—¶æœºä¸»åŠ¨æ¨é€æ¶ˆæ¯è‡³å‰ç«¯ã€‚å‰ç«¯æ¥æ”¶åï¼Œå¯æ®æ­¤ **é‡æ–°è¯·æ±‚æœ€æ–°æ•°æ®**ï¼Œç¡®ä¿ä¿¡æ¯çš„å®æ—¶æ€§ã€‚

å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š

1ã€åˆ›å»ºWebSocketæœåŠ¡ï¼Œç»§æ‰¿`TextWebSocketHandler`ï¼Œé‡å†™ä»¥ä¸‹æ–¹æ³•ï¼š

- `afterConnectionEstablished()`ï¼Œåœ¨socketå»ºç«‹è¿æ¥æ—¶æ‰§è¡Œã€‚
- `handleTextMessage()`ï¼Œæ¥æ”¶å‰ç«¯å‘é€çš„æ¶ˆæ¯æ—¶æ‰§è¡Œã€‚
- `afterConnectionClosed()`ï¼Œsocketè¿æ¥å…³é—­æ—¶æ‰§è¡Œã€‚

å£°æ˜`WebSocketServer`ï¼š

```java
@Component
public class WebSocketServer extends TextWebSocketHandler {
    private Logger log = LoggerFactory.getLogger(WebSocketServer.class);
    private static final Map<String, WebSocketSession> userSessionMap = new ConcurrentHashMap<>();

    /**
     * socketè¿æ¥æ—¶æ‰§è¡Œ
     *
     * @param session
     * @throws Exception
     */
    @Override
    public void afterConnectionEstablished(WebSocketSession session) {
        String userId = (String) session.getAttributes().get("userId");
        // è¿æ¥æ—¶å­˜å‚¨ç”¨æˆ·çš„ä¼šè¯
        userSessionMap.put(userId, session);
    }

    /**
     * æ¥æ”¶å‘é€æ–¹(å¦‚å‰ç«¯)çš„æ¶ˆæ¯
     *
     * @param session
     * @param message
     */
    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) {
        log.info("æ¥æ”¶åˆ°æ¶ˆæ¯: {}", message);
    }

    /**
     * socketå…³é—­æ—¶æ‰§è¡Œ
     *
     * @param session
     * @param status
     * @throws Exception
     */
    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) {
        String userId = (String) session.getAttributes().get("userId");
        if (!Objects.isNull(userId)) {
            userSessionMap.remove(userId);
        }
    }
    
    /**
     * å‘é€æ¶ˆæ¯
     *
     * @param userId
     * @param message
     */
    public void sendMessageToUser(String userId, String message) throws IOException {
        WebSocketSession userSession = userSessionMap.get(userId);  // æ‹¿åˆ°userIdå¯¹åº”ä¼šè¯
        if (userSession != null && userSession.isOpen()) {
            userSession.sendMessage(new TextMessage(message));
        }
    }
}
```

WebSocket è¿æ¥å»ºç«‹åï¼Œç³»ç»Ÿä¼šç”Ÿæˆ `WebSocketSession`ï¼Œè¯¥ä¼šè¯å¯¹è±¡æ˜¯ **åç«¯ä¸å‰ç«¯é€šä¿¡çš„æ ¸å¿ƒè½½ä½“**ã€‚ä¸ºå®ç° **å®šå‘æ¨é€**ï¼Œéœ€ç»´æŠ¤ä¸€ä¸ª `userSessionMap`ï¼Œç”¨äºå­˜å‚¨ **ç”¨æˆ· ID ä¸ WebSocket ä¼šè¯çš„æ˜ å°„å…³ç³»**ï¼Œç¡®ä¿åç«¯èƒ½å¤Ÿæ ¹æ®ç”¨æˆ· ID ç›´æ¥å‘ç‰¹å®šç”¨æˆ·æ¨é€æ¶ˆæ¯ã€‚

åœ¨ `afterConnectionEstablished()` æ–¹æ³•ä¸­ï¼ŒWebSocket è¿æ¥å»ºç«‹åï¼Œä¼šå°†ç”¨æˆ· ID å­˜å…¥ `WebSocketSession` çš„ `attributes`ï¼Œå¹¶åŠ å…¥ `userSessionMap` è¿›è¡Œç®¡ç†ã€‚è¿æ¥å…³é—­æ—¶ï¼Œéœ€ä» `userSessionMap` ä¸­ç§»é™¤å¯¹åº”çš„ä¼šè¯ï¼Œé¿å…èµ„æºæ³„éœ²ã€‚

ç„¶åå†å®šä¹‰ä¸€ä¸ªå‘é€æ¶ˆæ¯çš„æ–¹æ³•`sendMessageToUser()`ï¼Œæ¥æ”¶ç”¨æˆ·idå’Œæ¶ˆæ¯ï¼Œé€šè¿‡idä»`userSessionMap`ä¸­æ‰¾åˆ°å¯¹åº”çš„ä¼šè¯ï¼Œå†é€šè¿‡ä¼šè¯å‘é€æ¶ˆæ¯ã€‚

2ã€å®šä¹‰æ¡æ‰‹æ‹¦æˆªå™¨

ç”±äº WebSocket **åè®®ç‹¬ç«‹äº HTTP**ï¼Œè¿æ¥å»ºç«‹åï¼Œå‰ç«¯æ— æ³•åœ¨ WebSocket è¯·æ±‚ä¸­æºå¸¦ URL å‚æ•°ã€‚å› æ­¤ï¼Œåœ¨ **WebSocket æ¡æ‰‹é˜¶æ®µ**ï¼Œéœ€é€šè¿‡ **æ‹¦æˆªå™¨** æå–è¯·æ±‚å‚æ•°ï¼Œå¹¶å­˜å‚¨è‡³ `WebSocketSession` çš„ `attributes`ï¼Œä¾›åç»­ä½¿ç”¨ã€‚å°±æ¯”å¦‚ä¸Šè¿°ä»`attributes`ä¸­è·å–ç”¨æˆ·idä¸€æ ·ã€‚

å£°æ˜`UserIdHandshakeInterceptor`å®ç°`HandshakeInterceptor`ï¼Œå®ç°ä»¥ä¸‹æ–¹æ³•ï¼š

- `beforeHandshake()`ï¼Œæ¡æ‰‹å‰çš„å¤„ç†ï¼Œè¿”å›å¸ƒå°”å€¼ï¼Œ`true`è¡¨ç¤ºå…è®¸æ¡æ‰‹ï¼Œ`false`è¡¨ç¤ºæ‹’ç»ã€‚
- `afterHandshake()`ï¼Œæ¡æ‰‹åçš„å¤„ç†ï¼Œä¸€èˆ¬æ— éœ€æ“ä½œã€‚

æˆ‘ä»¬éœ€è¦åœ¨`beforeHandshake()`ä¸­è·å–åˆ°è¯·æ±‚å‚æ•°ï¼š

```java
@Component
public class UserIdHandshakeInterceptor implements HandshakeInterceptor {
    private Logger log = LoggerFactory.getLogger(UserIdHandshakeInterceptor.class);

    @Resource
    private UserInfoService userInfoService;

    /**
     * æ¡æ‰‹å‰çš„å¤„ç†(å…³é”®)
     *
     * @param request
     * @param response
     * @param wsHandler
     * @param attributes
     * @return
     */
    @Override
    public boolean beforeHandshake(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler,
                                   Map<String, Object> attributes) {
        if (request instanceof ServletServerHttpRequest) {
            ServletServerHttpRequest servletRequest = (ServletServerHttpRequest) request;

            // å¯ä»¥é€‰æ‹©å°†idä½œä¸ºå‚æ•°ä¼ é€’ï¼Œä½†è¿™æ ·ä¸å®‰å…¨
            String userId = servletRequest.getServletRequest().getParameter("userId");
            checkUser(userId);
            attributes.put("userId", userId); // å­˜å…¥WebSocketSessionå±æ€§
        }
        return true; // è¿”å›trueè¡¨ç¤ºå…è®¸æ¡æ‰‹
    }

    /**
     * æ¡æ‰‹åçš„å¤„ç†ï¼ˆä¸€èˆ¬æ— éœ€æ“ä½œï¼‰
     *
     * @param request
     * @param response
     * @param wsHandler
     * @param exception
     */
    @Override
    public void afterHandshake(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Exception exception) {

    }

    private UserInfo checkUser(String userId) {
        UserInfo userInfo = userInfoService.findById(userId);
        if (Objects.isNull(userInfo))
            throw new BusinessException(CommonMsg.WS_CONNECTION_FAIL);
        return userInfo;
    }
}
```

ç›´æ¥åœ¨ URL ä¼ é€’ `userId` å­˜åœ¨ **è¢«ç¯¡æ”¹** çš„é£é™©ï¼Œå»ºè®®é‡‡ç”¨ **JWTã€å¯¹ç§°åŠ å¯†ã€éå¯¹ç§°åŠ å¯†** è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¿™é‡Œæˆ‘é€‰æ‹©æ˜æ–‡ä¼ é€’ï¼Œå¯¹idåšæ ¡éªŒã€‚

**ä¸ºä»€ä¹ˆä¸ä»HttpSessionä¸­è·å–ç”¨æˆ·idï¼Œåè€Œå°†idä½œä¸ºå‚æ•°ä¼ é€’è½ä¸‹å®‰å…¨éšæ‚£ï¼Ÿ**

å› ä¸ºWebSocketæ˜¯ç‹¬ç«‹åè®®ï¼Œ**ä¸ä¼šè‡ªåŠ¨æºå¸¦Cookie**ï¼Œè€ŒJSEESIONIDé€šå¸¸å­˜å‚¨åœ¨Cookieä¸­ï¼Œå¯¼è‡´æœåŠ¡å™¨åœ¨æ¡æ‰‹æ—¶æ— æ³•é€šè¿‡JSEESIONIDæ‰¾åˆ°å¯¹åº”çš„`HttpSession`ã€‚å³è·å–çš„`HttpSession`ä¸º`null`æ— æ³•ä»ä¸­è·å–ç”¨æˆ·idã€‚

3ã€æ³¨å†Œæ¡æ‰‹æ‹¦æˆªå™¨å’ŒWebSocketæœåŠ¡

WebSocket åŠå…¶æ‹¦æˆªå™¨éœ€è¿›è¡Œæ³¨å†Œï¼Œä½¿å…¶èƒ½å¤Ÿæ¥å—è¿æ¥è¯·æ±‚ã€‚

å£°æ˜`WebSocketConfig`å®ç°`WebSocketConfigurer`ï¼Œå®ç°æ–¹æ³•`registerWebSocketHandlers()`ï¼š

```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    @Resource
    private WebSocketServer webSocketServer;
    @Resource
    private UserIdHandshakeInterceptor userIdHandshakeInterceptor;

    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(webSocketServer, "/ws") // ç›‘å¬/ws
                .addInterceptors(userIdHandshakeInterceptor)    // æ·»åŠ æ‹¦æˆªå™¨
                .setAllowedOrigins("*");    // å…è®¸æ‰€æœ‰URLè·¨åŸŸ
    }
}
```

æ³¨å†Œ WebSocket æœåŠ¡å™¨ï¼Œç›‘å¬ `ws://` è¯·æ±‚ï¼Œå¹¶å¯ç”¨æ¡æ‰‹æ‹¦æˆªå™¨ï¼Œå®ç° WebSocket è®¤è¯ä¸é‰´æƒï¼Œæœ€åé…ç½®è·¨åŸŸã€‚

4ã€å‰ç«¯è¯·æ±‚å»ºç«‹è¿æ¥

ä¸‹é¢æ˜¯ä¸€ä¸ªæ¼”ç¤ºï¼Œå‰ç«¯é‡‡ç”¨ã€WebSocketã€‘å¯¹è±¡å»ºç«‹wsè¿æ¥ï¼š

```js
let socket = null;

const socketInit = () => {
    socket = new WebSocket("ws://localhost:8091/web/ws?userId=xxx");	// è¿æ¥åˆ°/wsï¼Œä¼ é€’å‚æ•°userId
	
    // è¿æ¥å»ºç«‹æ—¶æ‰§è¡Œ
    socket.onopen = () => {
        console.log("WebSocket è¿æ¥æˆåŠŸ");
        // TODO
    };
	
    // æ¥æ”¶åç«¯å‘é€çš„æ¶ˆæ¯
    socket.onmessage = (event) => {
        console.log(event);
        // TODO
    };
	
    // è¿æ¥å…³é—­æ—¶æ‰§è¡Œ
    socket.onclose = () => {
        console.log("WebSocket è¿æ¥å…³é—­");
    };
};

socketInit();
```



## 6.2 æ¨é€æ¶ˆæ¯

å½“å‘æ¶ˆæ¯è¡¨ä¸­æ’å…¥æ¶ˆæ¯æ—¶ï¼Œå³å¯ **è§¦å‘ WebSocket æ¨é€**ï¼Œé€šçŸ¥å‰ç«¯æ›´æ–°ã€‚åœ¨ `UserMessageService` ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œæ‰©å±• `add()` æ–¹æ³•ï¼Œç¡®ä¿ **æ¶ˆæ¯å­˜å…¥æ•°æ®åº“åï¼Œç«‹å³æ¨é€ WebSocket é€šçŸ¥**ï¼š

```java
@Override
    public void add(String userId, UserMessage userMessage) {
        add(userMessage);
        try {
            // é€šçŸ¥å‰ç«¯é‡æ–°åŠ è½½æœªè¯»æ¶ˆæ¯
            String jsonString = OBJECT_MAPPER.writeValueAsString(WSMessage.ofServer(WSMessageTypeEnum.LOAD_UNREAD));
            webSocketServer.sendMessageToUser(userId, jsonString);
        } catch (IOException e) {
            throw new BusinessException(CommonMsg.WS_MESSAGE_SEND_FAIL, e);
        }
    }
```

WebSocket æ¶ˆæ¯é‡‡ç”¨ `WSMessage` ç»Ÿä¸€æ ¼å¼å°è£…ï¼š

```java
/**
 * Web Socket æ¶ˆæ¯
 */
public class WSMessage {
    private String sender;
    private Integer type;
    private String content;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private Date date;

    public WSMessage(String sender, Integer type, String content, Date date) {
        this.sender = sender;
        this.type = type;
        this.content = content;
        this.date = date;
    }

    public WSMessage() {
    }

    public static WSMessage of(String sender, Integer type, String content, Date date) {
        return new WSMessage(sender, type, content, date);
    }

    public static WSMessage ofServer(Integer type, String content) {
        return new WSMessage(Constant.SERVER_SENDER, type, content, new Date());
    }

    public static WSMessage ofServer(WSMessageTypeEnum wsMessageTypeEnum) {
        return new WSMessage(Constant.SERVER_SENDER, wsMessageTypeEnum.getType(), wsMessageTypeEnum.getDesc(), new Date());
    }

    // getter && setter
}
```

åˆ†åˆ«åœ¨æ–‡ç« ç‚¹èµã€é™„ä»¶ä¸‹è½½ã€è¯„è®ºç‚¹èµã€è¯„è®ºå‘å¸ƒéœ€è¦æ’å…¥æ¶ˆæ¯çš„åœºæ™¯ä¸‹æ›¿æ¢æ‰åŸæ¥çš„æ·»åŠ æ–¹æ³•ï¼š

![image-20250327142242782](assets/image-20250327142242782.png)

![image-20250327142301845](assets/image-20250327142301845.png)

![image-20250327142329090](assets/image-20250327142329090.png)

![image-20250327142349881](assets/image-20250327142349881.png)

