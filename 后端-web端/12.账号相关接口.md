# 1 ç™»å½•ä¹‹å‰çš„å‡†å¤‡

## 1.1 æŸ¥è¯¢IPä¿¡æ¯çš„ç¬¬ä¸‰æ–¹æ¥å£

ç™»å½•æˆ‘ä»¬éœ€è¦ç”¨åˆ°ç”¨æˆ·çš„IPï¼Œè¿™æ˜¯ä¸€ä¸ªæŸ¥è¯¢IPä¿¡æ¯çš„æ¥å£ï¼š

```http
GET https://whois.pconline.com.cn/ipJson.jsp?json=true&ip=IPåœ°å€
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å | å¿…å¡«é¡¹ | è¯´æ˜   |
| ------ | ------ | ------ |
| ip     | `true` | IPåœ°å€ |

è¿”å›å€¼ï¼š

```json
{
  "ip": "171.219.187.76",
  "pro": "å››å·çœ",
  "proCode": "510000",
  "city": "æˆéƒ½å¸‚",
  "cityCode": "510100",
  "region": "",
  "regionCode": "0",
  "addr": "å››å·çœæˆéƒ½å¸‚ ç”µä¿¡",
  "regionNames": "",
  "err": ""
}
```

å…¶ä¸­ï¼Œçœä»½`pro`æ˜¯æˆ‘ä»¬éœ€è¦çš„å€¼ã€‚

è¿™ä¸ªè¯·æ±‚åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ç”±æœåŠ¡å™¨å‘é€ï¼Œå› æ­¤éœ€è¦å€Ÿç”¨OkHttpå·¥å…·ç±»å‘æ­¤æ¥å£å‘é€ç”¨æˆ·çš„IPï¼Œè·å–ç”¨æˆ·çš„çœä»½ä¿¡æ¯ã€‚è€Œç”¨æˆ·çš„IPåˆ™å¯ä»¥ä»`HttpServletRequest`ä¸­è·å–ï¼Œè·å–çš„æ–¹æ³•å¦‚ä¸‹ï¼š

## 1.2  ä»HttpServletRequestä¸­è·å–IP

IPå·¥å…·ç±»å¦‚ä¸‹ï¼š

```java
package com.ling.utils;

import javax.servlet.http.HttpServletRequest;

/**
 * IPå·¥å…·ç±»
 */
public class IPUtil {
    /**
     * è·å–å®¢æˆ·ç«¯IPåœ°å€
     *
     * @param request
     * @return
     */
    public static String getIP(HttpServletRequest request) {
        String ip = request.getHeader("x-forwarded-for");
        if (ip != null && !ip.isEmpty() && !ip.equalsIgnoreCase("unknown")) {
            // å¤šæ¬¡åå‘ä»£ç†åä¼šæœ‰å¤šä¸ªipå€¼ï¼Œç¬¬ä¸€ä¸ªipæ‰æ˜¯çœŸå®ip
            if (ip.contains(",")) {
                ip = ip.split(",")[0];
            }
        }
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("Proxy-Client-IP");  // nginxåå‘ä»£ç†
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("WL-Proxy-Client-IP");   // é˜¿é‡Œäº‘åå‘ä»£ç†
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("HTTP_CLIENT_IP");   // è¥¿äº‘æ•°æ®
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("HTTP_X_FORWARDED_FOR"); // æ™®é€šä»£ç†
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("X-Real-IP");    // äº‘æœåŠ¡å™¨
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getRemoteAddr();   // å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œå°±ç›´æ¥å–IP
        return ip;
    }
}
```

è°ƒç”¨`getIP()`è·å–ã€‚

## 1.3 æŸ¥è¯¢IPä¿¡æ¯æ–¹æ³•

```java
public String getProvince(String IP) {
    try {
        String url = "https://whois.pconline.com.cn/ipJson.jsp?json=true&ip=" + IP;
        String res = OkHttpUtil.getRequest(url);
        Map resMap = JSON.parseObject(res, Map.class);
        String province = (String) resMap.get("pro");
        return province;
    } catch (Exception e) {
        log.error(CommonMsg.FETCH_FAIL, e);
        return Constant.UNKNOWN;	// è‹¥è·å–ä¸åˆ°IPå±åœ°ï¼Œè¿”å›æœªçŸ¥
    }
}
```

å“åº”ä¸ºJSONå­—ç¬¦ä¸²æ—¶ï¼Œé€šå¸¸è§£æä¸ºå¯¹åº”çš„å®ä½“å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å®ä½“ï¼Œåˆ™è§£æä¸º`Map`ã€‚

## 1.4 UserInfoSessionDto

`UserInfoSessionDto`å¯¹è±¡æ˜¯ç”¨äºä¿å­˜ç”¨æˆ·ä¼šè¯ä¿¡æ¯çš„ä¼ è¾“å®ä½“ã€‚ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œæˆ‘ä»¬é€šå¸¸å°†ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯å­˜å‚¨åœ¨`session`ä¸­ï¼Œè€Œè¿™äº›ä¿¡æ¯å¯ä»¥é€šè¿‡`UserInfoSessionDto`å¯¹è±¡æ¥æ‰¿è½½å’Œè¡¨ç¤ºã€‚

> JWTä¹Ÿå¯ä»¥ç”¨äºç»´æŠ¤ç”¨æˆ·ä¼šè¯ï¼Œä½†ä¸ä¼ ç»Ÿçš„`session`ä¸åŒçš„æ˜¯ï¼ŒæœåŠ¡å™¨åªè´Ÿè´£ç”Ÿæˆå’Œæ ¡éªŒJWTï¼Œè€Œå­˜å‚¨å·¥ä½œç”±æµè§ˆå™¨å®Œæˆã€‚å½“ç„¶ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç»“åˆä½¿ç”¨ä¸¤è€…ï¼Œæ ¹æ®éœ€æ±‚é€‰æ‹©æœ€ä½³æ–¹æ¡ˆã€‚

`UserInfoSessionDto`å®šä¹‰å¦‚ä¸‹ï¼š

```java
package com.ling.entity.dto;

/**
 * ç”¨æˆ·ä¼šè¯ä¿¡æ¯ä¼ è¾“å®ä½“
 */
public class UserInfoSessionDto {
    private String userId;  //  ç”¨æˆ·id
    private String nikeName; // æ˜µç§°
    private String province; // çœä»½
    private String isAdmin; // æ˜¯å¦ç®¡ç†å‘˜

    public String getUserId() {
        return userId;
    }

    public void setUserId(String userId) {
        this.userId = userId;
    }

    public String getNikeName() {
        return nikeName;
    }

    public void setNikeName(String nikeName) {
        this.nikeName = nikeName;
    }

    public String getProvince() {
        return province;
    }

    public void setProvince(String province) {
        this.province = province;
    }

    public String getIsAdmin() {
        return isAdmin;
    }

    public void setIsAdmin(String isAdmin) {
        this.isAdmin = isAdmin;
    }
}
```



# 2 ç™»å½•æ¥å£

## 2.1 ğŸŒæ¥å£è¯¦ç»†

è¯·æ±‚åœ°å€ï¼š

```http
GET /web/account/login
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å    | å¿…å¡«é¡¹ | è¯´æ˜       |
| --------- | ------ | ---------- |
| mail      | `true` | é‚®ç®±/è´¦å·  |
| password  | `true` | å¯†ç        |
| checkCode | `true` | å›¾ç‰‡éªŒè¯ç  |

å“åº”ï¼š

```json
{
    "status": "success",
    "code":	200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

æ˜¯å¦å“åº”`UserInfoSessionDto`ï¼Œè§†æƒ…å†µè€Œå®šã€‚

## 2.2 æ¥å£å®ç°

ç™»å½•æ“ä½œä¸»è¦åŒ…å«æŸ¥è¯¢å’Œæ›´æ–°ä¸¤éƒ¨åˆ†ï¼š

1. **æŸ¥è¯¢**ï¼šç”¨äºæ ¡éªŒç”¨æˆ·è´¦æˆ·çš„åˆæ³•æ€§ã€‚
2. **æ›´æ–°**ï¼šç”¨äºç»´æŠ¤ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å­—æ®µï¼š
   - `last_login_time`ï¼šè®°å½•ç”¨æˆ·æœ€åä¸€æ¬¡ç™»å½•çš„æ—¶é—´ã€‚
   - `last_login_ip`ï¼šè®°å½•ç”¨æˆ·æœ€åä¸€æ¬¡ç™»å½•æ—¶çš„IPåœ°å€ã€‚
   - `last_login_ip_address`ï¼šè®°å½•IPåœ°å€æ‰€å±çš„åœ°ç†ä½ç½®ã€‚

åœ¨ç™»å½•æ ¡éªŒæˆåŠŸåï¼Œéœ€è¦è·å–ç”¨æˆ·IPçš„å½’å±åœ°ï¼Œå¹¶æ›´æ–°ä¸Šè¿°ä¸‰ä¸ªå­—æ®µã€‚åŒæ—¶ï¼Œå°†ç”¨æˆ·çš„ä¼šè¯çŠ¶æ€ä¿å­˜ä¸º `UserInfoSessionDto`ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨ã€‚

ä¸‹é¢æ˜¯å®ç°ï¼š

æ§åˆ¶å±‚ï¼š

> æ³¨æ„âš ï¼š
>
> éªŒè¯ç çš„æ ¡éªŒåº”è¯¥æ”¾åˆ°æ§åˆ¶å±‚ï¼Œè€Œä¸åº”è¯¥æ”¾åˆ°ä¸šåŠ¡å±‚ã€‚

```java
/**
     * ç™»å½•
     *
     * @param request
     * @param session
     * @param mail      é‚®ç®±
     * @param password  å¯†ç 
     * @param checkCode å›¾ç‰‡éªŒè¯ç 
     * @return
     */
@GetMapping("/login")
@AccessControl
public Result login(HttpServletRequest request,
                                        HttpSession session,
                                        @Validation(max = 150, regex = RegexConstant.REGEX_EMAIL) String mail,
                                        @Validation(min = 8, max = 32) String password,
                                        @Validation String checkCode) {
    try {
        log.info("é‚®ç®±: {}, å¯†ç : {}, å›¾ç‰‡éªŒè¯ç : {}", mail, password, checkCode);
        String sCheckCode = (String) session.getAttribute(Constant.CHECK_CODE);
        if (StrUtil.isEmpty(sCheckCode))
            throw new BusinessException(CommonMsg.CHECK_CODE_EXPIRED);
        if (!Objects.equals(checkCode, sCheckCode))
            throw new BusinessException(CommonMsg.CHECK_CODE_ERROR);
        String ip = IPUtil.getIP(request);
        UserInfoSessionDto userInfoSessionDto = userInfoService.login(ip, mail, password, checkCode, sCheckCode);
        session.setAttribute(Constant.USERINFO_SESSION_KEY, userInfoSessionDto);
        // return Result.success(userInfoSessionDto);
        return Result.success();
    } finally {
        session.removeAttribute(Constant.CHECK_CODE);
    }
}
```

è¯´ä¸€ä¸ªç»†èŠ‚ï¼Œå¯†ç æ ¡éªŒä»…ä½œé•¿åº¦é™åˆ¶ï¼Œå› ä¸ºç™»å½•ä¸€èˆ¬ä¸ä¼šå¯¹å¯†ç è¿›è¡Œæ ¡éªŒï¼Œè€Œä¸”ç™»å½•ä¼ è¾“çš„å¯†ç è‚¯å®šæ˜¯å¯†æ–‡ï¼Œå¯¹å¯†æ–‡è¿›è¡Œæ­£åˆ™æ ¡éªŒæ²¡æœ‰æ„ä¹‰ã€‚

ä¸šåŠ¡å±‚æ¥å£ï¼Œæ·»åŠ ä¸€ä¸ª`login()`ï¼š

```java
/**
     * ç™»å½•
     *
     * @param IP         IP
     * @param mail       é‚®ç®±
     * @param password   å¯†ç 
     * @return
     */
    UserInfoSessionDto login(String IP, String mail, String password);
```

ä¸šåŠ¡å±‚å®ç°ï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯ç›´æ¥è°ƒç”¨å·²æœ‰çš„æ–¹æ³•`update()`ï¼š

```java
@Override
    public UserInfoSessionDto login(String IP, String mail, String password) {
        try {
            UserInfo userInfo = userInfoMapper.selectByEmail(mail);
            if (userInfo == null || !userInfo.getPassword().equals(password))
                throw new BusinessException(CommonMsg.USERNAME_OR_PASSWORD_ERROR);
            if (Objects.equals(userInfo.getStatus(), UserStatusEnum.DISABLE.getStatus()))
                throw new BusinessException(CommonMsg.USER_DISABLED);

            String province = getProvince(IP);
            userInfo.setLastLoginTime(new Date());
            userInfo.setLastLoginIp(IP);
            userInfo.setLastLoginIpAddress(province);
            userInfoMapper.update(userInfo);

            UserInfoSessionDto userInfoSessionDto = new UserInfoSessionDto();
            userInfoSessionDto.setUserId(userInfo.getUserId());
            userInfoSessionDto.setNickName(userInfo.getNickName());
            userInfoSessionDto.setProvince(province);
            boolean isAdmin = ArrayUtils.contains(webConfig.getAdminMails().split(","), userInfo.getEmail());
            userInfoSessionDto.setIsAdmin(isAdmin);
            return userInfoSessionDto;
        } catch (BusinessException e) {
            log.error(CommonMsg.LOGIN_FAIL, e);
            throw new BusinessException(CommonMsg.LOGIN_FAIL, e);
        }
    }

    /**
     * è·å–IPå½’å±åœ°
     *
     * @param IP
     * @return
     */
    public String getProvince(String IP) {
        try {
            String url = "https://whois.pconline.com.cn/ipJson.jsp?json=true&ip=" + IP;
            String res = OkHttpUtil.getRequest(url);
            Map<String, Object> resMap = JSON.parseObject(res, Map.class);
            String province = (String) resMap.get("pro");
            return province;
        } catch (Exception e) {
            log.error(CommonMsg.FETCH_FAIL, e);
            return Constant.UNKNOWN;
        }
    }
```

`isAdmin`æ ‡è¯†ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œé€šè¿‡é‚®ç®±æ¥åˆ¤æ–­ã€‚ç®¡ç†å‘˜é‚®ç®±å®šä¹‰åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¤šä¸ªé‚®ç®±ç”¨,åˆ†å‰²ï¼š

![image-20241218141934680](assets/image-20241218141934680.png)

æ³¨å…¥åæ‹¿åˆ°é‚®ç®±é›†è§£æä¸ºæ•°ç»„ï¼Œåˆ¤æ–­ç”¨æˆ·çš„é‚®ç®±æ˜¯å¦åœ¨æ•°ç»„ä¸­ï¼Œä¸åœ¨åˆ™ä¸æ˜¯ç®¡ç†å‘˜ã€‚



# 3 è·å–ç”¨æˆ·ä¼šè¯ä¿¡æ¯æ¥å£

## 3.1 ğŸŒæ¥å£è¯¦ç»†

è¯·æ±‚åœ°å€ï¼š

```http
GET /web/account/getUserInfo
```

è¯·æ±‚å‚æ•°ï¼šæ— 

å“åº”ï¼š

```json
{
    "status": "success",
    "code":	200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        userId: "xxx",
        nikeName: "xxx",
        province: "xxx",
        isAdmin: false
    }
}
```

å°±æ˜¯å“åº”`UserInfoSessionDto`ã€‚

## 3.2 æ¥å£å®ç°

```java
/**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     *
     * @param session
     * @return
     */
    @GetMapping("/getUserInfo")
    @AccessControl
    @RequestLogRecode
    public Result<UserInfoSessionDto> getUserInfo(@ExcludeParamLog HttpSession session) {
        UserInfoSessionDto userInfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        return Result.success(userInfo);
    }
```



# 4 ç™»å‡ºæ¥å£

## 4.1 ğŸŒæ¥å£è¯¦ç»†

è¯·æ±‚åœ°å€ï¼š

```http
GET /web/account/logout
```

è¯·æ±‚å‚æ•°ï¼šæ— 

å“åº”ï¼š

```json
{
    "status": "success",
    "code":	200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

å°†ä¼šè¯å¯¹è±¡åˆ é™¤ã€‚

## 4.2 æ¥å£å®ç°

```java
/**
     * ç™»å‡º
     *
     * @param session
     * @return
     */
    @GetMapping("/logout")
    @AccessControl
    @RequestLogRecode
    public Result logout(@ExcludeParamLog HttpSession session) {
        session.invalidate();
        return Result.success();
    }
```

ç”¨`invalidate()`æ¥åˆ é™¤`Session`ï¼Œæ²¡æœ‰ä½¿ç”¨`removeAttribute(key)`åˆ é™¤å¯¹åº”çš„ä¿¡æ¯ã€‚å› ä¸º`Session`ç±»ä½¿äº`Map`ä»¥é”®å€¼å¯¹å½¢å¼å­˜å‚¨å€¼ï¼Œè€Œ`removeAttribute()`ä¸€æ¬¡åªèƒ½åˆ é™¤ä¸€ä¸ªé”®å€¼å¯¹ï¼Œ`invalidate()`æ˜¯æŠŠæ•´ä¸ª`Session`ç»™åˆ é™¤ï¼Œå…¶å†…éƒ¨ä¼šè°ƒç”¨`removeAttribute()`é€ä¸€åˆ é™¤`Session`çš„é”®å€¼å¯¹ã€‚

```java
session.removeAttribute(Constant.USERINFO_SESSION_KEY);
```

è¿™åªæ˜¯åˆ é™¤`USERINFO_SESSION_KEY`å¯¹åº”çš„ä¿¡æ¯ï¼Œå½“å‰ä¼šè¯çš„å…¶ä»–ä¿¡æ¯å¹¶æ²¡åˆ é™¤ã€‚è€Œå½»åº•é”€æ¯`Session`å°±ç”¨`invalidate()`ã€‚

åœ¨ç™»å‡º(å®Œå…¨é”€æ¯ç™»å½•çŠ¶æ€)æˆ–æ¸…ç©ºä¼šè¯ä¿¡æ¯(è´­ç‰©è½¦ã€ç™»å½•ä¿¡æ¯)çš„åœºæ™¯ä¸‹ä½¿ç”¨ã€‚



# 5 è·å–æ˜¯å¦å¼€å¯è¯„è®ºçš„çŠ¶æ€

## 5.1 ğŸŒæ¥å£è¯¦ç»†

è¯·æ±‚åœ°å€ï¼š

```http
GET /web/account/getOpenComment
```

è¯·æ±‚å‚æ•°ï¼š`null`

å“åº”ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "openComment": true
    }
}
```

å°†å¼€å¯çŠ¶æ€è¿”å›ï¼Œæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ã€‚è¿™ä¸ªçŠ¶æ€åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å·²å­˜å…¥ç³»ç»Ÿè®¾ç½®ä¸­ã€‚

## 5.2 æ¥å£å®ç°

```java
/**
     * è·å–è¯„è®ºå¼€å…³çŠ¶æ€
     *
     * @return
     */
    @GetMapping("/getOpenComment")
    @AccessControl
    @RequestLogRecode
    public Result<HashMap<String, Object>> getSysSetting4Comment() {
        SysSettingContainer sysSettingContainer = SysCacheUtil.getSysSettingContainer();
        HashMap<String, Object> res = new HashMap<>();
        res.put("openComment", sysSettingContainer.getSysSetting4Comment().isOpenComment());
        return Result.success(res);
    }
```



# 6 é‡ç½®å¯†ç æ¥å£

## 6.1 ğŸŒæ¥å£è¯¦æƒ…

è¯·æ±‚åœ°å€ï¼š

```http
GET /web/account/resetPwd
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å    | å‚æ•°ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜       |
| --------- | -------- | -------- | ---------- |
| mail      | `string` | `true`   | é‚®ç®±       |
| password  | `string` | `true`   | å¯†ç        |
| checkCode | `string` | `true`   | å›¾ç‰‡éªŒè¯ç  |
| mailCode  | `string` | `true`   | é‚®ç®±éªŒè¯ç  |

è¿”å›ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": null
}
```

## 6.2 æ¥å£å®ç°

åœ¨`AccountController`æ§åˆ¶å™¨ä¸­æ–°å¢å¯†ç é‡ç½®æ¥å£ï¼š

```java
/**
     * é‡ç½®å¯†ç æ¥å£
     *
     * @param password
     * @param mail
     * @param checkCode
     * @param mailCode
     * @param session
     * @return
     */
    @PostMapping("/resetPwd")
    @AccessControl
    public Result resetPwd(@Validation(regex = RegexConstant.REGEX_PWD_MEDIUM) String password,
                           @Validation(max = 150, regex = RegexConstant.REGEX_EMAIL) String mail,
                           @Validation String checkCode,
                           @Validation String mailCode,
                           HttpSession session) {
        try {
            doCheckCode(session, checkCode, Constant.CHECK_CODE);
            userInfoService.resetPwd(mail, password, mailCode);
            return Result.success();
        } finally {
            session.removeAttribute(Constant.CHECK_CODE);
        }
    }

/**
     * æ£€æŸ¥å›¾ç‰‡éªŒè¯ç 
     *
     * @param session
     * @param checkCode
     * @param checkCodeKey
     */
    private void doCheckCode(HttpSession session, String checkCode, String checkCodeKey) {
        String code = (String) session.getAttribute(checkCodeKey);
        log.info("ç”Ÿæˆçš„å›¾ç‰‡éªŒè¯ç : {}", code);
        if (StrUtil.isEmpty(code)) throw new BusinessException(CommonMsg.CHECK_CODE_EXPIRED);
        if (StrUtil.isEmpty(checkCode) || !checkCode.equalsIgnoreCase(code))
            throw new BusinessException(CommonMsg.CHECK_CODE_ERROR);
    }
```

ä¸ºäº†ä»£ç å¤ç”¨ï¼Œæˆ‘å°†æ ¡éªŒå›¾ç‰‡éªŒè¯ç çš„é€»è¾‘æŠ½ç¦»å‡ºä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•`doCheckCode()`ï¼ŒéªŒè¯ç æ£€æŸ¥é€šè¿‡åï¼Œè°ƒç”¨`resetPwd()`æ‰§è¡Œé‡ç½®å¯†ç çš„æ“ä½œã€‚

åœ¨`UserInfoService`æ¥å£ä¸­å®šä¹‰å¯†ç é‡ç½®æ–¹æ³•ï¼š

```java
/**
     * é‡ç½®å¯†ç 
     *
     * @param mail     é‚®ç®±
     * @param password å¯†ç 
     * @param mailCode é‚®ç®±éªŒè¯ç 
     */
    void resetPwd(String mail, String password, String mailCode);
```

å®ç°ï¼š

```java
@Override
    public void resetPwd(String mail, String password, String mailCode) {
        try {
            UserInfo userInfo = userInfoMapper.selectByEmail(mail);
            if (userInfo == null) throw new BusinessException(CommonMsg.MAIL_NOT_EXISTS);
            MailCode mailCodeInfo = mailCodeMapper.selectByMailAndCode(mail, mailCode);
            if (mailCodeInfo == null || System.currentTimeMillis() - mailCodeInfo.getCreateTime().getTime() > Constant.MIN_5_TO_MILLIS) {
                throw new BusinessException(CommonMsg.MAIL_CHECK_CODE_ERROR);
            }
            userInfo.setPassword(StrUtil.encodeMD5(password));
            userInfo.setUpdateTime(new Date());
            edit(userInfo);
        } finally {
            // æ— è®ºæ˜¯å¦å¼‚å¸¸ï¼Œéƒ½å°†é‚®ç®±éªŒè¯ç ç½®ä¸ºæ— æ•ˆï¼Œæ‰€ä»¥ä¸åŠ äº‹åŠ¡ä¼šæ›´å¥½
            mailCodeService.editToUsedByMail(mail);
        }
    }
```

é¦–å…ˆæ ¡éªŒé‚®ç®±æ˜¯å¦å­˜åœ¨ï¼Œè¿™ä¸€æ­¥æ˜¯å¿…è¦çš„ï¼Œé˜²æ­¢åˆ«äººç»•è¿‡å‰ç«¯é€šè¿‡ä¸€ä¸ªä¸å­˜åœ¨çš„é‚®ç®±ç›´æ¥è¯·æ±‚åç«¯ã€‚ç„¶åæ ¡éªŒé‚®ç®±éªŒè¯ç ï¼Œè‹¥å­˜åœ¨ä¸”æœªè¿‡æœŸå°±æ›´æ–°æ–°å¯†ç åˆ°æ•°æ®åº“ï¼Œæ›´æ–°æˆåŠŸåå°†é‚®ç®±éªŒè¯ç ç½®ä¸ºæ— æ•ˆã€‚
