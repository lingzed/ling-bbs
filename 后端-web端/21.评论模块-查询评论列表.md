# 1 è¯„è®ºçš„ç»„æˆç»“æ„

## 1.1 è¯„è®ºå±‚æ¬¡ç»“æ„

é¦–å…ˆçœ‹ä¸€ä¸‹è¯„è®ºé•¿ä»€ä¹ˆæ ·ï¼Œä»¥Bç«™çš„è¯„è®ºä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20250122104205787](assets/image-20250122104205787.png)

æ•´ä¸ªè¯„è®ºåˆ—è¡¨å¯ä»¥åˆ’åˆ†ä¸º1çº§è¯„è®ºå’Œ2çº§è¯„è®ºï¼Œå…¶ä¸­1çº§è¯„è®ºæ˜¯å¯¹ç›®æ ‡(è§†é¢‘ã€æ–‡ç« ã€å¸–å­ç­‰)è¿›è¡Œè¯„è®ºï¼Œè€Œ2çº§è¯„è®ºæ˜¯å¯¹1çº§è¯„è®ºè¿›è¡Œå›å¤ã€‚æ•´ä¸ªè¯„è®ºå±‚æ¬¡åªåˆ°ä¸¤å±‚ï¼Œå¦‚æœè¦å¯¹2çº§è¯„è®ºè¿›è¡Œå›å¤ï¼Œé‚£ä¹ˆå°±ä»¥@æŸäººçš„æ–¹å¼æ¥æ˜ç¡®æŒ‡å®šå›å¤å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20250122115448268](assets/image-20250122115448268.png)

å½“ç„¶ä¹Ÿå¯ä»¥ç”¨æ ‘å½¢ç»“æ„å±•ç¤ºå›å¤å±‚æ¬¡ï¼Œä½†æ˜¯éšç€å­çº§å›å¤çš„å¢å¤šï¼Œæ ‘çš„æ·±åº¦ä¹Ÿä¼šå¢åŠ ï¼Œæ„å»ºæ ‘å½¢æ¶ˆè€—çš„æœåŠ¡å™¨èµ„æºä¼šå¢å¤§ï¼Œè¿˜å¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·ä½“éªŒçš„ä¸‹é™ã€‚

---

## 1.2 è¯„è®ºåˆ†é¡µ

è¯„è®ºç³»ç»Ÿé€šå¸¸æ˜¯éœ€è¦åˆ†é¡µçš„ï¼Œå› ä¸ºä¸€ç¯‡æ–‡ç« çš„è¯„è®ºæ•°é‡å¯èƒ½éå¸¸åºå¤§ï¼Œå¦‚æœå°†æ‰€æœ‰è¯„è®ºä¸€æ¬¡æ€§åŠ è½½å‡ºæ¥ï¼ŒåŠ¿å¿…ä¼šå¯¹æ•°æ®åº“é€ æˆå·¨å¤§å‹åŠ›ï¼Œåˆ†é¡µèƒ½å‡å°‘ä¸€æ¬¡è¯·æ±‚çš„æ•°æ®é‡ã€‚

ä»¥Bç«™ä¸ºä¾‹ï¼ŒBç«™åœ¨å¤„ç†1çº§è¯„è®ºçš„åˆ†é¡µæ—¶æ²¡æœ‰é‡‡ç”¨ç åˆ†é¡µæ–¹å¼ï¼Œè€Œæ˜¯é€šè¿‡æ»šåŠ¨çª—å£å’Œè§†å·®è®¡ç®—æ¥åŠ¨æ€åŠ è½½è¯„è®ºé¡µé¢ã€‚å…·ä½“å®ç°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20250122133701200](assets/image-20250122133701200.png)

é€šå¸¸æƒ…å†µä¸‹ï¼Œæ¯é¡µè¯·æ±‚çš„1çº§è¯„è®ºæ¡æ•°æ˜¯å›ºå®šçš„(å¤šå°‘çœ‹éœ€æ±‚)ã€‚

è€Œ2çº§è¯„è®ºåˆ™é‡‡ç”¨é¡µç åˆ†é¡µï¼Œæ¯é¡µæ˜¾ç¤ºå›ºå®š10æ¡è¯„è®ºï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20250122140848268](assets/image-20250122140848268.png)

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œ1çº§è¯„è®ºå’Œ2çº§è¯„è®ºå‡é‡‡ç”¨é¡µç åˆ†é¡µï¼Œä¸”æ¯é¡µæ¡ç›®å‡ä¸º10ã€‚

---

# 2 è¯„è®ºè¡¨

è¡¨ç»“æ„å¦‚ä¸‹ï¼š

```sql
create table comment
(
    comment_id        int auto_increment comment 'è¯„è®ºid'
        primary key,
    p_comment_id      int               null comment 'çˆ¶çº§è¯„è®ºid',
    article_id        varchar(15)       not null comment 'æ–‡ç« id',
    img_path          varchar(150)      null comment 'å›¾ç‰‡è·¯å¾„',
    content           varchar(800)      not null comment 'è¯„è®ºå†…å®¹',
    sender_id         varchar(15)       not null comment 'è¯„è®ºå‘é€äººid',
    sender_nickname   varchar(50)       not null comment 'è¯„è®ºå‘é€äººæ˜µç§°',
    sender_ip_address varchar(150)      not null comment 'è¯„è®ºå‘é€äººIPåœ°å€',
    receiver_id       varchar(15)       null comment 'è¢«å›å¤äººid',
    receiver_nickname varchar(15)       null comment 'è¢«å›å¤äººæ˜µç§°',
    top_type          tinyint default 0 not null comment '0: æœªç½®é¡¶, 1: ç½®é¡¶',
    like_count        bigint  default 0 not null comment 'ç‚¹èµé‡',
    status            tinyint default 1 not null comment '0: å·²åˆ é™¤, 1: å¾…å®¡æ ¸, 2: å·²å®¡æ ¸',
    post_time         datetime          not null comment 'å‘å¸ƒæ—¶é—´'
)
    comment 'è¯„è®ºè¡¨';

create index comments_article_id_index
    on comment (article_id);

create index comments_p_comment_id_index
    on comment (p_comment_id);

create index comments_post_time_index
    on comment (post_time);

create index comments_sender_id_index
    on comment (sender_id);

create index comments_status_index
    on comment (status);

create index comments_top_type_index
    on comment (top_type);
```

---

# 3 æŸ¥è¯¢è¯„è®ºåˆ—è¡¨

## 3.1 éœ€æ±‚åˆ†æ

**æ¥å£**ï¼š

è¯„è®ºæŸ¥è¯¢åˆ†ä¸º2ä¸ªæ¥å£ï¼š

- æŸ¥è¯¢1çº§è¯„è®ºï¼šåŒæ—¶æŸ¥è¯¢1çº§è¯„è®ºä¸‹çš„ç¬¬1é¡µ2çº§è¯„è®ºã€‚
- æŸ¥è¯¢2çº§è¯„è®ºã€‚

åœ¨æŸ¥è¯¢1çº§è¯„è®ºæ—¶ï¼Œéœ€è¦åŒæ—¶è·å–è¯¥è¯„è®ºä¸‹çš„ç¬¬1é¡µ2çº§è¯„è®ºæ•°æ®ã€‚å› ä¸º1çº§è¯„è®ºä¸å…¶ç›´æ¥å­è¯„è®ºå­˜åœ¨å…³è”ï¼ŒæŸ¥è¯¢æ—¶éœ€è¦ç¡®ä¿1çº§è¯„è®ºåŠå…¶å¯¹åº”çš„2çº§è¯„è®ºèƒ½å¤Ÿä¸€å¹¶è¿”å›ï¼Œä»¥ä¾¿å±•ç¤ºå®Œæ•´çš„è¯„è®ºä¿¡æ¯ã€‚

è€Œå¯¹äº2çº§è¯„è®ºçš„æŸ¥è¯¢ï¼Œåˆ™éœ€è¦å•ç‹¬è¿›è¡Œã€‚2çº§è¯„è®ºæ˜¯å¯¹1çº§è¯„è®ºçš„å›åº”ï¼Œå®ƒä»¬æ˜¯ç‹¬ç«‹çš„è¯„è®ºå®ä½“ï¼Œå› æ­¤åœ¨æŸ¥è¯¢æ—¶éœ€è¦å•ç‹¬æ‰§è¡Œåˆ†é¡µæ“ä½œï¼Œä»¥ç¡®ä¿æ¯æ¬¡åªè¿”å›æŒ‡å®šé¡µç çš„2çº§è¯„è®ºæ•°æ®ã€‚

**æ•°æ®åˆ†é¡µ**ï¼š

è¯„è®ºå¾ˆæ˜æ˜¾æ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ä¸€æ¬¡æ€§æŸ¥è¯¢å‡º1ã€2çº§è¯„è®ºåè¿›è¡Œæ ‘åŒ–ï¼Œè€Œæ˜¯åº”è¯¥åˆ†å¼€æŸ¥è¯¢1çº§è¯„è®ºå’Œ2çº§è¯„è®ºï¼Œå†ç»„åˆã€‚è¿™ç§è®¾è®¡çš„åŸå› åœ¨äºè¯„è®ºåˆ†é¡µçš„ç‰¹æ€§ã€‚

å‡è®¾ç°åœ¨è¯„è®ºè¡¨ä¸­æœ‰3æ¡1çº§è¯„è®ºå’Œ9æ¡2çº§è¯„è®ºï¼Œè¿™9æ¡è¯„è®ºå…¨éƒ¨æ˜¯ç¬¬ä¸€æ¡1çº§è¯„è®ºçš„å­è¯„è®ºï¼Œè¿™äº›è¯„è®ºå‡æ¥è‡ªåŒä¸€ç¯‡æ–‡ç« ï¼Œå¦‚æœæˆ‘ä»¬ä¸€æ¬¡æ€§æŸ¥å‡ºç¬¬ä¸€é¡µçš„æ•°æ®ï¼ŒæŸ¥è¯¢ç»“æœå°†æ˜¯ç¬¬ä¸€æ¡1çº§è¯„è®ºå’Œ9æ¡2çº§è¯„è®º(æ¯é¡µ10æ¡ç›®)ï¼Œç»è¿‡æ ‘åŒ–å¤„ç†ï¼Œæœ€åä¼šå½¢æˆäº†1æ¡æ ‘å½¢ç»“æ„çš„è¯„è®ºï¼Œä½†å®é™…ä¸Šè¿™ç¯‡æ–‡ç« åº”è¯¥æœ‰3æ¡1çº§è¯„è®ºï¼Œè€Œä¸æ˜¯åªæœ‰1æ¡ï¼Œè¿˜æœ‰ä¸¤æ¡è¢«åˆ†é¡µè¿‡æ»¤æ‰äº†ã€‚

è¿™ç§åˆ†é¡µæ–¹å¼åœ¨æ ‘å½¢æ•°æ®å¤„ç†ä¸­å¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸¢å¤±ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªèƒ½åˆ†åˆ«å¯¹1çº§è¯„è®ºå’Œ2çº§è¯„è®ºè¿›è¡Œç‹¬ç«‹çš„åˆ†é¡µæŸ¥è¯¢ï¼Œç„¶åå°†æŸ¥è¯¢ç»“æœç»„åˆï¼Œæ‰èƒ½ç¡®ä¿æœ€ç»ˆè¿”å›å®Œæ•´çš„è¯„è®ºåˆ—è¡¨ã€‚

---

## 3.2 ğŸŒæŸ¥è¯¢1çº§è¯„è®ºæ¥å£

åœ°å€ï¼š

```
localhost:8091/web/comments
```

æ–¹æ³•ï¼š

`GET`

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å    | ç±»å‹     | å¿…å¡«é¡¹  | è¯´æ˜                       |
| --------- | -------- | ------- | -------------------------- |
| articleId | `string` | `true`  | æ–‡ç« id                     |
| orderType | `int`    | `false` | è¯„è®ºæ’åºï¼Œ0: çƒ­é—¨, 1: æœ€æ–° |
| page      | `int`    | `false` | é¡µç                        |

å“åº”ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "total": 11,
        "page": 1,
        "pageSize": 10,
        "pageTotal": 2,
        "rows": [
            {
                "commentId": 1,
                "pCommentId": 0,
                "articleId": "uukicbc29eqo",
                "imgPath": null,
                "content": "å·«å¸ˆ3æ”»ç•¥å¼€æ–°å‘ï¼Œè¿‡å‡ å¤©ä¸Šä¼ ç¬¬2ç« ï¼Œè¯·å¤§å®¶å¤šå¤šæ”¯æŒğŸ‘ğŸ‘ğŸ‘ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å»çœ‹æˆ‘çš„å…¶ä»–æ”»ç•¥",
                "senderId": "9619980088",
                "senderNickname": "ling",
                "senderIpAddress": "å››å·çœ",
                "receiverId": null,
                "receiverNickname": null,
                "likeCount": 12,
                "postTime": "2025-01-19 05:25:05",
                "doLike": false,
                "subComment": {
                    "total": 2,
                    "page": 1,
                    "pageSize": 10,
                    "pageTotal": 1,
                    "rows": [
                        {
                            "commentId": 6,
                            "pCommentId": 1,
                            "articleId": "uukicbc29eqo",
                            "imgPath": null,
                            "content": "ä½œè€…å¿«å‡ºç¬¬2ç« æ”»ç•¥",
                            "senderId": "9876175182",
                            "senderNickname": "user_189",
                            "senderIpAddress": "å››å·çœ",
                            "receiverId": null,
                            "receiverNickname": null,
                            "likeCount": 0,
                            "postTime": "2025-01-19 05:32:56",
                            "doLike": false,
                            "subComment": null
                        },
                        ...
                    ]
                }
            },
            ...
        ]
    }
}
```

---

## 3.3 æŸ¥è¯¢1çº§è¯„è®ºæ¥å£å®ç°

åœ¨æŸ¥è¯¢1çº§è¯„è®ºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ†ä¸¤æ­¥æ‰§è¡Œï¼šé¦–å…ˆæŸ¥è¯¢1çº§è¯„è®ºï¼Œå…¶æ¬¡æŸ¥è¯¢1çº§è¯„è®ºä¸‹ç¬¬1é¡µçš„2çº§è¯„è®ºã€‚å…·ä½“å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š

æŸ¥è¯¢1çº§è¯„è®ºï¼š

- æ–‡ç« idã€‚
- æ’åºç±»å‹ã€‚
- ç™»å½•çŠ¶æ€
- é¡µç ã€‚
- æ¯é¡µ10æ¡ç›®ã€‚

ç™»å½•çŠ¶æ€å½±å“è¯„è®ºè¡¨çš„`status`å­—æ®µï¼Œå’Œæ–‡ç« çŠ¶æ€ä¸€æ ·ï¼š

- ç®¡ç†å‘˜ä¸èƒ½æŸ¥çœ‹åˆ é™¤çš„è¯„è®ºã€‚
- æ™®é€šç™»å½•ç”¨æˆ·ï¼Œèƒ½æŸ¥çœ‹å®¡æ ¸è¯„è®ºæˆ–è‡ªå·±çš„å¾…å®¡æ ¸çš„è¯„è®ºã€‚
- æœªç™»å½•ç”¨æˆ·åªèƒ½æŸ¥çœ‹å®¡æ ¸è¯„è®ºã€‚

æŸ¥è¯¢SQLå¦‚ä¸‹ï¼š

```xml
<!-- ç®¡ç†å‘˜ä¸èƒ½çœ‹åˆ é™¤çš„è¯„è®º -->
<if test="isAdmin != null and isAdmin">
    and status != 0
</if>
<!-- æ™®é€šç”¨æˆ·åªèƒ½çœ‹å®¡æ ¸æˆ–è‡ªå·±çš„æœªå®¡æ ¸è¯„è®º -->
<if test="userId != null and userId != '' and !isAdmin">
    and (status = 2 or (status = 1 and sender_id = #{userId}))
</if>
<!-- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹å®¡æ ¸çš„è¯„è®º -->
<if test="userId == null or userId == ''">
    and status = 2
</if>
```

å¦å¤–ï¼Œåœ¨æŸ¥è¯¢1çº§è¯„è®ºæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµäº†è¯¥è¯„è®ºã€‚ç‚¹èµçŠ¶æ€è®°å½•åœ¨`like_recode`è¡¨ä¸­ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸`like_recode`è¡¨è¿›è¡Œè”æŸ¥ã€‚å¦‚æœè®°å½•å­˜åœ¨ï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·å·²ç‚¹èµï¼Œå¦åˆ™è¡¨ç¤ºæœªç‚¹èµã€‚ä¸ºæ­¤ï¼ŒæŸ¥è¯¢ä¸­éœ€è¦æ·»åŠ å­æŸ¥è¯¢æ¥åˆ¤æ–­ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€ï¼ŒSQLå¦‚ä¸‹ï¼š

```xml
<sql id="queryCondition">
    <where>
        <if test="articleId != null and articleId != ''">
            article_id = #{articleId}
        </if>
        <if test="pCommentId != null">
            and p_comment_id = #{pCommentId}
        </if>
        <if test="commentId != null">
            and comment_id = #{commentId}
        </if>
        <if test="senderId != null and senderId != ''">
            and sender_id = #{senderId}
        </if>
        <!-- ç®¡ç†å‘˜ä¸èƒ½çœ‹åˆ é™¤çš„è¯„è®º -->
        <if test="isAdmin != null and isAdmin">
            and status != 0
        </if>
        <!-- æ™®é€šç”¨æˆ·åªèƒ½çœ‹å®¡æ ¸æˆ–è‡ªå·±çš„æœªå®¡æ ¸è¯„è®º -->
        <if test="userId != null and userId != '' and !isAdmin">
            and (status = 2 or (status = 1 and sender_id = #{userId}))
        </if>
        <!-- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹å®¡æ ¸çš„è¯„è®º -->
        <if test="userId == null or userId == ''">
            and status = 2
        </if>
        <if test="status != null">
            and status = #{status}
        </if>
    </where>
</sql>

<select id="selectByCondition" resultType="com.ling.entity.po.Comment">
    select
    <include refid="commonField"/>
    <!-- å…³è”ç‚¹èµè®°å½•è¡¨ï¼Œå¦‚æœæœ‰è®°å½•åˆ™ç‚¹è¿‡èµï¼Œå¦åˆ™æœªç‚¹èµ -->
    <if test="userId != null">
        , (select count(0) from like_recode where target_id = comment_id and liker_id = #{userId}) do_like
    </if>
    from comment
    <include refid="queryCondition"/>
    <if test="orderBy != null and orderBy != ''">
        order by #{orderBy}
    </if>
    <if test="index != null and size != null">
        limit #{index}, #{size}
    </if>
</select>
```

åœ¨ä¸Šé¢çš„SQLä¸­ï¼Œæˆ‘ä½¿ç”¨äº†å­æŸ¥è¯¢æ¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯¹æŸæ¡è¯„è®ºè¿›è¡Œäº†ç‚¹èµã€‚å…·ä½“è€Œè¨€ï¼Œå­æŸ¥è¯¢é€šè¿‡`targetId`(è¯„è®ºidï¼Œæ¥è‡ªçˆ¶æŸ¥è¯¢çš„æ¯è¡Œcomment_id)å’Œ`likerId`(ç‚¹èµäººid)ï¼Œåœ¨`like_recode`è¡¨ä¸­æŸ¥æ‰¾è®°å½•æ¥åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²å¯¹è¯¥è¯„è®ºè¿›è¡Œç‚¹èµã€‚å¦‚æœåœ¨`like_recode`è¡¨ä¸­æœ‰ç›¸åº”è®°å½•ï¼Œå­æŸ¥è¯¢å°†è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚

> åœ¨MySQLä¸­ï¼Œå¸ƒå°”å€¼è¡¨ç¤ºä¸º1å’Œ0ï¼Œè€ŒMyBatisæ¡†æ¶ä¼šè‡ªåŠ¨å°†1å’Œ0æ˜ å°„ä¸º`true`å’Œ`false`ã€‚

é‚£ä¹ˆ1å’Œ0å¯ä»¥ä½œä¸ºå¸ƒå°”å€¼è¡¨ç¤º**å·²ç‚¹èµ**å’Œ**æœªç‚¹èµ**çš„çŠ¶æ€ï¼Œæ˜ å°„ä¸º`true`å’Œ`false`ï¼Œç”¨äºè¡¨ç¤ºç‚¹èµçŠ¶æ€ã€‚

è€Œæœªç™»å½•ç”¨æˆ·æŸ¥è¯¢ï¼Œä¸éœ€è¦æŸ¥è¯¢ç‚¹èµçŠ¶æ€ï¼Œå› æ­¤ç”¨`userId`æ§åˆ¶ã€‚

ç„¶åæŸ¥è¯¢2çº§è¯„è®ºï¼Œæ¥è‡ªäºä¸Šé¢çš„1çº§è¯„è®ºï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ”¶é›†1çº§è¯„è®ºçš„idä½œä¸º2çº§è¯„è®ºçš„çˆ¶idï¼ŒæŸ¥è¯¢æ¡ä»¶å¦‚ä¸‹ï¼š

- æ–‡ç« idã€‚
- çˆ¶idåˆ—è¡¨ã€‚
- æ’åºç±»å‹ï¼Œé»˜è®¤ä¸ºçƒ­é—¨ã€‚
- ç™»å½•çŠ¶æ€ã€‚
- é¡µç é»˜è®¤ç¬¬1é¡µã€‚
- æ²¡æœ‰10æ¡ç›®ã€‚

ä¸1çº§è¯„è®ºæŸ¥è¯¢ç±»ä¼¼ï¼Œè¯„è®ºçŠ¶æ€å’Œç‚¹èµçŠ¶æ€åœ¨2çº§è¯„è®ºæŸ¥è¯¢ä¸­ä¹Ÿæœ‰ç›¸åŒçš„è§„åˆ™ï¼ŒSQLå¦‚ä¸‹ï¼š

```xml
<sql id="queryCondition">
    <where>
        <if test="articleId != null and articleId != ''">
            article_id = #{articleId}
        </if>
        <if test="pCommentId != null">
            and p_comment_id = #{pCommentId}
        </if>
        <if test="commentId != null">
            and comment_id = #{commentId}
        </if>
        <if test="senderId != null and senderId != ''">
            and sender_id = #{senderId}
        </if>
        <!-- ç®¡ç†å‘˜ä¸èƒ½çœ‹åˆ é™¤çš„è¯„è®º -->
        <if test="isAdmin != null and isAdmin">
            and status != 0
        </if>
        <!-- æ™®é€šç”¨æˆ·åªèƒ½çœ‹å®¡æ ¸æˆ–è‡ªå·±çš„æœªå®¡æ ¸è¯„è®º -->
        <if test="userId != null and userId != '' and !isAdmin">
            and (status = 2 or (status = 1 and sender_id = #{userId}))
        </if>
        <!-- æœªç™»å½•ç”¨æˆ·åªèƒ½çœ‹å®¡æ ¸çš„è¯„è®º -->
        <if test="userId == null or userId == ''">
            and status = 2
        </if>
        <if test="status != null">
            and status = #{status}
        </if>
        <if test="pIds != null">
            and p_comment_id in
            <foreach collection="pIds" item="id" separator="," open="(" close=")">
                #{id}
            </foreach>
        </if>
    </where>
</sql>

<select id="selectByCondition" resultType="com.ling.entity.po.Comment">
    select
    <include refid="commonField"/>
    <!-- å…³è”ç‚¹èµè®°å½•è¡¨ï¼Œå¦‚æœæœ‰è®°å½•åˆ™ç‚¹è¿‡èµï¼Œå¦åˆ™æœªç‚¹èµ -->
    <if test="userId != null">
        , (select count(0) from like_recode where target_id = comment_id and liker_id = #{userId}) do_like
    </if>
    from comment
    <include refid="queryCondition"/>
    <if test="orderBy != null and orderBy != ''">
        order by #{orderBy}
    </if>
    <if test="index != null and size != null">
        limit #{index}, #{size}
    </if>
</select>
```

å°±æ˜¯å¢åŠ äº†ä¸€ä¸ªçˆ¶idåˆ—è¡¨çš„æŸ¥è¯¢æ¡ä»¶ã€‚

ä¸šåŠ¡å±‚å¢åŠ æ¥å£ï¼š

```java
/**
     * æŸ¥è¯¢1çº§è¯„è®ºå’Œ1çº§è¯„è®ºä¸‹2çº§è¯„è®º, å‡ä¸ºå‰10æ¡
     *
     * @param commentQueryDto
     * @return
     */
    PageBean<CommentVo> findLeve1andLeve2Top10(CommentQueryDto commentQueryDto);
```

å®ç°ï¼š

```java
@Override
    public PageBean<CommentVo> findLeve1andLeve2Top10(CommentQueryDto commentQueryDto) {
        // 1çº§è¯„è®º
        List<CommentVo> commentVos = commentMapper.selectByCondition(commentQueryDto).stream().map(e -> {
            CommentVo commentVo = new CommentVo();
            BeanUtils.copyProperties(e, commentVo);
            return commentVo;
        }).collect(Collectors.toList());
        Long total = findTotalByCondition(commentQueryDto);

        if (!commentVos.isEmpty()) {
            CommentQueryDto subCommentQuery = new CommentQueryDto();
            subCommentQuery.setArticleId(commentQueryDto.getArticleId());
            subCommentQuery.setUserId(commentQueryDto.getUserId());
            subCommentQuery.setAdmin(commentQueryDto.isAdmin());
            subCommentQuery.setOrderBy(CommentOrderEnum.HOT.getOrderBy());
            List<Integer> pCommentIds = commentVos.stream().map(CommentVo::getCommentId).collect(Collectors.toList());
            subCommentQuery.setpIds(pCommentIds);
            List<Comment> subComments = commentMapper.selectByCondition(subCommentQuery);   // 2çº§è¯„è®º
            // 2çº§è¯„è®ºè½¬æ¢ä¸ºvoåŒæ—¶æŒ‰pidåˆ†ç»„
            Map<Integer, List<CommentVo>> byPid = subComments.stream().map(e -> {
                CommentVo commentVo = new CommentVo();
                BeanUtils.copyProperties(e, commentVo);
                return commentVo;
            }).collect(Collectors.groupingBy(CommentVo::getpCommentId));
            // ç»„åˆ1çº§å’Œ2çº§è¯„è®º
            commentVos.forEach(e -> {
                List<CommentVo> subList = byPid.get(e.getCommentId());
                if (Objects.isNull(subList)) return;
                // æˆªå–å‰10æ¡
                List<CommentVo> limitList = subList.stream()
                        .limit(PageSizeEnum.SIZE_10.getPageSize())
                        .collect(Collectors.toList());
                Long subTotal = (long) subList.size();
                e.setSubComment(PageBean.of(subTotal, 1, PageSizeEnum.SIZE_10.getPageSize(), limitList));
            });
        }
        return PageBean.of(total, commentQueryDto.getPage(), commentQueryDto.getPageSize(), commentVos);
    }
```

å› ä¸º2çº§è¯„è®ºä¹Ÿè¦åˆ†é¡µï¼Œæ‰€ä»¥éœ€è¦å°è£…ä¸ºPageBeanï¼Œå°†2çº§è¯„è®ºæŒ‰pidè¿›è¡Œåˆ†ç»„ï¼Œç„¶åæˆªå–å‡ºå‰10æ¡æ•°æ®ï¼Œåœ¨ä¸1çº§è¯„è®ºç»„åˆã€‚

æ§åˆ¶å™¨ï¼š

åˆ¤æ–­ç³»ç»Ÿè®¾ç½®ä¸­æ˜¯å¦å¼€å¯äº†è¯„è®ºï¼Œè¿™é‡Œä¸è¦å¿˜è®°ï¼š

```java
/**
     * æŸ¥è¯¢1çº§è¯„è®ºå’Œ1çº§è¯„è®ºä¸‹2çº§è¯„è®ºå‰10æ¡
     *
     * @param session
     * @param articleId
     * @param orderType
     * @param page
     * @return
     */
    @GetMapping
    @AccessControl
    public Result<PageBean<CommentVo>> loadComments(HttpSession session,
                                                    @Validation(max = 15) String articleId,
                                                    @RequestParam(defaultValue = "0") @Validation(max = 1) Integer orderType,
                                                    @RequestParam(defaultValue = "1") @Validation Integer page) {
        boolean openComment = SysCacheUtil.getSysSettingContainer().getSysSetting4Comment().isOpenComment();
        if (!openComment)   // è¯„è®ºå¼€å¯æ‰èƒ½è®¿é—®
            throw new BusinessException(ResponseCodeEnum.CODE_404);
        UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        CommentQueryDto commentQueryDto = new CommentQueryDto();
        commentQueryDto.setpCommentId(Constant.NUM_0);
        commentQueryDto.setArticleId(articleId);
        commentQueryDto.setPage(page == 0 ? Constant.NUM_1 : page);
        commentQueryDto.setPageSize(PageSizeEnum.SIZE_10.getPageSize());    // å›ºå®šæ¯é¡µ10æ¡ç›®
        commentQueryDto.setOrderBy(CommentOrderEnum.getOrderByType(orderType));
        commentQueryDto.setUserId(userinfo == null ? null : userinfo.getUserId());
        commentQueryDto.setAdmin(userinfo != null && userinfo.getIsAdmin());
        PageBean<CommentVo> comments = commentService.findLeve1andLeve2Top10(commentQueryDto);
        return Result.success(comments);
    }
```

---

## 3.4 ğŸŒæŸ¥è¯¢2çº§è¯„è®ºæ¥å£

åœ°å€ï¼š

```
localhost:8091/web/comments/level2
```

æ–¹æ³•ï¼š

`GET`

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å      | ç±»å‹     | å¿…å¡«é¡¹  | è¯´æ˜      |
| ----------- | -------- | ------- | --------- |
| articleId   | `string` | `true`  | æ–‡ç« id    |
| pCommentdId | `int`    | `false` | 1çº§è¯„è®ºid |
| page        | `int`    | `false` | é¡µç       |

å“åº”ï¼š

```json
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "total": 1,
        "page": 1,
        "pageSize": 10,
        "pageTotal": 1,
        "rows": [
            {
                "commentId": 6,
                "pCommentId": 1,
                "articleId": "uukicbc29eqo",
                "imgPath": null,
                "content": "ä½œè€…å¿«å‡ºç¬¬2ç« æ”»ç•¥",
                "senderId": "9876175182",
                "senderNickname": "user_189",
                "senderIpAddress": "å››å·çœ",
                "receiverId": null,
                "receiverNickname": null,
                "likeCount": 0,
                "postTime": "2025-01-19 05:32:56",
                "doLike": false,
                "subComment": null
            }
        ]
    }
}
```

---

## 3.5 æŸ¥è¯¢2çº§è¯„è®ºæ¥å£å®ç°

å°±æ˜¯è°ƒç”¨æ¡ä»¶åˆ†é¡µæŸ¥è¯¢çš„æ–¹æ³•ï¼Œç»™å®š1çº§è¯„è®ºçš„idï¼Œå’Œå…¶ä»–æ¡ä»¶ï¼ŒåªæŸ¥å¯¹åº”é¡µç çš„2çº§è¯„è®ºå³å¯ï¼Œ2çº§è¯„è®ºé»˜è®¤ä¸ºçƒ­é—¨æ’åºï¼š

æ§åˆ¶å™¨ï¼š

```java
/**
     * æŸ¥è¯¢2çº§è¯„è®º
     *
     * @param session
     * @param page
     * @param pCommentId
     * @return
     */
    @GetMapping("/level2")
    @AccessControl
    public Result<PageBean<CommentVo>> loadLevel2Comments(HttpSession session,
                                                          @Validation(max = 15) String articleId,
                                                          @RequestParam(defaultValue = "1") @Validation Integer page,
                                                          @Validation Integer pCommentId) {
        boolean openComment = SysCacheUtil.getSysSettingContainer().getSysSetting4Comment().isOpenComment();
        if (!openComment)   // è¯„è®ºå¼€å¯æ‰èƒ½è®¿é—®
            throw new BusinessException(ResponseCodeEnum.CODE_404);
        UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        CommentQueryDto commentQueryDto = new CommentQueryDto();
        commentQueryDto.setArticleId(articleId);
        commentQueryDto.setpCommentId(pCommentId);
        commentQueryDto.setOrderBy(CommentOrderEnum.HOT.getOrderBy());
        commentQueryDto.setPage(page == 0 ? Constant.NUM_1 : page);
        commentQueryDto.setPageSize(PageSizeEnum.SIZE_10.getPageSize());    // å›ºå®šæ¯é¡µ10æ¡ç›®
        commentQueryDto.setUserId(userinfo == null ? null : userinfo.getUserId());
        commentQueryDto.setAdmin(userinfo != null && userinfo.getIsAdmin());
        PageBean<CommentVo> level2Comments = commentService.findByCondition(commentQueryDto);
        return Result.success(level2Comments);
    }
```
