# 1 è¯„è®ºç‚¹èµ

è¯„è®ºç‚¹èµå’Œæ–‡ç« ç‚¹èµçš„å¤„ç†é€»è¾‘ç›¸ä¼¼ï¼Œå…·ä½“éœ€æ±‚åˆ†æå’Œå®ç°è§[18.æ–‡ç« æ¨¡å—-æ–‡ç« ç‚¹èµ.md](18.æ–‡ç« æ¨¡å—-æ–‡ç« ç‚¹èµ.md)ã€‚

åœ¨æ–‡ç« ç‚¹èµåŠŸèƒ½çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å¤„ç†ç‚¹èµçš„æ–¹æ³•ï¼Œå½“æ—¶è€ƒè™‘åˆ°æ–‡ç« å’Œè¯„è®ºéƒ½æ¶‰åŠåˆ°ç‚¹èµï¼Œå› æ­¤å¯¹ç‚¹èµå¤„ç†æ–¹æ³•è¿›è¡Œäº†é€šç”¨åŒ–çš„è®¾è®¡ï¼š

```java
/**
     * å¤„ç†æ–‡ç« ç‚¹èµä¸šåŠ¡ï¼šç‚¹èµè®°å½•å˜æ›´&ç›®æ ‡ç‚¹èµé‡å˜æ›´
     *
     * @param targetId
     * @param authorId
     * @param likerId
     * @param likeType
     * @param changeLikeCount
     * @return
     */
    @Transactional(rollbackFor = Exception.class)
    public boolean processLike(String targetId, String authorId, String likerId, Integer likeType,
                               Consumer<Integer> changeLikeCount) {
        LikeRecode likeRecode = findByTargetIdAndLikerIdAndLikeType(targetId, likerId, likeType);
        boolean notLike = Objects.isNull(likeRecode);
        int likeCount = notLike ? Constant.NUM_1 : Constant.NUM_NEG_1;     // ç‚¹èµå˜æ›´é‡
        if (notLike) {
            LikeRecode lr = new LikeRecode();
            lr.setTargetId(targetId);
            lr.setTargetAuthorId(authorId);
            lr.setLikerId(likerId);
            lr.setLikeType(likeType);
            add(lr);    // æ²¡æœ‰ç‚¹èµè®°å½•å°±å¢åŠ 
        } else {
            delete(Arrays.asList(likeRecode.getLikeRecodeId()));    // æœ‰ç‚¹èµè®°å½•å°±åˆ é™¤
        }
        changeLikeCount.accept(likeCount);    // å˜æ›´ç›®æ ‡ç‚¹èµé‡
        // ä¸æ˜¯ç»™è‡ªå·±çš„æ–‡ç« æˆ–è¯„è®ºç‚¹èµæ‰è®°å½•æ¶ˆæ¯ï¼Œè¿”å›å¯è¡Œæ ‡è¯†
        return notLike && !Objects.equals(authorId, likerId);
    }
```

è¯¥æ–¹æ³•çš„å†…éƒ¨é€»è¾‘èƒ½å¤Ÿè‡ªåŠ¨å¤„ç†ç›®æ ‡ç‚¹èµé‡çš„å¢å‡ï¼ŒåŒæ—¶ä¾æ®ç‚¹èµè®°å½•å†³å®šæ˜¯å¦è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚æœ€ç»ˆï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªçŠ¶æ€æ ‡è¯†ï¼Œè¯¥æ ‡è¯†ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦è®°å½•ç‚¹èµæ¶ˆæ¯ã€‚æˆ‘ä»¬åªéœ€å°†å®é™…å˜æ›´ç›®æ ‡ç‚¹èµé‡çš„æ–¹æ³•ä¼ å…¥æ­¤æ–¹æ³•å³å¯å®Œæˆç‚¹èµçš„å¤„ç†ã€‚

---

## 1.1 ğŸŒè¯„è®ºç‚¹èµæ¥å£

åœ°å€ï¼š

```
localhost:8091/web/comments/like
```

æ–¹æ³•ï¼š

`POST`

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å    | ç±»å‹  | å¿…å¡«é¡¹ | è¯´æ˜   |
| --------- | ----- | ------ | ------ |
| commentId | `int` | `true` | è¯„è®ºid |

å“åº”ï¼š

```java
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "commentId": 4,
        "likeCount": 79,
        "doLike": false
    }
}
```

è¿™é‡Œæˆ‘è¿”å›çš„æ˜¯`CommentLikeInfo`ï¼Œå³è¯„è®ºç‚¹èµä¿¡æ¯è§†å›¾å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š

```java
package com.ling.entity.vo;

/**
 * è¯„è®ºç‚¹èµä¿¡æ¯
 */
public class CommentLikeInfo {
    private Integer commentId;
    private Integer likeCount;
    private boolean doLike;

    public Integer getCommentId() {
        return commentId;
    }

    public void setCommentId(Integer commentId) {
        this.commentId = commentId;
    }

    public Integer getLikeCount() {
        return likeCount;
    }

    public void setLikeCount(Integer likeCount) {
        this.likeCount = likeCount;
    }

    public boolean isDoLike() {
        return doLike;
    }

    public void setDoLike(boolean doLike) {
        this.doLike = doLike;
    }
}
```

è¡¨ç¤ºç‚¹èµçš„ä¿¡æ¯ï¼šç‚¹èµæ•°é‡å’Œæ˜¯å¦ç‚¹èµã€‚è¿”å›ç»™å‰ç«¯ï¼Œä½¿å‰ç«¯èƒ½å¤Ÿå³æ—¶è·å–å¹¶å±•ç¤ºè¢«ç‚¹èµè¯„è®ºçš„æœ€æ–°ç‚¹èµçŠ¶æ€ä¸ç‚¹èµé‡ï¼Œè¿™æ ·çš„è¿”å›ä»…æ¶‰åŠåˆ°è¢«ç‚¹èµçš„é‚£æ¡è¯„è®ºï¼Œè€Œä¸æ˜¯å…¨éƒ¨è¯„è®ºæ•°æ®ã€‚

å½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©ä¸è¿”å›ï¼Œé‚£ä¹ˆå‰ç«¯å°±éœ€è¦åˆ·æ–°é¡µé¢é‡æ–°è·å–è¯„è®ºåˆ—è¡¨ï¼Œä»¥æ›´æ–°ç‚¹èµçŠ¶æ€å’Œç‚¹èµé‡ã€‚è¿™ç§æ–¹å¼ä¹Ÿèƒ½ä¿è¯æ•°æ®å®æ—¶æ›´æ–°ï¼Œä½†ä¼šå¤šä¸€æ¬¡è¯·æ±‚ï¼ŒåŒæ—¶ä¹Ÿä¼šé‡æ–°åŠ è½½æ‰€æœ‰è¯„è®ºä¿¡æ¯ï¼Œè€Œä¸ä»…ä»…æ˜¯æ›´æ–°è¢«ç‚¹èµçš„è¯„è®ºæ•°æ®ï¼Œä½†æ˜¯å…¶ä»–è¯„è®ºæ•°æ®æ˜¯æ²¡æœ‰å˜åŒ–çš„ã€‚ç‚¹èµåªä¼šå½±å“åˆ°è¯„è®ºçš„ç‚¹èµé‡å’Œç‚¹èµçŠ¶æ€ï¼Œè¯„è®ºçš„å†…å®¹ã€å‘å¸ƒäººã€å›å¤äººã€å‘å¸ƒæ—¶é—´...è¿™äº›æ•°æ®æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œè¿™ç§å°±å±äºä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚ã€‚

---

## 1.2 æ¥å£å®ç°

å¢åŠ ä¸€ä¸ªæŸ¥è¯¢ç‚¹èµä¿¡æ¯çš„SQLï¼š

```xml
<!-- æŸ¥è¯¢è¯„è®ºçš„ç‚¹èµé‡å’Œç‚¹èµçŠ¶æ€ -->
    <select id="selectCommentLikeInfo" resultType="com.ling.entity.vo.CommentLikeInfo">
        select comment_id,
               like_count,
               (select count(0) from like_recode where target_id = #{commentId} and liker_id = #{userId}) doLike
        from comment
        where comment_id = #{commentId}
    </select>
```

**ä¸šåŠ¡å±‚**ï¼š

```java
/**
     * å¤„ç†è¯„è®ºç‚¹èµ
     *
     * @param commentId
     * @param userInfo
     * @return
     */
    void processCommentLike(Integer commentId, UserInfoSessionDto userInfo);
```

```java
/**
     * å¤„ç†è¯„è®ºç‚¹èµ
     *
     * @param commentId
     * @param userInfo
     * @return
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void processCommentLike(Integer commentId, UserInfoSessionDto userInfo) {
        Comment comment = findById(commentId);
        if (Objects.isNull(comment))
            throw new BusinessException(CommonMsg.COMMENT_NOT_EXISTS);
        // å·²å®¡æ ¸æ‰èƒ½ç‚¹èµ
        if (!Objects.equals(comment.getStatus(), TargetStatusEnum.AUDITED.getStatus()))
            throw new BusinessException(CommonMsg.ONLY_LIKE_AUDITED_COMMENT);
        boolean canRecodeMsg = likeRecodeService.processLike(String.valueOf(commentId), comment.getSenderId(),
                userInfo.getUserId(),
                LikeTypeEnum.COMMENT.getType(),
                likeCount -> editLikeCount(likeCount, commentId));
        if (canRecodeMsg) {
            UserMessage userMessage = new UserMessage();
            userMessage.setReceivedUserId(comment.getSenderId());
            userMessage.setCommentId(commentId);
            userMessage.setSendUserId(userInfo.getUserId());
            userMessage.setSendNickName(userInfo.getNickName());
            userMessage.setMessageType(MessageTypeEnum.COMMENT_LIKE.getType());
            userMessage.setMessageContent(Constant.COMMENT_LIKE_MESSAGE_CONTENT);
            userMessage.setStatus(MessageStatusEnum.NO_READ.getStatus());
            Date date = new Date();
            userMessage.setCreateTime(date);
            userMessage.setUpdateTime(date);
            userMessageMapper.insert(userMessage);
        }
    }
```

**æ³¨æ„**: åˆ¤æ–­è¯„è®ºæ˜¯å¦å­˜åœ¨ä»¥åŠåˆ¤æ–­è¯„è®ºæ˜¯å¦æ˜¯å·²å®¡æ ¸ï¼Œåªæœ‰å·²å®¡æ ¸æ‰èƒ½ç‚¹èµã€‚

**æ§åˆ¶å™¨**ï¼š

ç‚¹èµæ¥å£æ˜¯ç™»å½•æ¥å£ï¼š

```java
@PostMapping("/like")
    @AccessControl(loginRequired = true)
    public Result<CommentLikeInfo> commentLikeHandle(HttpSession session, @Validation Integer commentId) {
        UserInfoSessionDto userInfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        commentService.processCommentLike(commentId, userInfo);
        // è¿”å›è¢«ç‚¹èµçš„è¯„è®ºæœ€æ–°çš„ç‚¹èµé‡å’Œç‚¹èµçŠ¶æ€ï¼Œå®æ—¶æ›´æ–°ï¼Œå‡å°‘ä¸å¿…è¦çš„è¯·æ±‚
        CommentLikeInfo commentLikeInfo = commentService.findCommentLikeInfo(commentId, userInfo.getUserId());
        return Result.success(commentLikeInfo);
    }
```

è¿™é‡Œä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºè¯·æ±‚ä¸è¯·æ±‚ä¹‹é—´æ˜¯ç‹¬ç«‹çš„å¯ä»¥çœ‹ä½œæ˜¯ä¸åŒçš„çº¿ç¨‹ï¼Œå› æ­¤æ¯ä¸ªè¯·æ±‚éƒ½æœ‰è‡ªå·±çš„æ ˆç©ºé—´ã€‚è€Œ`commentLikeHandle()`å†…éƒ¨ä¼š`new`åˆ›å»ºæ–°çš„`CommentVo`ï¼Œç›¸å½“äºæ¯ä¸ªè¯·æ±‚éƒ½`new`æ–°çš„å¯¹è±¡ï¼Œå„è‡ªæ“ä½œå„è‡ªçš„å¯¹è±¡ï¼Œä¸å­˜åœ¨å…±äº«èµ„æºã€‚