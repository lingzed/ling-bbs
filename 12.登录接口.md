# 1 登录之前的准备

## 1.1 查询IP信息的第三方接口

登录我们需要用到用户的IP，这是一个查询IP信息的接口：

```http
https://whois.pconline.com.cn/ipJson.jsp?json=true&ip=IP地址
```

请求方法：

【GET】

请求参数：

| 参数名 | 必填项 | 说明   |
| ------ | ------ | ------ |
| ip     | `true` | IP地址 |

返回值：

```json
{
  "ip": "171.219.187.76",
  "pro": "四川省",
  "proCode": "510000",
  "city": "成都市",
  "cityCode": "510100",
  "region": "",
  "regionCode": "0",
  "addr": "四川省成都市 电信",
  "regionNames": "",
  "err": ""
}
```

其中，省份【pro】是我们需要的值。

这个请求在我们的场景中由服务器发送，因此需要借用OkHttp工具类向此接口发送用户的IP，获取用户的省份信息。而用户的IP则可以从【HttpServletRequest】中获取，获取的方法如下：

## 1.2  从HttpServletRequest中获取IP

IP工具类如下：

```java
package com.ling.utils;

import javax.servlet.http.HttpServletRequest;

/**
 * IP工具类
 */
public class IPUtil {
    /**
     * 获取客户端IP地址
     *
     * @param request
     * @return
     */
    public static String getIP(HttpServletRequest request) {
        String ip = request.getHeader("x-forwarded-for");
        if (ip != null && !ip.isEmpty() && !ip.equalsIgnoreCase("unknown")) {
            // 多次反向代理后会有多个ip值，第一个ip才是真实ip
            if (ip.contains(",")) {
                ip = ip.split(",")[0];
            }
        }
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("Proxy-Client-IP");  // nginx反向代理
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("WL-Proxy-Client-IP");   // 阿里云反向代理
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("HTTP_CLIENT_IP");   // 西云数据
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("HTTP_X_FORWARDED_FOR"); // 普通代理
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("X-Real-IP");    // 云服务器
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getRemoteAddr();   // 如果没有获取到，就直接取IP
        return ip;
    }
}
```

## 1.3 查询IP信息方法

```java
public String getProvince(String IP) {
    try {
        String url = "https://whois.pconline.com.cn/ipJson.jsp?json=true&ip=" + IP;
        String res = OkHttpUtil.getRequest(url);
        Map resMap = JSON.parseObject(res, Map.class);
        String province = (String) resMap.get("pro");
        return province;
    } catch (Exception e) {
        log.error(CommonMsg.FETCH_FAIL, e);
        return Constant.UNKNOWN;	// 若获取不到IP属地，返回未知
    }
}
```

响应为JSON字符串时，通常解析为对应的实体对象，如果没有实体，则解析为【Map】。

## 1.4 UserInfoSessionDto

【UserInfoSessionDto】对象是用于保存用户会话信息的传输实体。用户登录成功后，我们通常将用户的会话信息存储在【session】中，而这些信息可以通过【UserInfoSessionDto】对象来承载和表示。

补充说明一下，JWT也可以用于维护用户会话，但与传统的【session】不同的是，服务器只负责生成和校验JWT，而存储工作由浏览器完成。当然，在实际应用中，我们也可以结合使用两者，根据需求选择最佳方案。

【UserInfoSessionDto】定义如下：

```java
package com.ling.entity.dto;

/**
 * 用户会话信息传输实体
 */
public class UserInfoSessionDto {
    private String userId;  //  用户id
    private String userName; // 昵称
    private String province; // 省份
    private String isAdmin; // 是否管理员

    public String getUserId() {
        return userId;
    }

    public void setUserId(String userId) {
        this.userId = userId;
    }

    public String getUserName() {
        return userName;
    }

    public void setUserName(String userName) {
        this.userName = userName;
    }

    public String getProvince() {
        return province;
    }

    public void setProvince(String province) {
        this.province = province;
    }

    public String getIsAdmin() {
        return isAdmin;
    }

    public void setIsAdmin(String isAdmin) {
        this.isAdmin = isAdmin;
    }
}
```



# 2 登录接口
