# 1 登录接口

## 1.1 查询IP信息的第三方接口

登录我们需要用到用户的IP，这是一个查询IP信息的接口：

```http
https://whois.pconline.com.cn/ipJson.jsp?json=true&ip=IP地址
```

返回值如下：

```json
{
  "ip": "171.219.187.76",
  "pro": "四川省",
  "proCode": "510000",
  "city": "成都市",
  "cityCode": "510100",
  "region": "",
  "regionCode": "0",
  "addr": "四川省成都市 电信",
  "regionNames": "",
  "err": ""
}
```

其中，省份【pro】是我们需要的值。

这个请求在我们的场景中由服务器发送，因此需要借用OkHttp工具类向此接口发送用户的IP，获取用户的省份信息。而用户的IP则可以从【HttpServletRequest】中获取，获取的方法如下：

## 1.2  从HttpServletRequest中获取IP

IP工具类如下：

```java
package com.ling.utils;

import javax.servlet.http.HttpServletRequest;

/**
 * IP工具类
 */
public class IPUtil {
    /**
     * 获取客户端IP地址
     *
     * @param request
     * @return
     */
    public static String getIP(HttpServletRequest request) {
        String ip = request.getHeader("x-forwarded-for");
        if (ip != null && !ip.isEmpty() && !ip.equalsIgnoreCase("unknown")) {
            // 多次反向代理后会有多个ip值，第一个ip才是真实ip
            if (ip.contains(",")) {
                ip = ip.split(",")[0];
            }
        }
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("Proxy-Client-IP");  // nginx反向代理
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("WL-Proxy-Client-IP");   // 阿里云反向代理
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("HTTP_CLIENT_IP");   // 西云数据
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("HTTP_X_FORWARDED_FOR"); // 普通代理
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getHeader("X-Real-IP");    // 云服务器
        if (ip == null || ip.isEmpty() || ip.equalsIgnoreCase("unknown"))
            ip = request.getRemoteAddr();   // 如果没有获取到，就直接取IP
        return ip;
    }
}
```



