# 1 å‘å¸ƒè¯„è®ºåˆ†æ

åœ¨[21.è¯„è®ºæ¨¡å—-æŸ¥è¯¢è¯„è®ºåˆ—è¡¨](21.è¯„è®ºæ¨¡å—-æŸ¥è¯¢è¯„è®ºåˆ—è¡¨)ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ†æè¿‡äº†è¯„è®ºçš„å±‚æ¬¡ç»“æ„ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ¢è®¨å½±å“è¯„è®ºå±‚çº§å…³ç³»çš„ä¸‰ä¸ªå…³é”®å­—æ®µï¼š

- article_id
- p_comment_id
- receiver_id

ä»è¯„è®ºè¡¨çš„ç»“æ„æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°éƒ¨åˆ†è¯„è®ºè®°å½•åŒ…å« `receiver_id` å­—æ®µï¼Œè€Œå¦ä¸€äº›åˆ™æ²¡æœ‰ã€‚`receiver_id` çš„ä½œç”¨åœ¨äºæ˜ç¡®è¯„è®ºçš„å›å¤å…³ç³»ï¼š

![image-20250221105701921](assets/image-20250221105701921.png)

å…·ä½“è¡¨ç°åœ¨ UI å±•ç¤ºä¸Šï¼Œå³åœ¨è¯„è®ºå†…å®¹å‰ä»¥"@ç”¨æˆ·å" å½¢å¼æ ‡æ³¨è¢«å›å¤å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20250221110037456](assets/image-20250221110037456.png)

ç„¶è€Œï¼Œå¹¶éæ‰€æœ‰è¯„è®ºçš„å›å¤å…³ç³»éƒ½ä¾èµ–äºreceiver_idå­—æ®µã€‚å…·ä½“æ¥è¯´ï¼š

- **1çº§è¯„è®º**ï¼šå³ç›´æ¥å¯¹æ–‡ç« è¿›è¡Œè¯„è®ºçš„è¯„è®ºï¼Œå…¶å›å¤å¯¹è±¡é»˜è®¤ä¸ºæ–‡ç« çš„ä½œè€…ã€‚ç”¨æˆ·èƒ½ç›´æ¥è¯†åˆ«å‡ºå›å¤å…³ç³»ï¼Œç”±äº1çº§è¯„è®ºçš„å›å¤å¯¹è±¡å›ºå®šä¸ºæ–‡ç« ä½œè€…ï¼Œå› æ­¤æ— éœ€ä¾èµ–receiver_idå­—æ®µå³å¯æ˜ç¡®å›å¤å…³ç³»ã€‚

- **2çº§è¯„è®º**ï¼šå³å¯¹1çº§è¯„è®ºçš„å›å¤ï¼Œå…¶å›å¤å¯¹è±¡ä¸º1çº§è¯„è®ºçš„ä½œè€…ã€‚åœ¨é¡µé¢å±•ç¤ºä¸­ï¼Œè¿™ç§å›å¤å…³ç³»é€šå¸¸è¾ƒä¸ºç›´è§‚ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¸Šä¸‹æ–‡ç›´æ¥è¯†åˆ«å‡ºå›å¤å¯¹è±¡ã€‚

- **2çº§è¯„è®ºä¹‹é—´çš„å›å¤**ï¼šå½“2çº§è¯„è®ºå›å¤å¦ä¸€ä¸ª2çº§è¯„è®ºæ—¶ï¼Œæƒ…å†µå˜å¾—å¤æ‚ã€‚ç”±äº1çº§è¯„è®ºä¸‹å¯èƒ½å­˜åœ¨å¤šä¸ª2çº§è¯„è®ºï¼Œè‹¥ä¸å€ŸåŠ©receiver_idå­—æ®µï¼Œå°†æ— æ³•å‡†ç¡®åˆ¤æ–­æŸä¸ª2çº§è¯„è®ºå…·ä½“æ˜¯å›å¤å“ªä¸ª2çº§è¯„è®ºã€‚

---

## 1.1 è¯„è®ºå®¡æ ¸

è¯„è®ºçš„çŠ¶æ€åˆ†ä¸º **"å¾…å®¡æ ¸"** å’Œ **"å·²å®¡æ ¸"**ã€‚è¯„è®ºçš„é»˜è®¤çŠ¶æ€ç”±ç³»ç»Ÿè®¾ç½®ä¸­çš„ `commentAudit` é€‰é¡¹å†³å®šï¼Œè¯¥é€‰é¡¹ç”¨äºæ§åˆ¶è¯„è®ºå®¡æ ¸æœºåˆ¶ï¼š

![image-20250221143801169](assets/image-20250221143801169.png)

- **`commentAudit = true`**ï¼šè¡¨ç¤ºè¯„è®ºéœ€ç»è¿‡å®¡æ ¸ï¼Œåˆå§‹çŠ¶æ€ä¸º **"å¾…å®¡æ ¸"**ï¼Œç®¡ç†å‘˜éœ€æ‰‹åŠ¨å®¡æ ¸åæ‰ä¼šå…¬å¼€æ˜¾ç¤ºã€‚

- **`commentAudit = false`**ï¼šè¡¨ç¤ºè¯„è®ºæ— éœ€å®¡æ ¸ï¼Œæäº¤åå³ç›´æ¥å‘å¸ƒï¼ŒçŠ¶æ€ä¸º **"å·²å®¡æ ¸"**ã€‚

æ­¤å¤–ï¼Œç”¨æˆ·åœ¨å‘å¸ƒè¯„è®ºåå¯è·å¾—ç§¯åˆ†å¥–åŠ±ï¼Œä½†ç§¯åˆ†çš„å®é™…å‘æ”¾ä»…åœ¨è¯„è®ºå®¡æ ¸é€šè¿‡åè¿›è¡Œã€‚å®¡æ ¸é€šè¿‡åï¼Œç³»ç»Ÿå°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **å¢åŠ ç”¨æˆ·ç§¯åˆ†**
2. **æ›´æ–°æ–‡ç« çš„è¯„è®ºæ•°**
3. **è®°å½•ç”¨æˆ·æ¶ˆæ¯é€šçŸ¥**

ä¸ºäº†æ›´æ¸…æ™°åœ°ç®¡ç†è¯„è®ºå‘å¸ƒé€»è¾‘ï¼Œæˆ‘ä»¬å°†è¯„è®ºå‘å¸ƒæ¥å£æ‹†åˆ†ä¸º **1çº§è¯„è®ºæ¥å£** å’Œ **2çº§è¯„è®ºæ¥å£**ï¼Œåˆ†åˆ«å¤„ç†ä¸åŒå±‚çº§çš„è¯„è®ºã€‚

---



# 2 ğŸŒå‘é€1çº§è¯„è®ºæ¥å£

æ¥å£åœ°å€ï¼š

```swift
Post /web/comments/post/l1
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å     | ç±»å‹     | å¿…å¡«é¡¹  | è¯´æ˜     |
| ---------- | -------- | ------- | -------- |
| articleId  | `string` | `true`  | æ–‡ç« id   |
| content    | `string` | `false` | è¯„è®ºå†…å®¹ |
| imgContent | `string` | `false` | å›¾ç‰‡å†…å®¹ |

è¿”å›ç¤ºä¾‹ï¼š

```java
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "commentId": 83,
        "pCommentId": 0,
        "articleId": "ababa",
        "imgPath": null,
        "content": "æ„Ÿè§‰é…è‰²ä¸å¦‚ä¸Šä¸€ä»£å¥½çœ‹",
        "senderAvatar": null,
        "senderId": "9876175182",
        "senderNickname": "user_189",
        "senderIpAddress": "å››å·çœ",
        "receiverId": null,
        "receiverNickname": null,
        "likeCount": 0,
        "topType": 0,
        "status": 2,
        "postTime": "2025-02-20 05:59:02",
        "doLike": false,
        "subComment": null
    }
}
```

è¿”å›ç”¨æˆ·çš„è¯„è®ºï¼Œå‰ç«¯å¯ä»¥ç«‹åˆ»æ˜¾ç¤ºè¿™æ¡è¯„è®ºï¼Œå‡å°‘è¯·æ±‚ï¼Œ2çº§è¯„è®ºä¹Ÿæ˜¯å¦‚æ­¤ã€‚

---

## 1.2 å‘é€1çº§è¯„è®ºæ¥å£å®ç°

åœ¨å¤„ç†è¯„è®ºå‘å¸ƒæ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è¿›è¡Œ **é¢„æ£€**ï¼Œç¡®ä¿ä»¥ä¸‹æ¡ä»¶æ»¡è¶³ï¼š

1. **ç³»ç»Ÿæ˜¯å¦å¼€å¯è¯„è®ºåŠŸèƒ½**ï¼ˆç”± `openComment` é€‰é¡¹æ§åˆ¶ï¼‰
2. **è¯„è®ºå†…å®¹æ˜¯å¦æœ‰æ•ˆ**ï¼ˆ`content` å’Œ `imgContent` è‡³å°‘æœ‰ä¸€ä¸ªä¸ä¸ºç©ºï¼‰

![image-20250221144924822](assets/image-20250221144924822.png)

åœ¨ `Controller` å±‚ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç§æœ‰æ–¹æ³• `preCheck()` æ¥æ‰§è¡Œä¸Šè¿°æ£€æŸ¥ï¼Œä»¥ä¾¿åœ¨ **1çº§è¯„è®º** å’Œ **2çº§è¯„è®º** æ¥å£ä¸­å¤ç”¨ï¼š

```java
// é¢„æ£€
    private void preCheck(String content, String imgContent) {
        boolean isOpenComment = SysCacheUtil.getSysSettingContainer().getSysSetting4Comment().isOpenComment();
        // åˆ¤æ–­è¯„è®ºæ˜¯å¦å¼€å¯
        if (!isOpenComment)
            throw new BusinessException(CommonMsg.UNOPENED_COMMENT);
        // è¯„è®ºå†…å®¹æˆ–å›¾ç‰‡è‡³å°‘è¦æœ‰ä¸€ä¸ª
        if (Objects.isNull(content) && Objects.isNull(imgContent))
            throw new BusinessException(ResponseCodeEnum.CODE_600);
    }
```

åœ¨ `Controller` å±‚ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ„å»º `Comment` å¯¹è±¡ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼ŒåŒæ—¶é˜²æ­¢ **XSS æ”»å‡»**ï¼š

```java
// æ„å»ºcomment
    private Comment createComment(UserInfoSessionDto userinfo, String articleId, Integer pCommentId, String content,
                                  String receiverId, String imgContent) {
        Comment comment = new Comment();
        comment.setpCommentId(pCommentId);
        comment.setArticleId(articleId);
        comment.setImgPath(imgContent);
        comment.setContent(StringEscapeUtils.escapeHtml4(content)); // è½¬ä¹‰htmlï¼Œé˜²æ­¢xssæ”»å‡»
        comment.setSenderAvatar(userinfo.getAvatar());
        comment.setSenderId(userinfo.getUserId());
        comment.setSenderNickname(userinfo.getNickName());
        comment.setSenderIpAddress(userinfo.getProvince());
        comment.setReceiverId(receiverId);
        // è¯„è®ºé»˜è®¤æœªå®¡æ ¸ï¼Œå› æ­¤åªå½“è®¾ç½®ä¸éœ€è¦å®¡æ ¸è¯„è®ºæ—¶ï¼Œå°†çŠ¶æ€è®¾ä¸ºå·²å®¡æ ¸
        Integer status = isAuditComment() ? TargetStatusEnum.PENDING.getStatus() : TargetStatusEnum.AUDITED.getStatus();
        comment.setStatus(status);
        comment.setLikeCount(Constant.NUM_0);
        comment.setTopType(Constant.NUM_0);
        comment.setPostTime(new Date());
        return comment;
    }
```

æ­¤å¤„çš„ **`escapeHtml4()`** å¤„ç† HTML è½¬ä¹‰ï¼Œé˜²æ­¢ XSS æ”»å‡»ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·æäº¤ `<script>alert("ä½ å¥½")</script>` æ—¶ï¼Œç³»ç»Ÿä¼šå°† `<`ã€`>` ç­‰æ ‡ç­¾è½¬ä¹‰ï¼Œé¿å…æ¶æ„è„šæœ¬æ‰§è¡Œã€‚

åœ¨ `Controller` å±‚å®ç° **ä¸€çº§è¯„è®ºæäº¤æ¥å£**ï¼š

```java
/**
     * å‘é€1çº§è¯„è®ºæ¥å£
     *
     * @param session
     * @param articleId
     * @param content
     * @param imgContent
     * @return
     */
    @PostMapping("/post/l1")
    @AccessControl(loginRequired = true)
    public Result<CommentVo> postL1CommentHandle(HttpSession session,
                                                 @Validation(max = 15) String articleId,
                                                 @Validation(required = false, max = 200) String content,
                                                 @Validation(required = false, max = 150) String imgContent) {
        preCheck(content, imgContent);
        UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        Comment comment = createComment(userinfo, articleId, Constant.NUM_0, null, content, imgContent);
        CommentVo commentVo = commentService.processPostL1Comment(comment, isAuditComment());
        return Result.success(commentVo);
    }
```

**å…³é”®ç‚¹è§£æ**ï¼š

- **`pCommentId` è®¾ä¸º 0**ï¼Œè¡¨ç¤ºè¯¥è¯„è®ºä¸º **ä¸€çº§è¯„è®º**
- **`receiverId` è®¾ä¸º `null`**ï¼Œè¡¨ç¤ºé»˜è®¤å›å¤å¯¹è±¡ä¸º **æ–‡ç« ä½œè€…**
- **è¯„è®ºæ˜¯å¦å®¡æ ¸** ç”± `isAuditComment()` æ–¹æ³•åŠ¨æ€å†³å®š

```java
// æ˜¯å¦å®¡æ ¸è¯„è®º
    private boolean isAuditComment() {
        return SysCacheUtil.getSysSettingContainer().getSysSetting4Audit().isCommentAudit();
    }
```

åœ¨ `Service` å±‚ï¼Œå®ç° `processPostL1Comment` æ–¹æ³•ï¼Œå¤„ç†è¯„è®ºå­˜å‚¨ä¸å®¡æ ¸ï¼š

```java
/**
     * å¤„ç†1çº§è¯„è®ºå‘å¸ƒ
     *
     * @param comment
     * @param needAudit
     * @return
     */
    CommentVo processPostL1Comment(Comment comment, boolean needAudit);
```

ç¬¬äºŒä¸ªå‚æ•°ã€needAuditã€‘è¡¨ç¤ºæ˜¯å¦å®¡æ ¸è¯„è®ºï¼Œéœ€è¦é€šè¿‡æ­¤å‚æ•°æ¥å†³å®šæ˜¯å¦è¿›è¡Œå®¡æ ¸åçš„å¤„ç†ã€‚

å¯¹äº1çº§è¯„è®ºè€Œè¨€ï¼Œåªéœ€è¦åˆ¤æ–­æ–‡ç« æ˜¯å¦å­˜åœ¨å³å¯ã€‚

```java
@Override
    @Transactional(rollbackFor = Exception.class)
    public CommentVo processPostL1Comment(Comment comment, boolean needAudit) {
        Article article = articleMapper.selectById(comment.getArticleId());
        // åˆ¤æ–­æ–‡ç«  æ˜¯å¦å­˜åœ¨ | æ˜¯å¦å·²å®¡æ ¸
        if (Objects.isNull(article))
            throw new BusinessException(CommonMsg.ARTICLE_NOT_EXISTS);
        // è®°å½•è¯„è®º
        add(comment);
        CommentVo commentVo = new CommentVo();
        BeanUtils.copyProperties(comment, commentVo);
        // è‹¥è®¾ç½®è¯„è®ºä¸éœ€è¦å®¡æ ¸ï¼Œç›´æ¥è®©è¯„è®ºé€šè¿‡å®¡æ ¸
        if (!needAudit)
            processPassCommentReview(true, comment.getSenderAvatar(), comment.getSenderId(),
                    comment.getSenderNickname(), article, comment, article.getUserId());
        return commentVo;
    }

/**
     * å¤„ç†è¯„è®ºå®¡æ ¸é€šè¿‡çš„é€»è¾‘
     *
     * @param isLevel1
     * @param senderAvatar
     * @param senderId
     * @param senderNickName
     * @param article
     * @param comment
     * @param msgReceiver
     */
    private void processPassCommentReview(boolean isLevel1, String senderAvatar, String senderId, String senderNickName,
                                          Article article, Comment comment, String msgReceiver) {
        // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
        Integer points = SysCacheUtil.getSysSettingContainer().getSysSetting4Comment().getCommentPoints();
        userPointsRecodeService.processUserPoints(senderId, OperationTypeEnum.POST_COMMENT.getType(), points);
        // æ›´æ–°æ–‡ç« è¯„è®ºæ•°é‡
        articleMapper.updateCommentCount(comment.getArticleId(), Constant.NUM_1);
        // æ¥æ”¶äººä¸ºå½“å‰ç”¨æˆ·ï¼Œä¸å‘æ¶ˆæ¯
        if (!Objects.equals(msgReceiver, senderId)) {
            UserMessage userMessage = new UserMessage();
            userMessage.setReceivedUserId(msgReceiver);
            userMessage.setArticleId(article.getArticleId());
            userMessage.setArticleTitle(article.getTitle());
            userMessage.setCommentId(comment.getCommentId());
            userMessage.setSenderAvatar(senderAvatar);
            userMessage.setSendUserId(senderId);
            userMessage.setSendNickName(senderNickName);
            userMessage.setMessageType(MessageTypeEnum.COMMENT.getType());
            String msgContent = isLevel1 ? Constant.ARTICLE_COMMENT_MESSAGE_CONTENT : Constant.BACK_COMMENT_MESSAGE_CONTENT;
            userMessage.setMessageContent(msgContent);
            userMessage.setStatus(MessageStatusEnum.NO_READ.getStatus());
            Date date = new Date();
            userMessage.setCreateTime(date);
            userMessage.setUpdateTime(date);
            userMessageMapper.insert(userMessage);
        }
    }
```

ä¸ºä»€ä¹ˆå•ç‹¬å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ã€processPassCommentReview()ã€‘ï¼Ÿ

åŸå› æ˜¯ï¼Œé™¤äº†åœ¨1ã€2çº§è¯„è®ºä¸­å¤ç”¨å¤–ï¼Œè¿˜å¯ä»¥åœ¨ç®¡ç†ç«¯å¤ç”¨ï¼Œç®¡ç†å‘˜å»å®¡æ ¸çš„æ—¶å€™è°ƒç”¨å®¡æ ¸æ¥å£ï¼Œæ¥å£å†æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚

---



# 3 ğŸŒå‘é€2çº§è¯„è®ºæ¥å£

æ¥å£åœ°å€ï¼š

```swift
Post /web/comments/post/l2
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å     | ç±»å‹     | å¿…å¡«é¡¹  | è¯´æ˜             |
| ---------- | -------- | ------- | ---------------- |
| articleId  | `string` | `true`  | æ–‡ç« id           |
| pCommentId | `string` | `true`  | çˆ¶è¯„è®ºid         |
| receiverId | `string` | `false` | æ¥æ”¶äºº(å›å¤äºº)id |
| content    | `string` | `false` | è¯„è®ºå†…å®¹         |
| imgContent | `string` | `false` | å›¾ç‰‡å†…å®¹         |

è¿”å›ç¤ºä¾‹ï¼š

```java
{
    "status": "success",
    "code": 200,
    "msg": "è¯·æ±‚æˆåŠŸ",
    "data": {
        "commentId": 86,
        "pCommentId": 83,
        "articleId": "ababa",
        "imgPath": null,
        "content": "é…è‰²éƒ½æ˜¯å…¶æ¬¡ï¼Œå…³é”®æ˜¯è¦æ€§èƒ½",
        "senderAvatar": null,
        "senderId": "9876175182",
        "senderNickname": "user_189",
        "senderIpAddress": "å››å·çœ",
        "receiverId": "9619980088",
        "receiverNickname": "ling",
        "likeCount": 0,
        "topType": 0,
        "status": 2,
        "postTime": "2025-02-20 06:17:40",
        "doLike": false,
        "subComment": null
    }
}
```

---

## 3.1 å‘é€2çº§è¯„è®ºæ¥å£å®ç°

åœ¨ `Controller` å±‚å®ç° **2çº§è¯„è®ºæäº¤æ¥å£**ï¼Œè¯¥æ¥å£ç”¨äºç”¨æˆ·åœ¨å·²æœ‰çš„ä¸€çº§è¯„è®ºä¸‹å‘è¡¨å›å¤ï¼š

```java
/**
     * å‘é€2çº§è¯„è®ºæ¥å£
     *
     * @param session
     * @param articleId
     * @param pCommentId
     * @param content
     * @param receiverId
     * @param imgContent
     * @return
     */
    @PostMapping("/post/l2")
    @AccessControl(loginRequired = true)
    public Result<CommentVo> postL2CommentHandle(HttpSession session,
                                                 @Validation(max = 15) String articleId,
                                                 @Validation(min = 1) Integer pCommentId,
                                                 @Validation(required = false, max = 200) String content,
                                                 String receiverId,
                                                 @Validation(required = false, max = 150) String imgContent) {
        preCheck(content, imgContent);
        UserInfoSessionDto userinfo = (UserInfoSessionDto) session.getAttribute(Constant.USERINFO_SESSION_KEY);
        Comment comment = createComment(userinfo, articleId, pCommentId, receiverId, content, imgContent);
        CommentVo commentVo = commentService.processPostL2Comment(comment, isAuditComment());
        return Result.success(commentVo);
    }

	// æ˜¯å¦å®¡æ ¸è¯„è®º
    private boolean isAuditComment() {
        return SysCacheUtil.getSysSettingContainer().getSysSetting4Audit().isCommentAudit();
    }

    // é¢„æ£€
    private void preCheck(String content, String imgContent) {
        boolean isOpenComment = SysCacheUtil.getSysSettingContainer().getSysSetting4Comment().isOpenComment();
        // åˆ¤æ–­è¯„è®ºæ˜¯å¦å¼€å¯
        if (!isOpenComment)
            throw new BusinessException(CommonMsg.UNOPENED_COMMENT);
        // è¯„è®ºå†…å®¹æˆ–å›¾ç‰‡è‡³å°‘è¦æœ‰ä¸€ä¸ª
        if (Objects.isNull(content) && Objects.isNull(imgContent))
            throw new BusinessException(ResponseCodeEnum.CODE_600);
    }

    // æ„å»ºcomment
    private Comment createComment(UserInfoSessionDto userinfo, String articleId, Integer pCommentId, String receiverId,
                                  String content, String imgContent) {
        Comment comment = new Comment();
        comment.setpCommentId(pCommentId);
        comment.setArticleId(articleId);
        comment.setImgPath(imgContent);
        comment.setContent(StringEscapeUtils.escapeHtml4(content)); // è½¬ä¹‰htmlï¼Œé˜²æ­¢xssæ”»å‡»
        comment.setSenderAvatar(userinfo.getAvatar());
        comment.setSenderId(userinfo.getUserId());
        comment.setSenderNickname(userinfo.getNickName());
        comment.setSenderIpAddress(userinfo.getProvince());
        comment.setReceiverId(receiverId);
        // è¯„è®ºé»˜è®¤æœªå®¡æ ¸ï¼Œå› æ­¤åªå½“è®¾ç½®ä¸éœ€è¦å®¡æ ¸è¯„è®ºæ—¶ï¼Œå°†çŠ¶æ€è®¾ä¸ºå·²å®¡æ ¸
        Integer status = isAuditComment() ? TargetStatusEnum.PENDING.getStatus() : TargetStatusEnum.AUDITED.getStatus();
        comment.setStatus(status);
        comment.setLikeCount(Constant.NUM_0);
        comment.setTopType(Constant.NUM_0);
        comment.setPostTime(new Date());
        return comment;
    }
```

åœ¨ `Service` å±‚ï¼Œå®ç° `processPostL2Comment()` ï¼Œå¤„ç†è¯„è®ºå­˜å‚¨ä¸å®¡æ ¸ï¼š

```java
/**
     * å¤„ç†2çº§è¯„è®ºå‘å¸ƒ
     *
     * @param comment
     * @param needAudit
     * @return
     */
    CommentVo processPostL2Comment(Comment comment, boolean needAudit);
```

```java
@Override
    @Transactional(rollbackFor = Exception.class)
    public CommentVo processPostL2Comment(Comment comment, boolean needAudit) {
        Article article = articleMapper.selectById(comment.getArticleId());
        // åˆ¤æ–­æ–‡ç«  æ˜¯å¦å­˜åœ¨ | æ˜¯å¦å·²å®¡æ ¸
        if (Objects.isNull(article))
            throw new BusinessException(CommonMsg.ARTICLE_NOT_EXISTS);
        boolean noReceiver = Objects.isNull(comment.getReceiverId());   // æ˜¯å¦æ²¡æœ‰æ¥æ”¶äºº
        CommentQueryDto commentQueryDto = new CommentQueryDto();
        commentQueryDto.setArticleId(comment.getArticleId());
        if (noReceiver) {
            commentQueryDto.setCommentId(comment.getpCommentId());
        } else {
            commentQueryDto.setpCommentId(comment.getpCommentId());
            commentQueryDto.setSenderId(comment.getReceiverId());
        }
        List<Comment> comments = commentMapper.selectByCondition(commentQueryDto);
        // åˆ¤æ–­å›å¤çš„è¯„è®ºæ˜¯å¦å­˜åœ¨
        if (Objects.isNull(comments) || comments.isEmpty()) {
            throw new BusinessException(CommonMsg.REPLY_COMMENT_NOT_EXISTS);
        }
        // æ— æ¥æ”¶äººè¡¨ç¤ºå¯¹1çº§è¯„è®ºå›å¤ï¼Œä½†å¯èƒ½æŸ¥å‡º2çº§è¯„è®ºï¼Œæ•…åˆ¤æ–­
        if (noReceiver && !Objects.equals(comments.get(0).getpCommentId(), Constant.NUM_0)) {
            throw new BusinessException(CommonMsg.REPLY_COMMENT_NOT_EXISTS);
        }
        String msgReceiver = comments.get(0).getSenderId();
        if (!noReceiver) comment.setReceiverNickname(comments.get(0).getSenderNickname());
        // è®°å½•è¯„è®º
        add(comment);
        CommentVo commentVo = new CommentVo();
        BeanUtils.copyProperties(comment, commentVo);
        // è‹¥è®¾ç½®è¯„è®ºä¸éœ€è¦å®¡æ ¸ï¼Œç›´æ¥è®©è¯„è®ºé€šè¿‡å®¡æ ¸
        if (!needAudit)
            processPassCommentReview(false, comment.getSenderAvatar(), comment.getSenderId(),
                    comment.getSenderNickname(), article, comment, msgReceiver);
        return commentVo;
    }
```

åœ¨äºŒçº§è¯„è®ºçš„æäº¤é€»è¾‘ä¸­ï¼Œé™¤äº†åŸºæœ¬çš„è¯„è®ºå­˜å‚¨ï¼Œè¿˜éœ€è¦è¿›è¡Œä¸€ç³»åˆ—åˆæ³•æ€§æ ¡éªŒï¼Œé˜²æ­¢ç”¨æˆ·ç»•è¿‡å‰ç«¯é™åˆ¶ï¼Œæ‰‹åŠ¨è°ƒç”¨ API é€ æˆæ•°æ®æ±¡æŸ“ã€‚ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š

é™¤äº†åˆ¤æ–­æ–‡ç« æ˜¯å¦å­˜åœ¨å¤–ï¼Œè¿˜è¦åˆ¤æ–­è¢«å›å¤çš„è¯„è®ºæ˜¯å¦å­˜åœ¨ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š

- å›å¤1çº§è¯„è®ºï¼Œéœ€è¦æ£€æŸ¥è¯¥ä¸€çº§è¯„è®ºæ˜¯å¦çœŸå®å­˜åœ¨
- å›å¤2çº§è¯„è®ºï¼Œéœ€è¦æ£€æŸ¥è¯¥äºŒçº§è¯„è®ºæ˜¯å¦çœŸå®å­˜åœ¨ï¼Œä¸”å±äºç›®æ ‡ä¸€çº§è¯„è®ºçš„å­è¯„è®º

æ ¹æ®ã€receiverId == nullã€‘æ¥åˆ¤æ–­å›å¤çš„æ˜¯1çº§è¿˜æ˜¯2çº§ï¼Œå¹¶åŠ¨æ€æ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼ŒæŸ¥è¯¢è¯„è®ºè¡¨ä»¥ç¡®è®¤è¢«å›å¤çš„è¯„è®ºæ˜¯å¦å­˜åœ¨ã€‚

æ ¹æ®æŸ¥è¯¢ç»“æœï¼Œè¿›è¡Œä»¥ä¸‹åˆ¤æ–­ï¼š

```java
// åˆ¤æ–­å›å¤çš„è¯„è®ºæ˜¯å¦å­˜åœ¨
if (Objects.isNull(comments) || comments.isEmpty()) {
    throw new BusinessException(CommonMsg.REPLY_COMMENT_NOT_EXISTS);
}
```

è‹¥å›å¤1çº§è¯„è®ºï¼Œåˆ™éœ€è¦åˆ¤æ–­è¯¥ä¸€çº§è¯„è®ºæ˜¯å¦å­˜åœ¨ï¼Œå› æ­¤éœ€æ„å»ºå¦‚ä¸‹æŸ¥è¯¢æ¡ä»¶ï¼š

```java
CommentQueryDto commentQueryDto = new CommentQueryDto();
commentQueryDto.setArticleId(comment.getArticleId());
commentQueryDto.setCommentId(comment.getpCommentId());	// æ‰¾è¯„è®ºidä¸ºpid
```

å‚æ•° **`pCommentId`** å³è¯¥ä¸€çº§è¯„è®ºçš„ idï¼Œå› ä¸ºå½“ä½ å›å¤ä¸€çº§è¯„è®ºæ—¶ï¼Œè¯¥è¯„è®ºå°±æ˜¯ä½ çš„çˆ¶çº§ã€‚å› æ­¤ï¼ŒæŸ¥è¯¢æ—¶éœ€è¦é€šè¿‡ **æ–‡ç«  ID** å’Œ **è¯„è®º ID** æ¥ç¡®ä¿è¯¥è¯„è®ºå±äºå½“å‰æ–‡ç« ã€‚

è‹¥å›å¤2çº§è¯„è®ºï¼Œåˆ™éœ€è¦åˆ¤æ–­è¯¥2çº§è¯„è®ºæ˜¯å¦ï¼Œå› æ­¤éœ€æ„å»ºå¦‚ä¸‹æŸ¥è¯¢æ¡ä»¶ï¼š

```java
CommentQueryDto commentQueryDto = new CommentQueryDto();
commentQueryDto.setArticleId(comment.getArticleId());
commentQueryDto.setpCommentId(comment.getpCommentId());  // æ‰¾pidä¸ºpCommentIdçš„
commentQueryDto.setSenderId(comment.getReceiverId());    // æ ¹æ®æ¥æ”¶äººæ¥æŸ¥æ‰¾
```

ä¹Ÿå°±æ˜¯è¦æŸ¥æ‰¾æŸä¸ªæ–‡ç« ï¼ˆ`articleId`ï¼‰ä¸‹çš„æŸæ¡ä¸€çº§è¯„è®ºï¼ˆ`pCommentId`ï¼‰ä¸‹æ˜¯å¦å­˜åœ¨è¯¥äºŒçº§è¯„è®ºã€‚å…·ä½“åˆ¤æ–­ä¾æ®æ˜¯é€šè¿‡è¿™æ¡è¯„è®ºçš„ **å‘é€äººï¼ˆ`senderId`ï¼‰** å’Œ **æ¥æ”¶äººï¼ˆ`receiverId`ï¼‰** æ¥è¿›è¡ŒåŒ¹é…ã€‚

åœ¨ç»è¿‡å­˜åœ¨æ€§åˆ¤æ–­åï¼Œæˆ‘åˆåšäº†å¦‚ä¸‹é¢å¤–çš„åˆ¤æ–­ï¼š

```java
// æ— æ¥æ”¶äººè¡¨ç¤ºå¯¹1çº§è¯„è®ºå›å¤ï¼Œä½†å¯èƒ½æŸ¥å‡º2çº§è¯„è®ºï¼Œæ•…åˆ¤æ–­
if (noReceiver && !Objects.equals(comments.get(0).getpCommentId(), Constant.NUM_0)) {
    throw new BusinessException(CommonMsg.REPLY_COMMENT_NOT_EXISTS);
}
```

è¿™ä¸ªåˆ¤æ–­çš„æ ¸å¿ƒæ˜¯åœ¨æ²¡æœ‰æ¥æ”¶äººçš„æƒ…å†µä¸‹ï¼Œåˆ¤æ–­æŸ¥è¯¢ç»“æœæ˜¯å¦å±äºä¸€çº§è¯„è®ºã€‚ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åˆ¤æ–­ï¼Ÿ

å› ä¸ºæœ‰å¯èƒ½æŸ¥è¯¢å‡º2çº§è¯„è®ºï¼Œåœ¨ç»•è¿‡å‰ç«¯ç›´æ¥è®¿é—®æ¥å£çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å¯¹æ–‡ç« aä¸‹çš„1çº§è¯„è®ºbè¿›è¡Œå›å¤ï¼Œè€Œaä¸‹è¿˜æœ‰ä¸€æ¡2çº§è¯„è®ºcï¼Œæ­¤æ—¶é€šè¿‡æ–‡ç« idå’Œçˆ¶idæŸ¥è¯¢ï¼Œè‹¥çˆ¶idæ°å¥½æ˜¯cçš„idï¼Œé‚£ä¹ˆå°±ä¼šæŠŠcæŸ¥è¯¢å‡ºæ¥ï¼Œç»“æœé›†ä¸ä¸ºç©ºè¿›è€Œæ’å…¥è¿™æ¡å›å¤ã€‚ä½†æ˜¯cæ˜¯2çº§è¯„è®ºï¼Œå›å¤çš„å¯¹è±¡éƒ½æ”¹å˜äº†ï¼Œæˆ‘ä»¬çš„æ¶ˆæ¯æ¥æ”¶äººä¹Ÿå˜ä¸ºcçš„å‘é€äººï¼Œè€Œä¸æ˜¯açš„äº†ï¼š

å› ä¸ºåœ¨ç»•è¿‡å‰ç«¯ç›´æ¥è®¿é—®æ¥å£æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢å¯èƒ½ä¼šè¿”å›äºŒçº§è¯„è®ºï¼Œè€Œä¸æ˜¯æˆ‘ä»¬é¢„æœŸçš„ä¸€çº§è¯„è®ºã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ–‡ç«  `a` ä¸‹å¯¹ä¸€çº§è¯„è®º `b` è¿›è¡Œå›å¤ï¼Œè€Œæ–‡ç«  `a` ä¸‹è¿˜å­˜åœ¨ä¸€æ¡äºŒçº§è¯„è®º `c`ï¼Œå½“æˆ‘ä»¬é€šè¿‡æ–‡ç« IDå’Œçˆ¶è¯„è®ºIDæ¥æŸ¥è¯¢æ—¶ï¼Œå‡å¦‚çˆ¶è¯„è®ºIDæ°å¥½æ˜¯äºŒçº§è¯„è®º `c` çš„ IDï¼Œå°±å¯èƒ½é”™è¯¯åœ°æŸ¥è¯¢åˆ°äºŒçº§è¯„è®º `c`ã€‚æŸ¥è¯¢ç»“æœä¸ä¸ºç©ºæ—¶ï¼Œç³»ç»Ÿå°±ä¼šè¯¯ä»¥ä¸ºè¯¥äºŒçº§è¯„è®ºæ˜¯å›å¤çš„ç›®æ ‡ï¼Œè¿›è€Œé”™è¯¯åœ°æ’å…¥å›å¤ã€‚

ä»é”™è¯¯çš„å›å¤ç›®æ ‡ä¸­æ‹¿åˆ°çš„å€¼è‡ªç„¶ä¹Ÿæ˜¯é”™è¯¯çš„

```java
String msgReceiver = comments.get(0).getSenderId();	// æ¯”å¦‚æ‹¿åˆ°é”™è¯¯çš„å›å¤äºº
```

æ­¤æ—¶ï¼Œ`msgReceiver` ä¼šæ˜¯ `c` çš„å‘é€äººï¼Œè€Œä¸æ˜¯åŸæœ¬ä¸€çº§è¯„è®º `a` çš„æ¥æ”¶äººã€‚è¿™æ ·å°±å¯¼è‡´äº†å›å¤å¯¹è±¡å‘ç”Ÿäº†å˜åŒ–ï¼Œæ¶ˆæ¯æ¥æ”¶äººä¹Ÿé”™è¯¯åœ°æŒ‡å‘äº†äºŒçº§è¯„è®ºçš„å‘é€äººã€‚

å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªåˆ¤æ–­ï¼Œç¡®ä¿åªæœ‰åœ¨æ²¡æœ‰æ¥æ”¶äººçš„æƒ…å†µä¸‹ï¼Œä¸”æŸ¥è¯¢åˆ°çš„è¯„è®ºç¡®å®æ˜¯ä¸€çº§è¯„è®ºæ—¶ï¼Œæ‰ç»§ç»­è¿›è¡Œå›å¤ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢åœ¨ç»•è¿‡å‰ç«¯ç›´æ¥è®¿é—®æ¥å£çš„æƒ…å†µä¸‹ï¼Œå› æŸ¥è¯¢åˆ°äºŒçº§è¯„è®ºè€Œå¯¼è‡´å›å¤å¯¹è±¡å’Œæ¥æ”¶äººé”™è¯¯ã€‚

æ€»çš„æ¥è¯´ï¼ŒäºŒçº§è¯„è®ºçš„æ ¸å¿ƒæäº¤é€»è¾‘ä¸ä¸€çº§è¯„è®ºç›¸ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºå¦‚ä½•åˆ¤æ–­å›å¤çš„è¯„è®ºæ˜¯å¦å­˜åœ¨ï¼Œä¸”æ˜¯ä¸€çº§è¯„è®ºè¿˜æ˜¯äºŒçº§è¯„è®ºã€‚
